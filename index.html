<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#150E18">
    <meta name="description" content="Play fun games together with your partner">
    <title>Couples Game Hub - Play Together</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/hub.css">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="hub-page">
    <!-- Game Selection Screen -->
    <div class="screen active" id="gameSelectionScreen">
        <!-- Sticky Header -->
        <header class="hub-header" data-testid="app-header">
            <div class="hub-header-inner">
                <a href="#" class="hub-brand">
                    <span class="hub-brand-icon">ğŸ’•</span>
                    <span data-testid="page-title">Couples Game Hub</span>
                </a>
                <div class="hub-header-actions">
                    <div class="auth-buttons" id="authButtons">
                        <button class="hub-btn hub-btn-ghost" onclick="openLoginModal()">Sign In</button>
                        <button class="hub-btn hub-btn-primary" data-testid="primary-cta" onclick="openSignupModal()">Play Now</button>
                    </div>
                    <div class="user-section" id="userSection" style="display: none;">
                        <span class="hub-chip" title="Current Streak"><span id="headerStreak">0</span>ğŸ”¥</span>
                        <button class="hub-btn hub-btn-ghost" onclick="showProfileScreen()" title="View Profile">
                            <span id="headerInitials">P</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hub-hero">
            <h1 class="hub-hero-title">Play Together, Stay Close</h1>
            <p class="hub-hero-tagline">Fun games designed for couples. No downloads, no accounts required.</p>
            <div class="hub-hero-ctas">
                <button class="hub-btn hub-btn-primary hub-btn-lg" onclick="document.getElementById('hubGames').scrollIntoView({behavior:'smooth'})">
                    ğŸ® Play Local
                </button>
                <button class="hub-btn hub-btn-mint hub-btn-lg" onclick="openMatchmaking()">
                    ğŸŒ Play Online
                </button>
                <button class="hub-btn hub-btn-secondary hub-btn-lg" id="heroInstallBtn" style="display: none;">
                    ğŸ“² Install App
                </button>
            </div>
            <div class="hub-hero-chips">
                <span class="hub-chip"><span class="hub-chip-icon">âš¡</span> Fast rounds</span>
                <span class="hub-chip"><span class="hub-chip-icon">ğŸ’¾</span> Save progress</span>
                <span class="hub-chip"><span class="hub-chip-icon">ğŸ“´</span> Offline friendly</span>
            </div>
        </section>

        <!-- Continue Panel (only shown if lastPlayedGame exists) -->
        <section class="hub-continue" id="continueSection" style="display: none;">
            <div class="hub-continue-card">
                <div class="hub-continue-header">
                    <div>
                        <h3 class="hub-continue-title">ğŸ® Continue Where You Left Off</h3>
                        <span class="hub-continue-game" id="lastGameName"></span>
                    </div>
                    <button class="hub-continue-dismiss" onclick="dismissContinue()" title="Dismiss">âœ•</button>
                </div>
                <div class="hub-continue-actions">
                    <button class="hub-btn hub-btn-primary" onclick="continueLast()">Continue</button>
                    <button class="hub-btn hub-btn-secondary" onclick="playRandomGame()">Surprise Me</button>
                </div>
            </div>
        </section>

        <!-- Search & Filter -->
        <section class="hub-filters">
            <div class="hub-search-wrap">
                <span class="hub-search-icon">ğŸ”</span>
                <input type="text" class="hub-search" id="hubSearch" placeholder="Search games..." autocomplete="off">
            </div>
            <div class="hub-filter-chips" id="filterChips">
                <button class="hub-filter-chip active" data-filter="all">All</button>
                <button class="hub-filter-chip" data-filter="quick">âš¡ Quick</button>
                <button class="hub-filter-chip" data-filter="cozy">ğŸ’ Cozy</button>
                <button class="hub-filter-chip" data-filter="word">ğŸ“ Word</button>
                <button class="hub-filter-chip" data-filter="creative">ğŸ¨ Creative</button>
                <button class="hub-filter-chip" data-filter="card">ğŸƒ Card</button>
            </div>
        </section>

        <!-- Game Grid -->
        <section class="hub-games" id="hubGames">
            <div class="hub-grid" data-testid="game-grid">
                <article class="hub-card" tabindex="0" onclick="playGame('word-rush', 'local')" data-tags="quick,word" data-title="Word Rush" data-desc="Fast-paced word categories competition">
                    <div class="hub-card-icon">ğŸ§©</div>
                    <h2 class="hub-card-title">Word Rush</h2>
                    <p class="hub-card-desc">Fast-paced word categories competition</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">âš¡ Quick</span>
                        <span class="hub-card-tag">ğŸ“ Word</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('memory-match', 'local')" data-tags="cozy" data-title="Memory Match" data-desc="Find pairs in this classic memory game">
                    <div class="hub-card-icon">ğŸ’</div>
                    <h2 class="hub-card-title">Memory Match</h2>
                    <p class="hub-card-desc">Find pairs in this classic memory game</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ’ Cozy</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('trivia-duel', 'local')" data-tags="quick" data-title="Trivia Duel" data-desc="Test your knowledge across categories">
                    <div class="hub-card-icon">ğŸ¯</div>
                    <h2 class="hub-card-title">Trivia Duel</h2>
                    <p class="hub-card-desc">Test your knowledge across categories</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">âš¡ Quick</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('quick-draw', 'local')" data-tags="creative,quick" data-title="Quick Draw" data-desc="Draw and guess with speed and creativity">
                    <div class="hub-card-icon">ğŸ¨</div>
                    <h2 class="hub-card-title">Quick Draw</h2>
                    <p class="hub-card-desc">Draw and guess with speed &amp; creativity</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ¨ Creative</span>
                        <span class="hub-card-tag">âš¡ Quick</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('math-dash', 'local')" data-tags="quick" data-title="Math Dash" data-desc="Race to solve math problems">
                    <div class="hub-card-icon">ğŸ²</div>
                    <h2 class="hub-card-title">Math Dash</h2>
                    <p class="hub-card-desc">Race to solve math problems</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">âš¡ Quick</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('memory-lane', 'local')" data-tags="cozy" data-title="Memory Lane" data-desc="Relive memories with your photos">
                    <div class="hub-card-icon">ğŸ“·</div>
                    <h2 class="hub-card-title">Memory Lane</h2>
                    <p class="hub-card-desc">Relive memories with your photos</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ’ Cozy</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('date-designer', 'local')" data-tags="creative,cozy" data-title="Date Designer" data-desc="Build your perfect date with cards">
                    <div class="hub-card-icon">ğŸ’•</div>
                    <h2 class="hub-card-title">Date Designer</h2>
                    <p class="hub-card-desc">Build your perfect date with cards</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ¨ Creative</span>
                        <span class="hub-card-tag">ğŸ’ Cozy</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('inside-our-space', 'local')" data-tags="cozy" data-title="Inside Our Space" data-desc="Virtual scavenger hunt through your home">
                    <div class="hub-card-icon">ğŸ </div>
                    <h2 class="hub-card-title">Inside Our Space</h2>
                    <p class="hub-card-desc">Virtual scavenger hunt through your home</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ’ Cozy</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('crossword-clash', 'local')" data-tags="word" data-title="Crossword Clash" data-desc="Race to complete the crossword puzzle">
                    <div class="hub-card-icon">ğŸ“</div>
                    <h2 class="hub-card-title">Crossword Clash</h2>
                    <p class="hub-card-desc">Race to complete the crossword puzzle</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸ“ Word</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>

                <article class="hub-card" tabindex="0" onclick="playGame('cinco', 'local')" data-tags="card" data-title="Cinco" data-desc="Strategic card game - match colors and numbers">
                    <div class="hub-card-icon">ğŸ´</div>
                    <h2 class="hub-card-title">Cinco</h2>
                    <p class="hub-card-desc">Strategic card game - match colors and numbers</p>
                    <div class="hub-card-tags">
                        <span class="hub-card-tag">ğŸƒ Card</span>
                    </div>
                    <div class="hub-card-play">â–¶ Play</div>
                </article>
            </div>
        </section>

        <!-- Footer -->
        <footer class="hub-footer">
            <p>Made with ğŸ’• for couples who love to play together</p>
        </footer>
    </div>

    <!-- Profile Screen -->
    <div class="screen profile-screen" id="profileScreen">
        <div class="profile-container" style="max-width: 600px; margin: 0 auto; padding: 24px;">
            <a href="#" class="back-link" onclick="showGameSelection(); return false;">
                â† Back to Games
            </a>

            <div class="profile-header" style="text-align: center; margin: 16px 0;">
                <div class="avatar avatar-xl" id="profileAvatar" style="margin: 0 auto 10px;">
                    <span id="profileInitials">P</span>
                </div>
                <h1 class="profile-name" id="profileName" style="margin: 0 0 4px;">Guest Player</h1>
                <p class="profile-email" id="profileEmail" style="margin: 0 0 2px;">Playing as guest</p>
                <p class="profile-member-since" id="profileMemberSince">Guest Mode</p>
            </div>

            <div class="profile-stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ®</div>
                    <div class="stat-value" id="profileTotalGames">0</div>
                    <div class="stat-label">Games Played</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ†</div>
                    <div class="stat-value" id="profileTotalWins">0</div>
                    <div class="stat-label">Total Wins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”¥</div>
                    <div class="stat-value" id="profileCurrentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â­</div>
                    <div class="stat-value" id="profileLongestStreak">0</div>
                    <div class="stat-label">Longest Streak</div>
                </div>
            </div>

            <div class="profile-upgrade-banner" id="upgradePrompt" style="display: none; padding: 24px; border-radius: 16px; text-align: center;">
                <h3 style="margin: 0 0 8px;">ğŸ¯ Create a Permanent Account</h3>
                <p style="margin: 0 0 16px;">Create an account to save your progress forever!</p>
                <button class="hub-btn hub-btn-primary" onclick="showUpgradeModal()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modals -->
    <div class="modal-overlay" id="loginModal" data-testid="modal">
        <div class="modal-container auth-modal">
            <button class="modal-close" onclick="closeAuthModals()" aria-label="Close">&times;</button>
            <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                <h2 style="margin: 0 0 8px;">Welcome Back!</h2>
                <p style="margin: 0;">Sign in to continue your gaming journey</p>
            </div>
            <div class="auth-modal-body" style="padding: 0 24px 24px;">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="loginPassword" class="form-control" required placeholder="Enter your password" autocomplete="current-password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword')">Show</button>
                        </div>
                    </div>
                    <button type="submit" class="hub-btn hub-btn-primary" style="width: 100%;">Sign In</button>
                </form>
            </div>
            <div class="auth-modal-footer" style="padding: 16px 24px 24px; text-align: center; border-top: 1px solid var(--hub-stroke);">
                <p style="margin: 0;">Don't have an account? <a href="#" onclick="switchToSignup(); return false;">Sign up</a></p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signupModal">
        <div class="modal-container auth-modal">
            <button class="modal-close" onclick="closeAuthModals()">&times;</button>
            <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                <h2 style="margin: 0 0 8px;">Create Account</h2>
                <p style="margin: 0;">Join thousands of couples playing together</p>
            </div>
            <div class="auth-modal-body" style="padding: 0 24px 24px;">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupName">Display Name</label>
                        <input type="text" id="signupName" class="form-control" required placeholder="Sarah & Jake" maxlength="30" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" class="form-control" required placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="signupPassword" class="form-control" required placeholder="At least 6 characters" minlength="6" autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupPassword')">Show</button>
                        </div>
                    </div>
                    <button type="submit" class="hub-btn hub-btn-primary" style="width: 100%;">Create Account</button>
                </form>
            </div>
            <div class="auth-modal-footer" style="padding: 16px 24px 24px; text-align: center; border-top: 1px solid var(--hub-stroke);">
                <p style="margin: 0;">Already have an account? <a href="#" onclick="switchToLogin(); return false;">Sign in</a></p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="upgradeModal">
        <div class="modal-container auth-modal">
            <button class="modal-close" onclick="closeAuthModals()">&times;</button>
            <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                <h2 style="margin: 0 0 8px;">Save Your Progress</h2>
                <p style="margin: 0;">Create a permanent account to keep your stats forever</p>
            </div>
            <div class="auth-modal-body" style="padding: 0 24px 24px;">
                <form id="upgradeForm">
                    <div class="form-group">
                        <label for="upgradeEmail">Email</label>
                        <input type="email" id="upgradeEmail" class="form-control" required placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="upgradePassword">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="upgradePassword" class="form-control" required placeholder="At least 6 characters" minlength="6" autocomplete="new-password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('upgradePassword')">Show</button>
                        </div>
                    </div>
                    <button type="submit" class="hub-btn hub-btn-primary" style="width: 100%;">Create Permanent Account</button>
                </form>
            </div>
            <div class="auth-modal-footer" style="padding: 16px 24px 24px; text-align: center;">
                <button class="hub-btn hub-btn-ghost" onclick="closeAuthModals()">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Matchmaking Modal -->
    <div class="modal-overlay" id="matchmakingModal">
        <div class="modal-container mm-modal">
            <button class="modal-close" onclick="closeMatchmaking()">&times;</button>

            <!-- Step 1: Create or Join -->
            <div class="mm-step" id="mmStepChoice">
                <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                    <h2 style="margin: 0 0 8px;">Play Online</h2>
                    <p style="margin: 0;">Play any game with your partner remotely</p>
                </div>
                <div style="padding: 0 24px 24px; display: flex; flex-direction: column; gap: 12px;">
                    <button class="mm-choice-btn" onclick="mmShowCreate()">
                        <span class="mm-choice-icon">ğŸ®</span>
                        <div>
                            <div class="mm-choice-label">Create Game</div>
                            <div class="mm-choice-desc">Pick a game & share the code</div>
                        </div>
                    </button>
                    <button class="mm-choice-btn" onclick="mmShowJoin()">
                        <span class="mm-choice-icon">ğŸ”—</span>
                        <div>
                            <div class="mm-choice-label">Join Game</div>
                            <div class="mm-choice-desc">Enter a code from your partner</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Step 2a: Pick a game -->
            <div class="mm-step" id="mmStepPickGame" style="display:none;">
                <div class="auth-modal-header" style="padding: 32px 24px 8px; text-align: center;">
                    <h2 style="margin: 0 0 8px;">Pick a Game</h2>
                    <p style="margin: 0;">Choose what to play together</p>
                </div>
                <div class="mm-game-grid" id="mmGameGrid" style="padding: 16px 24px 24px;"></div>
                <div style="padding: 0 24px 16px; text-align: center;">
                    <button class="hub-btn hub-btn-ghost" onclick="mmBack()">â† Back</button>
                </div>
            </div>

            <!-- Step 2b: Waiting for partner -->
            <div class="mm-step" id="mmStepWaiting" style="display:none;">
                <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                    <h2 style="margin: 0 0 8px;">Waiting for Partner</h2>
                    <p style="margin: 0;" id="mmWaitingGame"></p>
                </div>
                <div style="padding: 0 24px 24px; text-align: center;">
                    <div class="mm-code-display" id="mmCodeDisplay">------</div>
                    <button class="hub-btn hub-btn-primary" style="margin: 16px 0;" onclick="mmCopyCode()">Copy Code</button>
                    <div class="mm-waiting-info">
                        <div class="mm-spinner"></div>
                        <p style="margin: 8px 0 0; color: var(--hub-muted); font-size: 0.875rem;">Share this code with your partner</p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Join flow -->
            <div class="mm-step" id="mmStepJoin" style="display:none;">
                <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                    <h2 style="margin: 0 0 8px;">Join Game</h2>
                    <p style="margin: 0;">Enter the code your partner shared</p>
                </div>
                <div style="padding: 0 24px 24px;">
                    <input type="text" id="mmJoinCode" class="form-control mm-code-input" placeholder="Enter 6-letter code" maxlength="6" autocomplete="off" style="text-align: center; font-size: 1.5rem; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 16px;">
                    <button class="hub-btn hub-btn-primary" style="width: 100%;" id="mmJoinBtn" onclick="mmJoinGame()">Join</button>
                    <p class="mm-error" id="mmJoinError" style="display:none; color: #FF5252; text-align: center; margin: 12px 0 0; font-size: 0.875rem;"></p>
                </div>
                <div style="padding: 0 24px 16px; text-align: center;">
                    <button class="hub-btn hub-btn-ghost" onclick="mmBack()">â† Back</button>
                </div>
            </div>

            <!-- Connecting step -->
            <div class="mm-step" id="mmStepConnecting" style="display:none;">
                <div class="auth-modal-header" style="padding: 32px 24px 16px; text-align: center;">
                    <h2 style="margin: 0 0 8px;">Connecting...</h2>
                    <p style="margin: 0;">Setting up the game</p>
                </div>
                <div style="padding: 24px; text-align: center;">
                    <div class="mm-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer" data-testid="toast"></div>

    <!-- PWA Install Button -->
    <button class="pwa-install-btn" id="pwaInstallBtn" style="display: none;" aria-label="Install app">
        <span>ğŸ“²</span> Install App
    </button>

    <!-- PWA Update Toast -->
    <div class="pwa-update-toast" id="pwaUpdateToast" style="display: none;">
        <span>ğŸ”„ Update available!</span>
        <button onclick="window.location.reload()">Refresh</button>
        <button onclick="dismissUpdateToast()">âœ•</button>
    </div>

    <!-- Firebase and Authentication Scripts -->
    <script type="module">
        import authManager from './js/auth/auth-manager.js';
        import profileManager from './js/auth/profile-manager.js';
        import {
            initAuthUI,
            showNotification,
            openLoginModal,
            openSignupModal,
            closeAuthModals,
            showUpgradeModal,
            togglePasswordVisibility,
            switchToLogin,
            switchToSignup
        } from './js/auth/auth-ui.js';
        import { MultiplayerSession } from './js/multiplayer.js';
        import { database, ref, get } from './js/firebase-config.js';

        // Export to global window for onclick handlers
        window.openLoginModal = openLoginModal;
        window.openSignupModal = openSignupModal;
        window.closeAuthModals = closeAuthModals;
        window.showUpgradeModal = showUpgradeModal;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.switchToLogin = switchToLogin;
        window.switchToSignup = switchToSignup;

        // Global state
        let currentUser = null;
        let userProfile = null;

        // Game list for random selection
        const GAMES = ['word-rush', 'memory-match', 'trivia-duel', 'quick-draw', 'math-dash', 'memory-lane', 'date-designer', 'inside-our-space', 'crossword-clash', 'cinco'];
        const GAME_NAMES = {
            'word-rush': 'Word Rush',
            'memory-match': 'Memory Match',
            'trivia-duel': 'Trivia Duel',
            'quick-draw': 'Quick Draw',
            'math-dash': 'Math Dash',
            'memory-lane': 'Memory Lane',
            'date-designer': 'Date Designer',
            'inside-our-space': 'Inside Our Space',
            'crossword-clash': 'Crossword Clash',
            'cinco': 'Cinco'
        };

        // Initialize authentication UI
        initAuthUI();

        // Listen for auth state changes
        authManager.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                try {
                    userProfile = await profileManager.getUserProfile(user.uid);
                    if (userProfile) {
                        await renderAuthenticatedUI(user, userProfile);
                        if (authManager.checkIfMigrationNeeded()) {
                            const migrationData = await authManager.migrateLocalStorageData(user.uid);
                            if (migrationData) {
                                showNotification('success', 'Your progress has been saved to your account!');
                                userProfile = await profileManager.getUserProfile(user.uid);
                                await renderAuthenticatedUI(user, userProfile);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            } else {
                await authManager.signInAnonymously();
            }
        });

        // Render UI for authenticated user
        async function renderAuthenticatedUI(user, profile) {
            const displayName = profile?.profile?.displayName || user.displayName || 'Guest Player';
            if (user.isAnonymous) {
                document.getElementById('authButtons').style.display = 'flex';
                document.getElementById('userSection').style.display = 'none';
            } else {
                document.getElementById('authButtons').style.display = 'none';
                document.getElementById('userSection').style.display = 'flex';
            }
            if (profile?.stats) {
                document.getElementById('headerStreak').textContent = profile.stats.currentStreak || 0;
            }
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('headerInitials').textContent = initials;
            document.getElementById('profileName').textContent = displayName;
            if (user.isAnonymous) {
                document.getElementById('profileEmail').textContent = 'Playing as guest';
                document.getElementById('profileMemberSince').textContent = 'Guest Mode';
                document.getElementById('upgradePrompt').style.display = 'block';
            } else {
                document.getElementById('profileEmail').textContent = user.email || 'No email';
                const createdDate = profile?.profile?.createdAt
                    ? new Date(profile.profile.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
                    : 'Recently';
                document.getElementById('profileMemberSince').textContent = `Member since ${createdDate}`;
                document.getElementById('upgradePrompt').style.display = 'none';
            }
            if (profile?.stats) {
                document.getElementById('profileTotalGames').textContent = profile.stats.totalGames || 0;
                document.getElementById('profileTotalWins').textContent = profile.stats.totalWins || 0;
                document.getElementById('profileCurrentStreak').textContent = profile.stats.currentStreak || 0;
                document.getElementById('profileLongestStreak').textContent = profile.stats.longestStreak || 0;
            }
            updateContinueCard();
        }

        // Update continue playing card
        function updateContinueCard() {
            try {
                const localData = localStorage.getItem('couplesGameHub');
                if (localData) {
                    const data = JSON.parse(localData);
                    if (data.lastPlayedGame && data.totalGames > 0 && GAMES.includes(data.lastPlayedGame)) {
                        document.getElementById('continueSection').style.display = 'block';
                        document.getElementById('lastGameName').textContent = GAME_NAMES[data.lastPlayedGame] || data.lastPlayedGame;
                        window.lastPlayedGame = data.lastPlayedGame;
                    }
                }
            } catch (error) {
                console.error('Error updating continue card:', error);
            }
        }

        // Screen management
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.showGameSelection = function() {
            showScreen('gameSelectionScreen');
        };

        window.showProfileScreen = function() {
            showScreen('profileScreen');
        };

        // Play game
        window.playGame = function(gameName, mode) {
            window.location.href = `games/${gameName}.html?mode=${mode}`;
        };

        // Continue last game
        window.continueLast = function() {
            if (window.lastPlayedGame) {
                window.location.href = `games/${window.lastPlayedGame}.html?mode=local`;
            }
        };

        // Play random game
        window.playRandomGame = function() {
            const randomGame = GAMES[Math.floor(Math.random() * GAMES.length)];
            window.location.href = `games/${randomGame}.html?mode=local`;
        };

        // Dismiss continue card
        window.dismissContinue = function() {
            document.getElementById('continueSection').style.display = 'none';
            try {
                const localData = localStorage.getItem('couplesGameHub');
                if (localData) {
                    const data = JSON.parse(localData);
                    data.lastPlayedGame = null;
                    localStorage.setItem('couplesGameHub', JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error dismissing continue card:', error);
            }
        };

        // ==========================================
        // MATCHMAKING
        // ==========================================
        const GAME_ICONS = {
            'word-rush': 'ğŸ§©', 'memory-match': 'ğŸ’', 'trivia-duel': 'ğŸ¯',
            'quick-draw': 'ğŸ¨', 'math-dash': 'ğŸ²', 'memory-lane': 'ğŸ“·',
            'date-designer': 'ğŸ’•', 'inside-our-space': 'ğŸ ',
            'crossword-clash': 'ğŸ“', 'cinco': 'ğŸ´'
        };

        let mmSession = null;
        let mmSelectedGame = null;

        function getPlayerName() {
            if (userProfile?.profile?.displayName) return userProfile.profile.displayName;
            if (currentUser?.displayName) return currentUser.displayName;
            return 'Player';
        }

        function mmShowStep(stepId) {
            document.querySelectorAll('#matchmakingModal .mm-step').forEach(s => s.style.display = 'none');
            document.getElementById(stepId).style.display = 'block';
        }

        window.openMatchmaking = function() {
            mmShowStep('mmStepChoice');
            document.getElementById('matchmakingModal').classList.add('active');
            // Build game grid
            const grid = document.getElementById('mmGameGrid');
            if (!grid.hasChildNodes()) {
                GAMES.forEach(game => {
                    const btn = document.createElement('button');
                    btn.className = 'mm-game-btn';
                    btn.innerHTML = `<span class="mm-game-btn-icon">${GAME_ICONS[game] || 'ğŸ®'}</span><span class="mm-game-btn-name">${GAME_NAMES[game]}</span>`;
                    btn.onclick = () => mmSelectGame(game);
                    grid.appendChild(btn);
                });
            }
        };

        window.closeMatchmaking = function() {
            document.getElementById('matchmakingModal').classList.remove('active');
            if (mmSession) {
                mmSession.disconnect();
                mmSession = null;
            }
            mmSelectedGame = null;
        };

        window.mmShowCreate = function() {
            mmShowStep('mmStepPickGame');
        };

        window.mmShowJoin = function() {
            mmShowStep('mmStepJoin');
            document.getElementById('mmJoinError').style.display = 'none';
            document.getElementById('mmJoinCode').value = '';
            setTimeout(() => document.getElementById('mmJoinCode').focus(), 100);
        };

        window.mmBack = function() {
            mmShowStep('mmStepChoice');
        };

        async function mmSelectGame(gameName) {
            mmSelectedGame = gameName;
            mmShowStep('mmStepWaiting');
            document.getElementById('mmWaitingGame').textContent = GAME_NAMES[gameName];

            mmSession = new MultiplayerSession(gameName);
            const result = await mmSession.createSession(getPlayerName());

            if (!result.success) {
                showNotification('error', 'Failed to create game: ' + result.error);
                mmShowStep('mmStepPickGame');
                return;
            }

            document.getElementById('mmCodeDisplay').textContent = result.sessionId;

            // Listen for partner joining
            mmSession.on('onPlayerJoined', (opponentName) => {
                // Redirect to game
                const code = mmSession.sessionId;
                const name = encodeURIComponent(getPlayerName());
                window.location.href = `games/${mmSelectedGame}.html?mode=online&session=${code}&player=1&name=${name}`;
            });
        }

        window.mmCopyCode = function() {
            const code = document.getElementById('mmCodeDisplay').textContent;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    showNotification('success', 'Code copied!');
                }).catch(() => {
                    fallbackCopy(code);
                });
            } else {
                fallbackCopy(code);
            }
        };

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showNotification('success', 'Code copied!');
        }

        window.mmJoinGame = async function() {
            const codeInput = document.getElementById('mmJoinCode');
            const code = codeInput.value.trim().toUpperCase();
            const errorEl = document.getElementById('mmJoinError');

            if (code.length < 4) {
                errorEl.textContent = 'Please enter a valid code';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';
            mmShowStep('mmStepConnecting');

            try {
                // Read session from Firebase to get game type
                const sessionRef = ref(database, `sessions/${code}`);
                const snapshot = await get(sessionRef);

                if (!snapshot.exists()) {
                    mmShowStep('mmStepJoin');
                    errorEl.textContent = 'Session not found. Check the code and try again.';
                    errorEl.style.display = 'block';
                    return;
                }

                const sessionData = snapshot.val();

                if (sessionData.expiresAt < Date.now()) {
                    mmShowStep('mmStepJoin');
                    errorEl.textContent = 'This session has expired.';
                    errorEl.style.display = 'block';
                    return;
                }

                if (sessionData.players?.player2 && sessionData.players.player2.name !== getPlayerName()) {
                    mmShowStep('mmStepJoin');
                    errorEl.textContent = 'This session is already full.';
                    errorEl.style.display = 'block';
                    return;
                }

                const gameName = sessionData.gameType;
                const name = encodeURIComponent(getPlayerName());
                window.location.href = `games/${gameName}.html?mode=online&session=${code}&player=2&name=${name}`;
            } catch (error) {
                console.error('Join error:', error);
                mmShowStep('mmStepJoin');
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        };

        // Allow Enter key in join code input
        document.getElementById('mmJoinCode')?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') mmJoinGame();
        });

        // Make authManager and profileManager globally available
        window.authManager = authManager;
        window.profileManager = profileManager;
        window.showNotification = showNotification;

        // ==========================================
        // SEARCH & FILTER
        // ==========================================
        const searchInput = document.getElementById('hubSearch');
        const filterChips = document.querySelectorAll('.hub-filter-chip');
        const gameCards = document.querySelectorAll('.hub-card');
        let activeFilter = 'all';

        function filterGames() {
            const query = searchInput.value.toLowerCase().trim();
            gameCards.forEach(card => {
                const title = (card.dataset.title || '').toLowerCase();
                const desc = (card.dataset.desc || '').toLowerCase();
                const tags = (card.dataset.tags || '').toLowerCase();
                const matchesSearch = !query || title.includes(query) || desc.includes(query);
                const matchesFilter = activeFilter === 'all' || tags.includes(activeFilter);
                card.classList.toggle('hidden', !(matchesSearch && matchesFilter));
            });
        }

        searchInput.addEventListener('input', filterGames);

        filterChips.forEach(chip => {
            chip.addEventListener('click', () => {
                filterChips.forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeFilter = chip.dataset.filter;
                filterGames();
            });
        });

        // Keyboard navigation for cards
        gameCards.forEach(card => {
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    card.click();
                }
            });
        });

        // ==========================================
        // PWA: Service Worker Registration
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('[PWA] SW registered:', registration.scope);
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                document.getElementById('pwaUpdateToast').style.display = 'flex';
                            }
                        });
                    });
                } catch (error) {
                    console.log('[PWA] SW registration failed:', error);
                }
            });
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_ACTIVATED') {
                    document.getElementById('pwaUpdateToast').style.display = 'flex';
                }
            });
        }

        window.dismissUpdateToast = function() {
            document.getElementById('pwaUpdateToast').style.display = 'none';
        };

        // ==========================================
        // PWA: Install Prompt
        // ==========================================
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstallBtn').style.display = 'block';
            document.getElementById('heroInstallBtn').style.display = 'inline-flex';
        });

        async function triggerInstall() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('[PWA] User accepted install');
            }
            deferredPrompt = null;
            document.getElementById('pwaInstallBtn').style.display = 'none';
            document.getElementById('heroInstallBtn').style.display = 'none';
        }

        document.getElementById('pwaInstallBtn').addEventListener('click', triggerInstall);
        document.getElementById('heroInstallBtn').addEventListener('click', triggerInstall);

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            document.getElementById('pwaInstallBtn').style.display = 'none';
            document.getElementById('heroInstallBtn').style.display = 'none';
            deferredPrompt = null;
        });

        // Initial load
        updateContinueCard();
    </script>
</body>
</html>
