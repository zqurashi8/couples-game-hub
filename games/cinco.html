<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cinco - Card Game</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/cinco.css">
    <style>
        /* Online Lobby Styles - Dark Theme */
        .cinco-lobby {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .lobby-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .lobby-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .lobby-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #3498DB;
            transform: translateY(-2px);
        }

        .lobby-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .lobby-card h3 {
            color: white;
            margin: 0 0 8px 0;
            font-size: 1.1em;
        }

        .lobby-card p {
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
            font-size: 0.85em;
        }

        .lobby-input-group {
            margin-bottom: 20px;
        }

        .lobby-input-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .lobby-input {
            width: 100%;
            padding: 14px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            box-sizing: border-box;
        }

        .lobby-input:focus {
            outline: none;
            border-color: #3498DB;
        }

        .lobby-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .lobby-input.code-input {
            text-align: center;
            font-size: 1.5em;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-family: monospace;
        }

        .lobby-btn {
            width: 100%;
            padding: 14px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .lobby-btn-primary {
            background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
            color: white;
        }

        .lobby-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
        }

        .lobby-btn-secondary {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .lobby-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .lobby-btn-danger {
            background: #e74c3c;
            color: white;
        }

        .session-code-display {
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid #3498DB;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }

        .session-code {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498DB;
            letter-spacing: 10px;
            font-family: monospace;
            margin: 15px 0;
        }

        .code-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .copy-btn {
            background: #3498DB;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .waiting-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #3498DB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .waiting-text {
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .connected-check {
            width: 60px;
            height: 60px;
            background: #2ECC71;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            margin: 20px auto;
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .lobby-back-btn {
            color: rgba(255, 255, 255, 0.6);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            margin-bottom: 20px;
            padding: 0;
        }

        .lobby-back-btn:hover {
            color: white;
        }
    </style>
</head>
<body>
    <div class="cinco-game" data-testid="cinco-root">
        <!-- Mode Selection Screen -->
        <div class="cinco-screen active" id="modeScreen">
            <div class="cinco-mode-selection">
                <a href="../index.html" class="back-link" data-testid="back-to-hub">‚Üê Back to Games</a>
                <h1 class="cinco-title">CINCO</h1>
                <p class="cinco-subtitle">Strategic Card Combat</p>

                <div class="cinco-mode-buttons">
                    <button class="cinco-mode-btn" id="aiModeBtn">
                        <span style="font-size: 1.5em;">ü§ñ</span><br>
                        Play vs AI
                    </button>
                    <button class="cinco-mode-btn" id="localModeBtn">
                        <span style="font-size: 1.5em;">üë•</span><br>
                        Pass & Play
                    </button>
                    <button class="cinco-mode-btn" id="onlineModeBtn">
                        <span style="font-size: 1.5em;">üåê</span><br>
                        Play Online
                    </button>
                </div>
            </div>
        </div>

        <!-- Online Lobby Screen -->
        <div class="cinco-screen" id="onlineLobbyScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="lobbyBackBtn">‚Üê Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 10px;">üåê Play Online</h2>
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 20px;">Play with a friend remotely</p>

                <div class="lobby-options">
                    <div class="lobby-card" id="createGameCard">
                        <div class="lobby-icon">‚ûï</div>
                        <h3>Create Game</h3>
                        <p>Start a new game and share the code</p>
                    </div>

                    <div class="lobby-card" id="joinGameCard">
                        <div class="lobby-icon">üîó</div>
                        <h3>Join Game</h3>
                        <p>Enter a code to join your friend</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Game Screen -->
        <div class="cinco-screen" id="createGameScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="createBackBtn">‚Üê Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 25px;">Create Game</h2>

                <div class="lobby-input-group">
                    <label>Your Name</label>
                    <input type="text" class="lobby-input" id="createNameInput" placeholder="Enter your name" maxlength="20">
                </div>

                <button class="lobby-btn lobby-btn-primary" id="createGameBtn">Create Game</button>
            </div>
        </div>

        <!-- Waiting Room Screen -->
        <div class="cinco-screen" id="waitingRoomScreen">
            <div class="cinco-lobby">
                <h2 style="color: white; text-align: center;">Waiting for Player 2</h2>

                <div class="session-code-display">
                    <div class="code-label">Share this code with your friend:</div>
                    <div class="session-code" id="sessionCodeDisplay">------</div>
                    <button class="copy-btn" id="copyCodeBtn">üìã Copy Code</button>
                </div>

                <div class="waiting-spinner"></div>
                <p class="waiting-text">Waiting for someone to join...</p>

                <button class="lobby-btn lobby-btn-danger" id="cancelSessionBtn">Cancel</button>
            </div>
        </div>

        <!-- Join Game Screen -->
        <div class="cinco-screen" id="joinGameScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="joinBackBtn">‚Üê Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 25px;">Join Game</h2>

                <div id="joinError" class="error-message" style="display: none;"></div>

                <div class="lobby-input-group">
                    <label>Your Name</label>
                    <input type="text" class="lobby-input" id="joinNameInput" placeholder="Enter your name" maxlength="20">
                </div>

                <div class="lobby-input-group">
                    <label>Game Code</label>
                    <input type="text" class="lobby-input code-input" id="joinCodeInput" placeholder="------" maxlength="6">
                </div>

                <button class="lobby-btn lobby-btn-primary" id="joinGameBtn">Join Game</button>
            </div>
        </div>

        <!-- Connecting Screen -->
        <div class="cinco-screen" id="connectingScreen">
            <div class="cinco-lobby" style="text-align: center;">
                <div class="connected-check">‚úì</div>
                <h2 style="color: white;">Connected!</h2>
                <p style="color: rgba(255,255,255,0.7); font-size: 1.1em;">
                    Playing with <strong id="connectedPartnerName">Partner</strong>
                </p>
                <p class="waiting-text">Starting game...</p>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="cinco-screen" id="gameScreen">
            <div class="cinco-board" data-testid="cinco-table">
                <!-- OPPONENT AT VERY TOP -->
                <div class="cinco-opponent-area">
                    <div class="cinco-opponent-hand" id="opponentHand" data-testid="cinco-opponent-hand"></div>
                    <div class="cinco-opponent-info">
                        <span id="opponentName">Opponent</span> ¬∑ <span id="opponentCardCount">7</span> cards
                    </div>
                </div>

                <!-- COMPACT CENTER -->
                <div class="cinco-center-area">
                    <div class="cinco-turn-indicator" id="turnIndicator" data-testid="cinco-turn-indicator">Your Turn</div>

                    <div class="cinco-deck-area">
                        <div class="cinco-draw-pile" id="drawPile" data-testid="cinco-draw-pile" data-action="draw">üé¥</div>
                        <div class="cinco-discard-pile" id="discardPile" data-testid="cinco-discard-pile" data-action="play"></div>
                    </div>
                    <!-- Test helpers for action identification -->
                    <button type="button" data-testid="cinco-action-draw" id="testActionDraw" style="display:none;" aria-hidden="true"></button>
                    <button type="button" data-testid="cinco-action-play" id="testActionPlay" style="display:none;" aria-hidden="true"></button>
                    <button type="button" data-testid="cinco-action-end-turn" id="testActionEndTurn" style="display:none;" aria-hidden="true"></button>

                    <div class="cinco-center-info">
                        <span id="colorIndicator"></span>
                    </div>

                    <div class="cinco-effects" id="activeEffects"></div>
                </div>

                <!-- PLAYER HAND AT BOTTOM -->
                <div class="cinco-player-area">
                    <div class="cinco-player-info">
                        <span id="playerName">You</span> ¬∑ <span id="playerCardCount">7</span> cards
                    </div>
                    <div class="cinco-player-hand" id="playerHand" data-testid="cinco-player-hand"></div>
                </div>
            </div>

            <!-- Overlays -->
            <div class="cinco-action-banner" id="actionBanner">
                <div class="banner-icon" id="bannerIcon"></div>
                <div class="banner-title" id="bannerTitle"></div>
                <div class="banner-description" id="bannerDescription"></div>
            </div>

            <button class="cinco-btn" id="cincoBtn">CINCO!</button>
        </div>

        <!-- Game Over Screen -->
        <div class="cinco-screen" id="gameOverScreen">
            <div class="cinco-game-over">
                <div class="cinco-result-emoji" id="resultEmoji">üèÜ</div>
                <div class="cinco-result-message" id="resultMessage">You Win!</div>
                <div class="cinco-result-details" id="resultDetails"></div>

                <div class="cinco-result-actions">
                    <button class="cinco-mode-btn" id="playAgainBtn">Play Again</button>
                    <button class="cinco-mode-btn" style="background: var(--color-primary-dark);" onclick="location.href='../index.html'">
                        Back to Games
                    </button>
                </div>
            </div>
        </div>

        <!-- Color Picker Modal -->
        <div class="cinco-color-picker" id="colorPicker">
            <div class="cinco-color-picker-content">
                <h3>Choose a Color</h3>
                <div class="cinco-color-options">
                    <div class="cinco-color-option red" data-color="red"></div>
                    <div class="cinco-color-option blue" data-color="blue"></div>
                    <div class="cinco-color-option green" data-color="green"></div>
                    <div class="cinco-color-option yellow" data-color="yellow"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import authManager from '../js/auth/auth-manager.js';
        import profileManager from '../js/auth/profile-manager.js';
        import { showNotification } from '../js/auth/auth-ui.js';
        import CincoGame from '../js/cinco-game.js';
        import CincoOnline from '../js/cinco-online.js';
        import { MultiplayerSession } from '../js/multiplayer.js';

        // Global state
        let currentUser = null;
        let gameMode = null;
        let game = null;
        let onlineGame = null;
        let multiplayerSession = null;
        let gameStartTime = null;
        let colorSelectionCallback = null;
        let longPressTimer = null;
        let opponentName = 'Opponent';
        let selectedCardIndex = null; // Track selected card for two-tap play

        // Auth state
        authManager.onAuthStateChanged((user) => {
            currentUser = user;
        });

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.cinco-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        }

        // Mode selection handlers
        document.getElementById('aiModeBtn').addEventListener('click', () => startGame('ai'));
        document.getElementById('localModeBtn').addEventListener('click', () => startGame('local'));
        document.getElementById('onlineModeBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));

        document.getElementById('playAgainBtn').addEventListener('click', () => {
            showScreen('modeScreen');
            game = null;
            onlineGame = null;
            multiplayerSession = null;
            selectedCardIndex = null;
            document.querySelector('.cinco-game').classList.remove('online-mode');
        });

        // Online lobby navigation
        document.getElementById('lobbyBackBtn').addEventListener('click', () => showScreen('modeScreen'));
        document.getElementById('createGameCard').addEventListener('click', () => showScreen('createGameScreen'));
        document.getElementById('joinGameCard').addEventListener('click', () => showScreen('joinGameScreen'));
        document.getElementById('createBackBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));
        document.getElementById('joinBackBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));

        // Create game
        document.getElementById('createGameBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('createNameInput').value.trim() || 'Player 1';

            try {
                multiplayerSession = new MultiplayerSession('cinco');
                const result = await multiplayerSession.createSession(playerName);

                if (result.success) {
                    document.getElementById('sessionCodeDisplay').textContent = result.sessionId;
                    showScreen('waitingRoomScreen');

                    // Listen for player 2 joining
                    multiplayerSession.on('onPlayerJoined', (partnerName) => {
                        opponentName = partnerName;
                        document.getElementById('connectedPartnerName').textContent = partnerName;
                        showScreen('connectingScreen');

                        // Start game after brief delay
                        setTimeout(() => startOnlineGame(true, playerName), 1500);
                    });
                } else {
                    showNotification('error', 'Failed to create game');
                }
            } catch (error) {
                console.error('Create game error:', error);
                showNotification('error', 'Failed to create game');
            }
        });

        // Copy code
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const code = document.getElementById('sessionCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('success', 'Code copied!');
            });
        });

        // Cancel session
        document.getElementById('cancelSessionBtn').addEventListener('click', () => {
            if (multiplayerSession) {
                multiplayerSession.disconnect();
                multiplayerSession = null;
            }
            showScreen('onlineLobbyScreen');
        });

        // Join game
        document.getElementById('joinGameBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('joinNameInput').value.trim() || 'Player 2';
            const sessionCode = document.getElementById('joinCodeInput').value.trim().toUpperCase();
            const errorEl = document.getElementById('joinError');

            if (!sessionCode || sessionCode.length !== 6) {
                errorEl.textContent = 'Please enter a valid 6-character code';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            try {
                multiplayerSession = new MultiplayerSession('cinco');
                const result = await multiplayerSession.joinSession(sessionCode, playerName);

                if (result.success) {
                    opponentName = result.opponentName || 'Player 1';
                    document.getElementById('connectedPartnerName').textContent = opponentName;
                    showScreen('connectingScreen');

                    // Start game after brief delay
                    setTimeout(() => startOnlineGame(false, playerName), 1500);
                } else {
                    errorEl.textContent = result.error || 'Failed to join game';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Join game error:', error);
                errorEl.textContent = 'Failed to join game. Check the code and try again.';
                errorEl.style.display = 'block';
            }
        });

        // Start online game
        async function startOnlineGame(isHost, playerName) {
            gameMode = 'online';
            gameStartTime = Date.now();

            const playerRole = isHost ? 'player1' : 'player2';

            // Create online game wrapper
            onlineGame = new CincoOnline(multiplayerSession, playerRole, {
                onStateUpdate: handleOnlineStateUpdate,
                onOpponentAction: handleOpponentAction,
                onGameOver: handleGameOver,
                onHandUpdate: handleHandUpdate
            });

            // Create game instance
            game = new CincoGame('online', {
                onStateChange: handleOnlineStateChange,
                requestColorSelection: requestColorSelection,
                playAnimation: playAnimation,
                showNotification: showNotification,
                gameOver: handleGameOver
            });

            // Listen for game state changes
            multiplayerSession.on('onGameStateChange', (state) => {
                if (state) handleOnlineStateUpdate(state);
            });

            // Listen for opponent disconnect
            multiplayerSession.on('onOpponentDisconnect', () => {
                showNotification('warning', 'Opponent disconnected');
            });

            if (isHost) {
                game.startGame();
                await onlineGame.initializeGame(game.getState());
            }

            // Update UI
            document.getElementById('opponentName').textContent = opponentName;
            document.getElementById('playerName').textContent = playerName;

            showScreen('gameScreen');
            document.querySelector('.cinco-game').classList.add('online-mode');
        }

        // Start local/AI game
        async function startGame(mode) {
            gameMode = mode;
            gameStartTime = Date.now();

            game = new CincoGame(mode, {
                onStateChange: updateUI,
                requestColorSelection: requestColorSelection,
                playAnimation: playAnimation,
                showNotification: showNotification,
                gameOver: handleGameOver
            });

            game.startGame();
            showScreen('gameScreen');

            if (mode === 'ai') {
                document.getElementById('opponentName').textContent = 'ü§ñ AI';
            } else if (mode === 'local') {
                document.getElementById('opponentName').textContent = 'Player 2';
            }
        }

        // Handle online state change (send to Firebase)
        async function handleOnlineStateChange(state) {
            updateUI(state);
        }

        // Handle online state update (from Firebase)
        function handleOnlineStateUpdate(state) {
            updateUIFromOnlineState(state);
        }

        // Handle opponent action
        function handleOpponentAction(action) {
            if (action.type === 'play_card') {
                playAnimation(action.card.value, 'opponent');
            } else if (action.type === 'say_cinco') {
                showNotification('warning', 'üåê Opponent said CINCO!');
            }
        }

        // Handle hand update
        function handleHandUpdate(hand) {
            if (game) {
                game.playerHand = hand;
                updateUI(game.getState());
            }
        }

        // Update UI
        function updateUI(state) {
            document.getElementById('playerCardCount').textContent = state.playerCardCount || state.playerHand?.length || 0;
            document.getElementById('opponentCardCount').textContent = state.opponentCardCount || state.opponentHand?.length || 0;

            const turnIndicator = document.getElementById('turnIndicator');
            if (state.currentTurn === 'player') {
                turnIndicator.textContent = 'üéØ Your Turn';
                turnIndicator.classList.add('your-turn');
            } else {
                turnIndicator.textContent = state.aiThinking ? 'ü§ñ AI Thinking...' : '‚è≥ Waiting...';
                turnIndicator.classList.remove('your-turn');
            }

            if (state.currentColor) {
                const colorEmojis = { red: 'üî¥', blue: 'üîµ', green: 'üü¢', yellow: 'üü°' };
                document.getElementById('colorIndicator').textContent = colorEmojis[state.currentColor] || '';
            }

            renderPlayerHand(state.playerHand || [], state.currentTurn === 'player');
            renderOpponentHand(state.opponentCardCount || state.opponentHand?.length || 0);

            if (state.discardPile && state.discardPile.length > 0) {
                renderDiscardPile(state.discardPile[state.discardPile.length - 1]);
            }

            renderActiveEffects(state.activeEffects);

            const drawPile = document.getElementById('drawPile');
            if (state.currentTurn === 'player' && game) {
                const hasPlayableCard = (state.playerHand || []).some(card => game.isCardPlayable(card));
                drawPile.classList.toggle('must-draw', !hasPlayableCard);
            } else {
                drawPile.classList.remove('must-draw');
            }

            updateCincoButtonState(state);
        }

        // Update UI from online state
        function updateUIFromOnlineState(state) {
            document.getElementById('playerCardCount').textContent = state.playerCardCount || 0;
            document.getElementById('opponentCardCount').textContent = state.opponentCardCount || 0;

            const turnIndicator = document.getElementById('turnIndicator');
            const myRole = onlineGame?.playerRole || 'player1';
            const isMyTurn = state.currentTurn === (myRole === 'player1' ? 'player' : 'opponent');

            if (isMyTurn) {
                turnIndicator.textContent = 'üéØ Your Turn';
                turnIndicator.classList.add('your-turn');
            } else {
                turnIndicator.textContent = '‚è≥ Waiting...';
                turnIndicator.classList.remove('your-turn');
            }

            if (state.currentColor) {
                const colorEmojis = { red: 'üî¥', blue: 'üîµ', green: 'üü¢', yellow: 'üü°' };
                document.getElementById('colorIndicator').textContent = colorEmojis[state.currentColor] || '';
            }

            renderOpponentHand(state.opponentCardCount);
            if (state.discardPile && state.discardPile.length > 0) {
                renderDiscardPile(state.discardPile[state.discardPile.length - 1]);
            }
            renderActiveEffects(state.activeEffects);
            updateCincoButtonState(state);
        }

        // Render player hand
        function renderPlayerHand(hand, canPlay) {
            const container = document.getElementById('playerHand');
            container.innerHTML = hand.map((card, index) => {
                const playable = canPlay && game?.isCardPlayable(card);
                const selected = index === selectedCardIndex;
                return `
                    <div class="cinco-card ${card.color} ${playable ? 'playable' : 'disabled'} ${selected ? 'selected' : ''}"
                         data-index="${index}"
                         data-value="${card.value}">
                        <div class="cinco-card-corner top-left">${CincoGame.getCardDisplay(card.value)}</div>
                        <div>${CincoGame.getCardDisplay(card.value)}</div>
                        <div class="cinco-card-corner bottom-right">${CincoGame.getCardDisplay(card.value)}</div>
                    </div>
                `;
            }).join('');

            container.querySelectorAll('.cinco-card').forEach(card => {
                const index = parseInt(card.dataset.index);

                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCardTap(index);
                });

                card.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        showCardDescription(card.dataset.value, e.touches[0].clientX, e.touches[0].clientY);
                    }, 500);
                });

                card.addEventListener('touchend', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    hideCardDescription();
                });
            });
        }

        // Render opponent hand
        function renderOpponentHand(count) {
            const container = document.getElementById('opponentHand');
            container.innerHTML = Array(count).fill(0).map((_, i) => {
                const rotation = (i - count / 2) * 3;
                return `<div class="cinco-card-back" style="--rotation: ${rotation}deg;">üé¥</div>`;
            }).join('');
        }

        // Render discard pile
        function renderDiscardPile(card) {
            const container = document.getElementById('discardPile');
            container.innerHTML = `
                <div class="cinco-card ${card.color}" style="width: 100%; height: 100%; min-width: 0; border-radius: 8px;">
                    <div class="cinco-card-corner top-left">${CincoGame.getCardDisplay(card.value)}</div>
                    <div>${CincoGame.getCardDisplay(card.value)}</div>
                    <div class="cinco-card-corner bottom-right">${CincoGame.getCardDisplay(card.value)}</div>
                </div>
            `;
        }

        // Render active effects
        function renderActiveEffects(effects) {
            const container = document.getElementById('activeEffects');
            const badges = [];

            if (effects?.firewall?.player) {
                badges.push('<div class="cinco-effect-badge firewall">üõ°Ô∏è Shield</div>');
            }
            if (effects?.firewall?.opponent) {
                badges.push('<div class="cinco-effect-badge firewall">üõ°Ô∏è Enemy Shield</div>');
            }

            if (effects?.lockedColors) {
                const colorEmojis = { red: 'üî¥', blue: 'üîµ', green: 'üü¢', yellow: 'üü°' };
                Object.keys(effects.lockedColors).forEach(color => {
                    if (effects.lockedColors[color] > 0) {
                        badges.push(`<div class="cinco-effect-badge locked-color">üîí ${colorEmojis[color]}</div>`);
                    }
                });
            }

            container.innerHTML = badges.join('');
        }

        // Handle card tap - TWO-TAP SYSTEM: first tap selects, second tap plays
        async function handleCardTap(index) {
            if (!game) return;

            const state = game.getState();
            const card = state.playerHand?.[index];
            if (!card) return;

            // Check if it's player's turn
            if (state.currentTurn !== 'player') return;

            const isPlayable = game.isCardPlayable(card);

            // If clicking the already selected card
            if (selectedCardIndex === index) {
                if (isPlayable) {
                    // Second tap on selected playable card - PLAY IT
                    const success = game.selectCard(index);
                    if (success && gameMode === 'online' && onlineGame) {
                        await onlineGame.playCard(game.discardPile[game.discardPile.length - 1], game.getState());
                    }
                    selectedCardIndex = null; // Reset selection after playing
                } else {
                    // Tapping unplayable selected card - deselect
                    selectedCardIndex = null;
                    updateUI(game.getState());
                }
            } else {
                // First tap on any card - SELECT IT (lift it up)
                selectedCardIndex = index;
                updateUI(game.getState());
            }
        }

        // Deselect when tapping elsewhere
        document.addEventListener('click', (e) => {
            if (selectedCardIndex !== null && !e.target.closest('.cinco-card') && !e.target.closest('.cinco-draw-pile')) {
                selectedCardIndex = null;
                if (game) updateUI(game.getState());
            }
        });

        // Draw pile click
        document.getElementById('drawPile').addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!game) return;

            selectedCardIndex = null; // Reset selection when drawing
            const success = game.drawCard();
            if (success && gameMode === 'online' && onlineGame) {
                await onlineGame.drawCard(game.getState());
            }
        });

        // CINCO button state
        function updateCincoButtonState(state) {
            const cincoBtn = document.getElementById('cincoBtn');

            if (gameMode !== 'online') {
                cincoBtn.classList.remove('clickable', 'disabled', 'said');
                return;
            }

            const playerCards = state.playerCardCount || state.playerHand?.length || 0;
            cincoBtn.classList.remove('clickable', 'disabled', 'said');

            if (state.playerSaidCinco) {
                cincoBtn.classList.add('said');
                cincoBtn.textContent = '‚úì CINCO!';
            } else if (playerCards === 1) {
                cincoBtn.classList.add('clickable');
                cincoBtn.textContent = 'CINCO!';
            } else {
                cincoBtn.classList.add('disabled');
                cincoBtn.textContent = 'CINCO!';
            }
        }

        // Cinco button click
        document.getElementById('cincoBtn').addEventListener('click', async () => {
            if (!game || gameMode !== 'online') return;

            const playerCards = game.playerHand?.length || 0;
            const cincoBtn = document.getElementById('cincoBtn');

            if (playerCards === 1 && !game.playerSaidCinco) {
                const success = game.sayCinco();
                if (success) {
                    cincoBtn.classList.remove('clickable');
                    cincoBtn.classList.add('said');
                    cincoBtn.textContent = '‚úì CINCO!';
                    showNotification('success', 'üéâ CINCO!');

                    if (onlineGame) {
                        await onlineGame.sayCinco();
                    }
                }
            } else if (playerCards !== 1) {
                showNotification('error', '‚ùå Wrong! Draw 2 penalty!');
                game.drawCard();
                game.drawCard();
                updateUI(game.getState());
            }
        });

        // Color selection
        function requestColorSelection(callback) {
            colorSelectionCallback = callback;
            const lockedColors = game?.activeEffects?.lockedColors || {};

            document.querySelectorAll('.cinco-color-option').forEach(option => {
                const color = option.dataset.color;
                option.classList.toggle('locked', !!lockedColors[color]);
                option.disabled = !!lockedColors[color];
            });

            document.getElementById('colorPicker').classList.add('active');
        }

        document.querySelectorAll('.cinco-color-option').forEach(option => {
            option.addEventListener('click', () => {
                if (option.disabled || option.classList.contains('locked')) return;

                const color = option.dataset.color;
                document.getElementById('colorPicker').classList.remove('active');
                if (colorSelectionCallback) {
                    colorSelectionCallback(color);
                    colorSelectionCallback = null;
                }
            });
        });

        // Card description tooltip
        function showCardDescription(value, x, y) {
            const desc = CincoGame.getCardDescription(value);
            if (!desc) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'cinco-card-tooltip visible';
            tooltip.textContent = desc;
            tooltip.style.left = x + 'px';
            tooltip.style.top = (y - 50) + 'px';
            tooltip.id = 'cardTooltip';
            document.body.appendChild(tooltip);
        }

        function hideCardDescription() {
            const tooltip = document.getElementById('cardTooltip');
            if (tooltip) tooltip.remove();
        }

        // Animations
        function playAnimation(type, playedBy = 'player') {
            showActionBanner(type, playedBy);
        }

        function showActionBanner(cardType, playedBy) {
            const banner = document.getElementById('actionBanner');
            const icon = document.getElementById('bannerIcon');
            const title = document.getElementById('bannerTitle');
            const description = document.getElementById('bannerDescription');

            const playerLabel = playedBy === 'player' ? 'You' : (gameMode === 'ai' ? 'AI' : 'Opponent');

            const announcements = {
                'quantumskip': { icon: 'üö´', title: `${playerLabel} played Skip`, description: 'Turn skipped', type: 'special' },
                'reversepolarity': { icon: 'üîÑ', title: `${playerLabel} played Reverse`, description: 'Direction reversed', type: 'special' },
                'neuraldrain': { icon: '‚ûï2Ô∏è‚É£', title: `${playerLabel} played +2`, description: 'Draw 2 cards', type: 'attack' },
                'overdrive': { icon: '‚ûï3Ô∏è‚É£', title: `${playerLabel} played +3`, description: 'Draw 3 cards', type: 'attack' },
                'systemoverload': { icon: '‚≠ê+4', title: `${playerLabel} played Wild +4`, description: 'Draw 4 cards', type: 'attack' },
                'empblast': { icon: 'üí•', title: `${playerLabel} played Wipe`, description: 'Hand wiped', type: 'attack' },
                'firewall': { icon: 'üõ°Ô∏è', title: `${playerLabel} played Shield`, description: 'Attack blocked', type: 'defense' },
                'adaptiveprotocol': { icon: '‚≠ê', title: `${playerLabel} played Wild`, description: 'Color changed', type: 'wild' },
                'datacorruption': { icon: 'üîÄ', title: `${playerLabel} played Swap`, description: 'Hands swapped', type: 'wild' },
                'turnsteal': { icon: '‚ö°', title: `${playerLabel} played Extra Turn`, description: 'Extra turn', type: 'special' },
                'systemlockdown': { icon: 'üîí', title: `${playerLabel} played Lock`, description: 'Color locked', type: 'special' },
                'mirrorcode': { icon: 'üë•', title: `${playerLabel} played Copy`, description: 'Effect copied', type: 'wild' },
                'firewall_block': { icon: 'üõ°Ô∏èüí•', title: 'Shield Block!', description: 'Attack absorbed', type: 'defense' }
            };

            const announcement = announcements[cardType];
            if (!announcement) return;

            icon.textContent = announcement.icon;
            title.textContent = announcement.title;
            description.textContent = announcement.description;

            banner.classList.remove('attack', 'defense', 'wild', 'special');
            banner.classList.add(announcement.type);
            banner.classList.add('show');

            setTimeout(() => banner.classList.remove('show'), 2500);
        }

        // Game over
        async function handleGameOver(winner, result) {
            const isWin = (winner === 'player' && gameMode !== 'online') ||
                          (winner === onlineGame?.playerRole);

            document.getElementById('resultEmoji').textContent = isWin ? 'üèÜ' : 'üòî';
            document.getElementById('resultMessage').textContent = isWin ? 'You Win!' : 'You Lose!';
            document.getElementById('resultDetails').textContent = isWin ?
                'Congratulations!' : 'Better luck next time!';

            showScreen('gameOverScreen');
            await saveGameResults(result);
        }

        async function saveGameResults(result) {
            if (!currentUser || currentUser.isAnonymous) return;

            try {
                const gameDuration = Math.floor((Date.now() - gameStartTime) / 1000);

                await profileManager.addGameToHistory(currentUser.uid, {
                    gameName: 'cinco',
                    score: 0,
                    result: result,
                    opponentId: null,
                    playedAt: Date.now(),
                    duration: gameDuration,
                    details: { mode: gameMode }
                });

                await profileManager.updateGameStats(currentUser.uid, 'cinco', { result });
                await profileManager.incrementStreak(currentUser.uid);
            } catch (error) {
                console.error('Failed to save game:', error);
            }
        }

        // iOS viewport fix
        function setVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVh();
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', setVh);
    </script>
</body>
</html>
