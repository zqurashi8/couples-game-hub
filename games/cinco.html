<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cinco - Card Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-0: #1E2430;
            --bg-1: #161B26;
            --panel: #252D3D;
            --panel-edge: #3a4565;
            --text: rgba(255,255,255,.95);
            --muted: rgba(255,255,255,.75);
            --accent: #5DDBD3;
            --blue: #4FA8FF;
            --yellow: #FFD166;
            --red: #FF7B9C;
            --drawA: #5DDBD3;
            --drawB: #4FA8FF;
            --pad: clamp(10px, 2.2vw, 16px);
            --gap: clamp(10px, 2vw, 14px);
            --r-lg: 22px;
            --r-md: 16px;
            --shadow-soft: 0 10px 18px rgba(0,0,0,.18);
            --shadow-2: 0 12px 28px rgba(0,0,0,.26);
            --banner-h: clamp(48px, 7.6vw, 60px);
            --card-w: clamp(68px, 18.5vw, 110px);
            --card-h: calc(var(--card-w) * 1.36);
            --pile-w: clamp(86px, 22vw, 138px);
            --pile-h: calc(var(--pile-w) * 1.36);
            --safe: clamp(10px, 3.2vw, 16px);
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: manipulation;
            font-family: ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "Inter", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(900px 520px at 10% 0%, rgba(79,168,255,.18), transparent 55%),
                radial-gradient(900px 560px at 90% 10%, rgba(93,219,211,.14), transparent 60%),
                radial-gradient(900px 560px at 50% 120%, rgba(255,123,156,.12), transparent 55%),
                linear-gradient(180deg, var(--bg-0), var(--bg-1));
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: .05;
            background-image:
                radial-gradient(circle at 12px 12px, rgba(255,255,255,.55) 2px, transparent 2.3px),
                radial-gradient(circle at 32px 28px, rgba(93,219,211,.65) 2px, transparent 2.3px),
                radial-gradient(circle at 58px 18px, rgba(79,168,255,.65) 2px, transparent 2.3px),
                radial-gradient(circle at 74px 42px, rgba(255,123,156,.65) 2px, transparent 2.3px),
                radial-gradient(circle at 90px 12px, rgba(255,209,102,.65) 2px, transparent 2.3px);
            background-size: 120px 70px;
            filter: blur(.2px);
        }

        /* Screens */
        .cinco-screen {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
            padding: 20px;
            box-sizing: border-box;
        }

        .cinco-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Mode Selection */
        .cinco-mode-selection {
            max-width: 500px;
            width: 100%;
            text-align: center;
            padding: 20px;
        }

        .back-link {
            display: inline-block;
            color: var(--blue);
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 30px;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--accent); }

        .cinco-title {
            font-size: clamp(48px, 12vw, 72px);
            font-weight: 900;
            color: white;
            margin: 0 0 10px 0;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 0 4px 20px rgba(79,168,255,.3);
        }

        .cinco-subtitle {
            font-size: 18px;
            color: var(--muted);
            margin: 0 0 50px 0;
            font-weight: 500;
        }

        .cinco-mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .cinco-mode-btn {
            background: var(--panel);
            border: 2px solid var(--panel-edge);
            border-radius: var(--r-lg);
            padding: 24px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-soft);
            font-family: inherit;
            text-align: center;
        }

        .cinco-mode-btn:hover {
            background: #252c45;
            transform: translateY(-2px);
            box-shadow: var(--shadow-2);
            border-color: var(--accent);
        }

        .cinco-mode-btn:active {
            transform: translateY(0);
        }

        /* Online Lobby Styles */
        .cinco-lobby {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .lobby-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .lobby-card {
            background: var(--panel);
            border: 2px solid var(--panel-edge);
            border-radius: var(--r-lg);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .lobby-card:hover {
            background: #252c45;
            border-color: var(--blue);
            transform: translateY(-2px);
        }

        .lobby-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .lobby-card h3 {
            color: white;
            margin: 0 0 8px 0;
            font-size: 1.1em;
        }

        .lobby-card p {
            color: var(--muted);
            margin: 0;
            font-size: 0.85em;
        }

        .lobby-input-group {
            margin-bottom: 20px;
        }

        .lobby-input-group label {
            display: block;
            color: var(--muted);
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .lobby-input {
            width: 100%;
            padding: 14px;
            font-size: 1em;
            background: #1a1f32;
            border: 2px solid #3a4565;
            border-radius: var(--r-md);
            color: white;
            box-sizing: border-box;
            font-family: inherit;
        }

        .lobby-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .lobby-input::placeholder {
            color: rgba(255,255,255,.4);
        }

        .lobby-input.code-input {
            text-align: center;
            font-size: 1.5em;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-family: monospace;
        }

        .lobby-btn {
            width: 100%;
            padding: 14px;
            font-size: 1em;
            font-weight: 700;
            border: none;
            border-radius: var(--r-md);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            font-family: inherit;
        }

        .lobby-btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #1EB980 100%);
            color: white;
        }

        .lobby-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(47,224,143,.4);
        }

        .lobby-btn-secondary {
            background: #1a1f32;
            color: var(--muted);
            border: 2px solid #3a4565;
        }

        .lobby-btn-secondary:hover {
            background: #252c45;
        }

        .lobby-btn-danger {
            background: var(--red);
            color: white;
        }

        .session-code-display {
            background: #1a2845;
            border: 2px solid var(--blue);
            border-radius: var(--r-lg);
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }

        .session-code {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--blue);
            letter-spacing: 10px;
            font-family: monospace;
            margin: 15px 0;
        }

        .code-label {
            color: var(--muted);
            font-size: 0.9em;
        }

        .copy-btn {
            background: var(--blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-family: inherit;
            font-weight: 600;
        }

        .waiting-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #3a4565;
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .waiting-text {
            color: var(--muted);
            text-align: center;
        }

        .connected-check {
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            margin: 20px auto;
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .error-message {
            background: #3a1f2a;
            border: 1px solid var(--red);
            color: var(--red);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .lobby-back-btn {
            color: var(--muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            margin-bottom: 20px;
            padding: 0;
            font-family: inherit;
            font-weight: 600;
        }

        .lobby-back-btn:hover { color: white; }

        /* Game Board */
        .app {
            height: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: var(--pad);
            gap: var(--gap);
            position: relative;
            z-index: 1;
        }

        .board {
            flex: 1;
            min-height: 0;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: var(--gap);
        }

        .zone {
            border-radius: var(--r-lg);
            background: var(--panel);
            border: 1px solid #3a4565;
            box-shadow: var(--shadow-soft);
            padding: clamp(10px, 2vw, 14px);
            position: relative;
            min-height: 0;
        }

        .zoneTitle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
            color: var(--muted);
            font-weight: 800;
            font-size: 13px;
            padding-right: 6px;
        }

        .zoneTitle b { color: var(--text); }

        .zone.center {
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #222940;
        }

        .zone.opponent { overflow: hidden; }

        .zone.player {
            overflow: visible;
            padding-top: 12px;
            padding-bottom: 8px;
        }

        .zone.active {
            outline: 3px solid rgba(47,224,143,.40);
            outline-offset: 3px;
        }

        /* Turn Banner */
        .turnBanner {
            position: absolute;
            left: 50%;
            top: 10px;
            transform: translateX(-50%) rotate(-1.5deg);
            height: var(--banner-h);
            padding: 0 14px;
            border-radius: 18px;
            border: 2px solid #4a5578;
            background: #2a3252;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3;
            min-width: min(560px, 96%);
        }

        .turnDot {
            width: 14px;
            height: 14px;
            border-radius: 6px;
            background: var(--accent);
            box-shadow: 0 0 0 6px rgba(47,224,143,.16);
            flex: 0 0 auto;
        }

        .turnMain {
            display: flex;
            flex-direction: column;
            line-height: 1.05;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .turnText {
            font-weight: 900;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .turnSub {
            color: rgba(255,255,255,.78);
            font-weight: 700;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .turnBanner.opponentTurn .turnDot {
            background: var(--yellow);
            box-shadow: 0 0 0 6px rgba(255,209,102,.16);
        }

        /* Center Wrap */
        .centerWrap {
            width: min(720px, 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding-top: calc(var(--banner-h) + 10px);
            padding-left: var(--safe);
            padding-right: var(--safe);
        }

        .pilesRow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(12px, 3vw, 20px);
        }

        .pile {
            width: var(--pile-w);
            height: var(--pile-h);
            border-radius: var(--r-md);
            border: 2px solid #4a5578;
            box-shadow: var(--shadow-2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            background: #232a42;
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .pile:active { transform: scale(0.96); }

        .pile.draw {
            width: calc(var(--pile-w) * 1.12);
            height: calc(var(--pile-h) * 1.12);
            background: linear-gradient(180deg, #8B6B5A, #6B5A4A);
            border-color: #A67C5B;
        }

        .pile.draw.must-draw {
            border-color: var(--accent) !important;
            box-shadow: 0 0 20px rgba(47,224,143,.5);
            animation: drawPulse 1s ease-in-out infinite;
        }

        @keyframes drawPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pile.discard {
            background: linear-gradient(180deg, #2A4A3A, #232a42);
            border-color: #3A6A4A;
        }

        /* Discard pile with card colors - FULL OPACITY */
        .pile.discard.c-green { background: linear-gradient(180deg, #2FE08F, #15865C) !important; border-color: #58D68D !important; }
        .pile.discard.c-blue { background: linear-gradient(180deg, #4FA8FF, #2370BC) !important; border-color: #82B1FF !important; }
        .pile.discard.c-yellow { background: linear-gradient(180deg, #FFD166, #C48822) !important; border-color: #FFEA00 !important; }
        .pile.discard.c-red { background: linear-gradient(180deg, #FF5B5B, #BA3434) !important; border-color: #FF8A80 !important; }
        .pile.discard.c-wild { background: linear-gradient(180deg, #AB47BC, #7B1FA2) !important; border-color: #CE93D8 !important; }

        /* Pile face - NO rotation allowed */
        .pileFace {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-weight: 900;
            transform: none !important;
        }

        /* Top-left pile corner - upright, NO rotation */
        .pileCorner {
            position: absolute !important;
            top: 10px;
            left: 10px;
            font-size: 14px;
            font-weight: 900;
            color: rgba(255,255,255,.92);
            text-shadow: 0 2px 10px rgba(0,0,0,.18);
            transform: none !important;
        }

        /* Bottom-right pile corner - classic playing card: rotated 180deg */
        .pileCorner.bottom {
            top: auto !important;
            left: auto !important;
            bottom: 10px;
            right: 10px;
            transform: rotate(180deg) !important;
            transform-origin: center;
        }

        /* Center pile value - NO rotation allowed */
        .pileValue {
            font-size: clamp(28px, 4.2vw, 44px);
            text-shadow: 0 2px 10px rgba(0,0,0,.16);
            transform: none !important;
        }

        .pileLabel {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,.78);
            font-weight: 800;
            font-size: 12px;
            white-space: nowrap;
        }

        /* Active Color Indicator */
        .activeColorIndicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 6px 16px;
            border-radius: 20px;
            background: rgba(42, 50, 82, 0.8);
            border: 1px solid rgba(200,215,240,.15);
            margin: 8px auto 4px;
            width: fit-content;
        }

        .activeColorDot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,.3);
            transition: background 0.25s ease;
        }

        .activeColorDot.red { background: #FF5252; }
        .activeColorDot.blue { background: #42A5F5; }
        .activeColorDot.green { background: #5DDBD3; }
        .activeColorDot.yellow { background: #FFEE58; }

        .activeColorLabel {
            font-size: 12px;
            font-weight: 800;
            color: rgba(255,255,255,.85);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Hint Bar */
        .hintBar {
            width: min(660px, 100%);
            padding: 10px 12px;
            border-radius: 16px;
            border: 2px solid #3a4565;
            background: #252c45;
            color: rgba(255,255,255,.95);
            font-weight: 700;
            font-size: 13px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            box-shadow: var(--shadow-soft);
            position: relative;
            min-height: 50px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .hintBar.visible { opacity: 1; }

        .hintBar::before {
            content: "";
            position: absolute;
            top: -8px;
            left: 22px;
            width: 14px;
            height: 14px;
            background: #252c45;
            border-left: 2px solid #3a4565;
            border-top: 2px solid #3a4565;
            transform: rotate(45deg);
        }

        .hintIcon {
            width: 30px;
            height: 30px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: #2a3252;
            border: 2px solid #3a4565;
            flex: 0 0 auto;
        }

        .hintStrong {
            color: rgba(255,255,255,.95);
            font-weight: 900;
        }

        /* Active Effects */
        .effectsRow {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .effectBadge {
            background: #2a3252;
            border: 1px solid #4a5578;
            border-radius: 12px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .effectBadge.shield {
            border-color: var(--accent);
            color: var(--accent);
        }

        .effectBadge.locked {
            border-color: var(--red);
            color: var(--red);
        }

        /* Hands */
        .handStage {
            position: relative;
            overflow: visible;
            padding-top: 10px;
        }

        .hand {
            position: relative;
            height: calc(var(--card-h) + 22px);
            width: 100%;
            padding: 0;
            margin: 0;
            transform: none;
        }

        .hand .card {
            position: absolute;
            left: 0;
            bottom: 0;
            /* Only translateX for position and small rotation for fanning - NO flip transforms */
            transform: translateX(var(--x, 0px)) translateY(0) rotate(var(--rot, 0deg));
            transition: transform .12s ease, box-shadow .12s ease;
            will-change: transform;
        }

        .card {
            width: var(--card-w);
            height: var(--card-h);
            border-radius: var(--r-md);
            border: 2px solid #4a5578;
            box-shadow: var(--shadow-2);
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
            background: #2a3252;
            position: relative;
            /* Ensure no flip transforms - only positioning transforms allowed */
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            background:
                radial-gradient(circle at 18px 22px, rgba(255,255,255,.10), transparent 28%),
                radial-gradient(circle at 68px 88px, rgba(255,255,255,.08), transparent 32%);
            opacity: .55;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* Card face - container, NO transforms */
        .cardFace {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            font-weight: 900;
            color: rgba(255,255,255,.96);
            transform: none !important;
        }

        /* Top-left corner - upright, NO rotation */
        .corner {
            position: absolute !important;
            top: 10px;
            left: 10px;
            font-size: 14px;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,.14);
            transform: none !important;
        }

        /* Bottom-right corner - classic playing card: rotated 180deg */
        .corner.bottom {
            top: auto !important;
            left: auto !important;
            bottom: 10px;
            right: 10px;
            transform: rotate(180deg) !important;
            transform-origin: center;
        }

        /* Center value - upright, NO rotation */
        .value {
            font-size: clamp(28px, 4.4vw, 46px);
            text-shadow: 0 2px 10px rgba(0,0,0,.14);
            transform: none !important;
        }

        .cardEffectBadge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            font-weight: 900;
            color: rgba(255,255,255,.92);
            text-shadow: 0 2px 10px rgba(0,0,0,.12);
            opacity: .95;
        }

        .card:hover {
            z-index: 2;
            transform: translateX(var(--x, 0px)) translateY(-6px) rotate(var(--rot, 0deg));
        }

        .card.selected {
            z-index: 10;
            transform: translateX(var(--x, 0px)) translateY(-18px) rotate(var(--rot, 0deg));
            box-shadow:
                0 0 0 6px rgba(79,168,255,.12),
                0 20px 48px rgba(0,0,0,.32);
        }

        /* Playable cards - subtle green glow */
        .card.playable {
            box-shadow:
                0 0 0 2px rgba(47,224,143,.5),
                0 0 12px rgba(47,224,143,.3),
                var(--shadow-2);
        }

        .card.playable:hover {
            box-shadow:
                0 0 0 3px rgba(47,224,143,.6),
                0 0 18px rgba(47,224,143,.4),
                0 20px 48px rgba(0,0,0,.32);
        }

        .card.playable.selected {
            box-shadow:
                0 0 0 4px rgba(47,224,143,.7),
                0 0 24px rgba(47,224,143,.5),
                0 20px 48px rgba(0,0,0,.32);
        }

        /* Disabled cards - slightly dimmed but colors still readable */
        .card.disabled {
            cursor: not-allowed;
            filter: brightness(0.82);
        }

        /* Card Colors */
        /* Card Colors - FULL OPACITY for readability */
        .c-green { background: linear-gradient(180deg, #2FE08F, #15865C); }
        .c-blue { background: linear-gradient(180deg, #4FA8FF, #2370BC); }
        .c-yellow {
            background: linear-gradient(180deg, #FFD166, #C48822);
            color: #1A1630 !important;
        }
        .c-yellow .cardFace,
        .c-yellow .corner,
        .c-yellow .value { color: #1A1630 !important; }
        .c-red { background: linear-gradient(180deg, #FF5B5B, #BA3434); }
        .c-wild { background: linear-gradient(180deg, #AB47BC, #7B1FA2); }

        /* Opponent Hand */
        .opponentRow {
            display: flex;
            justify-content: center;
            gap: clamp(6px, 1.2vw, 10px);
            padding: 0 var(--safe);
        }

        .card.back {
            cursor: default;
            background: linear-gradient(180deg, #353d58, #252c45);
            border-color: #4a5578;
            width: clamp(52px, 11vw, 74px);
            height: calc(clamp(52px, 11vw, 74px) * 1.36);
        }

        .card.back::before {
            content: "";
            position: absolute;
            inset: 12px;
            border-radius: 12px;
            background:
                radial-gradient(circle at 14px 14px, #4FA8FF 3px, transparent 3.6px),
                radial-gradient(circle at 34px 26px, #FFD166 3px, transparent 3.6px),
                radial-gradient(circle at 54px 18px, #2FE08F 3px, transparent 3.6px);
            background-size: 60px 40px;
            opacity: .4;
        }

        .tip {
            text-align: center;
            color: rgba(255,255,255,.80);
            font-weight: 800;
            margin-top: 6px;
            font-size: 12px;
        }

        /* CINCO Button */
        .cinco-btn {
            position: fixed;
            bottom: 15px;
            bottom: calc(15px + env(safe-area-inset-bottom));
            right: 15px;
            right: calc(15px + env(safe-area-inset-right));
            width: 100px;
            height: 55px;
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 1px;
            cursor: pointer;
            z-index: 9999;
            border-radius: 14px;
            display: none;
            visibility: hidden;
            background: #4a4a5a;
            color: #9a9aaa;
            border: 3px solid #6a6a7a;
            box-shadow: 0 4px 12px rgba(0,0,0,.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .cinco-game.online-mode .cinco-btn {
            display: block;
            visibility: visible;
        }

        .cinco-game.online-mode .cinco-btn.clickable {
            background: linear-gradient(135deg, var(--red) 0%, #FF3838 100%);
            color: white;
            border: 3px solid #FF8A80;
            box-shadow: 0 6px 20px rgba(255,91,91,.5);
            cursor: pointer;
            animation: cincoShake 0.6s ease-in-out infinite;
        }

        .cinco-game.online-mode .cinco-btn.disabled {
            background: #4a4a5a;
            color: #9a9aaa;
            border: 3px solid #6a6a7a;
            cursor: not-allowed;
            animation: none;
        }

        .cinco-game.online-mode .cinco-btn.said {
            background: linear-gradient(135deg, var(--accent) 0%, #1EB980 100%);
            color: white;
            border: 3px solid #58D68D;
            box-shadow: 0 6px 16px rgba(47,224,143,.5);
            cursor: default;
            animation: none;
        }

        @keyframes cincoShake {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.15) rotate(0deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }

        /* Firewall Block Prompt */
        .firewall-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: rgba(15, 20, 25, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            padding: 20px;
        }

        .firewall-prompt.active { display: flex; }

        .firewall-prompt-content {
            background: #252D3D;
            border: 2px solid #FF7B9C;
            border-radius: var(--r-lg);
            padding: 28px 24px;
            box-shadow: 0 10px 40px rgba(255, 123, 156, 0.3);
            text-align: center;
            max-width: 320px;
            width: 90vw;
            animation: scaleIn 0.25s ease-out;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.85); }
            to { opacity: 1; transform: scale(1); }
        }

        .firewall-prompt-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .firewall-prompt-title {
            font-size: 20px;
            font-weight: 800;
            color: #FF7B9C;
            margin-bottom: 8px;
        }

        .firewall-prompt-desc {
            font-size: 14px;
            color: rgba(255,255,255,.70);
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .firewall-prompt-buttons {
            display: flex;
            gap: 12px;
        }

        .firewall-prompt-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: var(--r-md);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .firewall-prompt-btn:active {
            transform: scale(0.95);
        }

        .firewall-prompt-btn.block {
            background: linear-gradient(135deg, #5DDBD3, #2A9D96);
            color: #1E2430;
            box-shadow: 0 4px 15px rgba(93, 219, 211, 0.3);
        }

        .firewall-prompt-btn.accept {
            background: #2D364A;
            color: rgba(255,255,255,.70);
            border: 1px solid rgba(200,215,240,.18);
        }

        /* Draw Penalty Animation */
        .draw-penalty-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1500;
        }

        .draw-penalty-card {
            position: absolute;
            width: 50px;
            height: 72px;
            background: linear-gradient(135deg, #FF7B9C, #C9415E);
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,.3);
            box-shadow: 0 4px 15px rgba(255, 123, 156, 0.4);
            opacity: 0;
            z-index: 1510;
            transition: none;
        }

        .draw-penalty-card.animating {
            opacity: 1;
            transition: top 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        left 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        transform 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                        opacity 0.15s ease-in;
        }

        .draw-penalty-card.landing {
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }

        .draw-penalty-badge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FF7B9C, #C9415E);
            color: white;
            font-size: 32px;
            font-weight: 900;
            padding: 16px 32px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(255, 123, 156, 0.5);
            z-index: 1600;
            pointer-events: none;
            animation: penaltyBadgePop 1.8s ease-out forwards;
        }

        @keyframes penaltyBadgePop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            30% { transform: translate(-50%, -50%) scale(1); }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* Color Picker Modal */
        .cinco-color-picker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: rgba(15, 20, 25, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .cinco-color-picker.active { display: flex; }

        .cinco-color-picker-content {
            background: white;
            border-radius: var(--r-lg);
            padding: 24px;
            box-shadow: var(--shadow-2);
            text-align: center;
            max-width: 90vw;
            position: relative;
        }

        .cinco-color-picker-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(0,0,0,.1);
            border-radius: 50%;
            font-size: 24px;
            line-height: 1;
            color: rgba(255,255,255,.70);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cinco-color-picker-content h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            font-weight: 800;
            color: var(--bg-0);
        }

        .cinco-color-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .cinco-color-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .cinco-color-option:hover {
            transform: scale(1.1);
            border-color: white;
        }

        .cinco-color-option.red { background: linear-gradient(135deg, var(--red) 0%, #D50000 100%); border-color: #FF8A80; }
        .cinco-color-option.blue { background: linear-gradient(135deg, var(--blue) 0%, #1565C0 100%); border-color: #82B1FF; }
        .cinco-color-option.green { background: linear-gradient(135deg, var(--accent) 0%, #00C853 100%); border-color: #69F0AE; }
        .cinco-color-option.yellow { background: linear-gradient(135deg, var(--yellow) 0%, #FFA000 100%); border-color: #FFEA00; }

        .cinco-color-option.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .cinco-color-option.locked::after {
            content: "\1F512";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
        }

        .cinco-color-option.locked:hover {
            transform: none;
            border-color: transparent;
        }

        /* Game Over Screen */
        .cinco-game-over {
            text-align: center;
            max-width: 400px;
            padding: 20px;
        }

        .cinco-result-emoji {
            font-size: 100px;
            margin-bottom: 20px;
        }

        .cinco-result-message {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 12px;
            color: white;
        }

        .cinco-result-details {
            font-size: 16px;
            color: var(--muted);
            margin-bottom: 30px;
        }

        .cinco-result-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Action Banner */
        .cinco-action-banner {
            position: fixed;
            top: 60px;
            right: 20px;
            background: var(--panel);
            border: 1px solid var(--panel-edge);
            border-radius: var(--r-md);
            padding: 12px 16px;
            box-shadow: var(--shadow-2);
            z-index: 999;
            max-width: 250px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cinco-action-banner.show {
            opacity: 1;
            transform: translateX(0);
        }

        .cinco-action-banner .banner-icon { font-size: 24px; margin-bottom: 6px; }
        .cinco-action-banner .banner-title { font-size: 13px; font-weight: 700; color: white; margin-bottom: 4px; }
        .cinco-action-banner .banner-description { font-size: 11px; color: var(--muted); line-height: 1.3; }
        .cinco-action-banner.attack { border-left: 4px solid var(--red); background: #3a1f2a; }
        .cinco-action-banner.defense { border-left: 4px solid var(--accent); background: #1f3a2a; }
        .cinco-action-banner.wild { border-left: 4px solid #AB47BC; background: #2a1f3a; }
        .cinco-action-banner.special { border-left: 4px solid var(--blue); background: #1f2a3a; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .cinco-action-banner {
                top: 10px;
                right: auto;
                left: 10px;
                max-width: 180px;
                padding: 8px 10px;
            }
        }

        @media (max-width: 360px) {
            .card.back {
                width: 40px;
                height: 54px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="cinco-game" data-testid="cinco-root">
        <!-- Mode Selection Screen -->
        <div class="cinco-screen active" id="modeScreen">
            <div class="cinco-mode-selection">
                <a href="../index.html" class="back-link" data-testid="back-to-hub">&larr; Back to Games</a>
                <h1 class="cinco-title">CINCO</h1>
                <p class="cinco-subtitle">Strategic Card Combat</p>

                <div class="cinco-mode-buttons">
                    <button class="cinco-mode-btn" id="aiModeBtn">
                        <span style="font-size: 1.5em;">&#129302;</span><br>
                        Play vs AI
                    </button>
                    <button class="cinco-mode-btn" id="localModeBtn">
                        <span style="font-size: 1.5em;">&#128101;</span><br>
                        Pass & Play
                    </button>
                    <button class="cinco-mode-btn" id="onlineModeBtn">
                        <span style="font-size: 1.5em;">&#127760;</span><br>
                        Play Online
                    </button>
                </div>
            </div>
        </div>

        <!-- Online Lobby Screen -->
        <div class="cinco-screen" id="onlineLobbyScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="lobbyBackBtn">&larr; Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 10px;">&#127760; Play Online</h2>
                <p style="color: var(--muted); text-align: center; margin-bottom: 20px;">Play with a friend remotely</p>

                <div class="lobby-options">
                    <div class="lobby-card" id="createGameCard">
                        <div class="lobby-icon">&#10133;</div>
                        <h3>Create Game</h3>
                        <p>Start a new game and share the code</p>
                    </div>

                    <div class="lobby-card" id="joinGameCard">
                        <div class="lobby-icon">&#128279;</div>
                        <h3>Join Game</h3>
                        <p>Enter a code to join your friend</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Game Screen -->
        <div class="cinco-screen" id="createGameScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="createBackBtn">&larr; Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 25px;">Create Game</h2>

                <div class="lobby-input-group">
                    <label>Your Name</label>
                    <input type="text" class="lobby-input" id="createNameInput" placeholder="Enter your name" maxlength="20">
                </div>

                <button class="lobby-btn lobby-btn-primary" id="createGameBtn">Create Game</button>
            </div>
        </div>

        <!-- Waiting Room Screen -->
        <div class="cinco-screen" id="waitingRoomScreen">
            <div class="cinco-lobby">
                <h2 style="color: white; text-align: center;">Waiting for Player 2</h2>

                <div class="session-code-display">
                    <div class="code-label">Share this code with your friend:</div>
                    <div class="session-code" id="sessionCodeDisplay">------</div>
                    <button class="copy-btn" id="copyCodeBtn">&#128203; Copy Code</button>
                </div>

                <div class="waiting-spinner"></div>
                <p class="waiting-text">Waiting for someone to join...</p>

                <button class="lobby-btn lobby-btn-danger" id="cancelSessionBtn">Cancel</button>
            </div>
        </div>

        <!-- Join Game Screen -->
        <div class="cinco-screen" id="joinGameScreen">
            <div class="cinco-lobby">
                <button class="lobby-back-btn" id="joinBackBtn">&larr; Back</button>
                <h2 style="color: white; text-align: center; margin-bottom: 25px;">Join Game</h2>

                <div id="joinError" class="error-message" style="display: none;"></div>

                <div class="lobby-input-group">
                    <label>Your Name</label>
                    <input type="text" class="lobby-input" id="joinNameInput" placeholder="Enter your name" maxlength="20">
                </div>

                <div class="lobby-input-group">
                    <label>Game Code</label>
                    <input type="text" class="lobby-input code-input" id="joinCodeInput" placeholder="------" maxlength="6">
                </div>

                <button class="lobby-btn lobby-btn-primary" id="joinGameBtn">Join Game</button>
            </div>
        </div>

        <!-- Connecting Screen -->
        <div class="cinco-screen" id="connectingScreen">
            <div class="cinco-lobby" style="text-align: center;">
                <div class="connected-check">&#10003;</div>
                <h2 style="color: white;">Connected!</h2>
                <p style="color: var(--muted); font-size: 1.1em;">
                    Playing with <strong id="connectedPartnerName">Partner</strong>
                </p>
                <p class="waiting-text" id="connectingStatusText">Starting game...</p>
                <div class="waiting-spinner" id="connectingSpinner" style="display: none;"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="cinco-screen" id="gameScreen">
            <main class="app" data-testid="cinco-table">
                <section class="board">
                    <!-- Opponent Zone -->
                    <div class="zone opponent" data-testid="cinco-opponent-zone">
                        <div class="zoneTitle"><b id="opponentName">Opponent</b><span><span id="opponentCardCount">7</span> cards</span></div>
                        <div class="opponentRow" id="opponentHand" data-testid="cinco-opponent-hand"></div>
                    </div>

                    <!-- Center Zone -->
                    <div class="zone center" data-testid="cinco-center">
                        <div class="turnBanner" id="turnBanner" data-testid="cinco-turn-banner" aria-live="polite">
                            <span class="turnDot" aria-hidden="true"></span>
                            <div class="turnMain">
                                <div class="turnText" id="turnText">Your Turn</div>
                                <div class="turnSub" id="turnSub">Tap once to select, tap again to play</div>
                            </div>
                        </div>

                        <div class="centerWrap">
                            <div class="pilesRow">
                                <div class="pile draw" id="drawPile" data-testid="cinco-draw-pile">
                                    <div class="pileFace">
                                        <div class="pileCorner">Draw</div>
                                        <div class="pileCorner bottom">Draw</div>
                                        <div class="pileValue">&#127922;</div>
                                    </div>
                                    <div class="pileLabel">Draw pile</div>
                                </div>

                                <div class="pile discard" id="discardPile" data-testid="cinco-discard-pile">
                                    <div class="pileFace">
                                        <div class="pileCorner" id="discardCornerTop"></div>
                                        <div class="pileCorner bottom" id="discardCornerBottom"></div>
                                        <div class="pileValue" id="discardValue"></div>
                                    </div>
                                    <div class="pileLabel">Discard</div>
                                </div>
                            </div>

                            <div class="activeColorIndicator" id="activeColorIndicator">
                                <div class="activeColorDot" id="activeColorDot"></div>
                                <span class="activeColorLabel" id="activeColorLabel">Red</span>
                            </div>

                            <div class="hintBar" id="cincoHint" data-testid="cinco-hint">
                                <div class="hintIcon" aria-hidden="true">&#128172;</div>
                                <div id="hintText"><span class="hintStrong">Card effect:</span> Select a card to see what it does.</div>
                            </div>

                            <div class="effectsRow" id="activeEffects"></div>
                        </div>
                    </div>

                    <!-- Player Zone -->
                    <div class="zone player" id="playerZone" data-testid="cinco-player-zone">
                        <div class="zoneTitle"><b id="playerName">You</b><span><span id="playerCardCount">7</span> cards</span></div>

                        <div class="handStage">
                            <div class="hand" id="playerHand" data-testid="cinco-player-hand"></div>
                            <div class="tip">Tip: Tap once to select, tap again to play.</div>
                        </div>
                    </div>
                </section>
            </main>

            <!-- Action Banner -->
            <div class="cinco-action-banner" id="actionBanner">
                <div class="banner-icon" id="bannerIcon"></div>
                <div class="banner-title" id="bannerTitle"></div>
                <div class="banner-description" id="bannerDescription"></div>
            </div>

            <button class="cinco-btn" id="cincoBtn">CINCO!</button>
        </div>

        <!-- Game Over Screen -->
        <div class="cinco-screen" id="gameOverScreen">
            <div class="cinco-game-over">
                <div class="cinco-result-emoji" id="resultEmoji">&#127942;</div>
                <div class="cinco-result-message" id="resultMessage">You Win!</div>
                <div class="cinco-result-details" id="resultDetails"></div>

                <div class="cinco-result-actions">
                    <button class="cinco-mode-btn" id="playAgainBtn">Play Again</button>
                    <button class="cinco-mode-btn" style="background: rgba(255,246,232,.05);" onclick="location.href='../index.html'">
                        Back to Games
                    </button>
                </div>
            </div>
        </div>

        <!-- Firewall Block Prompt -->
        <div class="firewall-prompt" id="firewallPrompt">
            <div class="firewall-prompt-content">
                <div class="firewall-prompt-icon">&#128737;</div>
                <div class="firewall-prompt-title" id="firewallPromptTitle">Incoming Attack!</div>
                <div class="firewall-prompt-desc" id="firewallPromptDesc">You have a Firewall card. Block this attack?</div>
                <div class="firewall-prompt-buttons">
                    <button class="firewall-prompt-btn block" id="firewallBlockBtn">Block &#128737;</button>
                    <button class="firewall-prompt-btn accept" id="firewallAcceptBtn">Take It</button>
                </div>
            </div>
        </div>

        <!-- Draw Penalty Animation Overlay -->
        <div class="draw-penalty-overlay" id="drawPenaltyOverlay"></div>

        <!-- Color Picker Modal -->
        <div class="cinco-color-picker" id="colorPicker" data-testid="cinco-color-picker">
            <div class="cinco-color-picker-content">
                <button class="cinco-color-picker-close" id="colorPickerClose" data-testid="cinco-color-picker-close">&times;</button>
                <h3>Choose a Color</h3>
                <div class="cinco-color-options">
                    <div class="cinco-color-option red" data-color="red"></div>
                    <div class="cinco-color-option blue" data-color="blue"></div>
                    <div class="cinco-color-option green" data-color="green"></div>
                    <div class="cinco-color-option yellow" data-color="yellow"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import CincoGame from '../js/cinco-game.js';
        import CincoOnline from '../js/cinco-online.js';
        import { MultiplayerSession } from '../js/multiplayer.js';

        // Notification function (standalone)
        function showNotification(type, message) {
            console.log(`[${type}] ${message}`);
            // Could add toast notifications here
        }

        // Global state
        let gameMode = null;
        let game = null;
        let onlineGame = null;
        let multiplayerSession = null;
        let gameStartTime = null;
        let colorSelectionCallback = null;
        let longPressTimer = null;
        let opponentName = 'Opponent';
        let selectedCardIndex = null;
        let pendingWildCard = null;

        // Prevent accidental scrolling on mobile
        document.addEventListener("touchmove", (e) => {
            if (!e.target.closest('.lobby-input')) {
                e.preventDefault();
            }
        }, { passive: false });

        // iOS viewport fix
        function setVh() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVh();
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', setVh);

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.cinco-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
        }

        // Mode selection handlers
        document.getElementById('aiModeBtn').addEventListener('click', () => startGame('ai'));
        document.getElementById('localModeBtn').addEventListener('click', () => startGame('local'));
        document.getElementById('onlineModeBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));

        document.getElementById('playAgainBtn').addEventListener('click', () => {
            showScreen('modeScreen');
            game = null;
            onlineGame = null;
            multiplayerSession = null;
            selectedCardIndex = null;
            document.querySelector('.cinco-game').classList.remove('online-mode');
        });

        // Online lobby navigation
        document.getElementById('lobbyBackBtn').addEventListener('click', () => showScreen('modeScreen'));
        document.getElementById('createGameCard').addEventListener('click', () => showScreen('createGameScreen'));
        document.getElementById('joinGameCard').addEventListener('click', () => showScreen('joinGameScreen'));
        document.getElementById('createBackBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));
        document.getElementById('joinBackBtn').addEventListener('click', () => showScreen('onlineLobbyScreen'));

        // Create game
        document.getElementById('createGameBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('createNameInput').value.trim() || 'Player 1';

            try {
                multiplayerSession = new MultiplayerSession('cinco');
                const result = await multiplayerSession.createSession(playerName);

                if (result.success) {
                    document.getElementById('sessionCodeDisplay').textContent = result.sessionId;
                    showScreen('waitingRoomScreen');

                    multiplayerSession.on('onPlayerJoined', (partnerName) => {
                        opponentName = partnerName;
                        document.getElementById('connectedPartnerName').textContent = partnerName;
                        showScreen('connectingScreen');
                        setTimeout(() => startOnlineGame(true, playerName), 1500);
                    });
                } else {
                    showNotification('error', 'Failed to create game');
                }
            } catch (error) {
                console.error('Create game error:', error);
                showNotification('error', 'Failed to create game');
            }
        });

        // Copy code
        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            const code = document.getElementById('sessionCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('success', 'Code copied!');
            });
        });

        // Cancel session
        document.getElementById('cancelSessionBtn').addEventListener('click', () => {
            if (multiplayerSession) {
                multiplayerSession.disconnect();
                multiplayerSession = null;
            }
            showScreen('onlineLobbyScreen');
        });

        // Join game
        document.getElementById('joinGameBtn').addEventListener('click', async () => {
            const playerName = document.getElementById('joinNameInput').value.trim() || 'Player 2';
            const sessionCode = document.getElementById('joinCodeInput').value.trim().toUpperCase();
            const errorEl = document.getElementById('joinError');

            if (!sessionCode || sessionCode.length !== 6) {
                errorEl.textContent = 'Please enter a valid 6-character code';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';

            try {
                multiplayerSession = new MultiplayerSession('cinco');
                const result = await multiplayerSession.joinSession(sessionCode, playerName);

                if (result.success) {
                    opponentName = result.opponentName || 'Player 1';
                    document.getElementById('connectedPartnerName').textContent = opponentName;
                    showScreen('connectingScreen');
                    setTimeout(() => startOnlineGame(false, playerName), 1500);
                } else {
                    errorEl.textContent = result.error || 'Failed to join game';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Join game error:', error);
                errorEl.textContent = 'Failed to join game. Check the code and try again.';
                errorEl.style.display = 'block';
            }
        });

        // Start online game
        async function startOnlineGame(isHost, playerName) {
            gameMode = 'online';
            gameStartTime = Date.now();

            const playerRole = isHost ? 'player1' : 'player2';

            onlineGame = new CincoOnline(multiplayerSession, playerRole, {
                onStateUpdate: handleOnlineStateUpdate,
                onOpponentAction: handleOpponentAction,
                onGameOver: handleGameOver,
                onHandUpdate: handleHandUpdate,
                onDeckUpdate: handleDeckUpdate
            });

            game = new CincoGame('online', {
                onStateChange: handleOnlineStateChange,
                requestColorSelection: requestColorSelection,
                requestFirewallBlock: requestFirewallBlock,
                playAnimation: playAnimation,
                showNotification: showNotification,
                gameOver: handleGameOver,
                onPenaltyDraw: showDrawPenaltyAnimation
            });

            multiplayerSession.on('onGameStateChange', (state) => {
                if (state) handleOnlineStateUpdate(state);
            });

            multiplayerSession.on('onOpponentDisconnect', () => {
                showNotification('warning', 'Opponent disconnected');
            });

            let p2OpponentCardCount = 7; // default fallback
            if (isHost) {
                game.startGame();
                await onlineGame.initializeGame(game.getState());
            } else {
                // Show loading state while P2 waits for host data
                const statusText = document.getElementById('connectingStatusText');
                const spinner = document.getElementById('connectingSpinner');
                if (statusText) statusText.textContent = 'Waiting for game data...';
                if (spinner) spinner.style.display = 'block';

                // P2: join and fetch hand + game state from Firebase
                // joinGame() now uses listeners and waits up to 15s for data
                const { hand, gameState, deck } = await onlineGame.joinGame();

                // Store opponent card count for initial render
                const opRole = playerRole === 'player1' ? 'player2' : 'player1';
                p2OpponentCardCount = gameState?.players?.[opRole]?.cardCount || 7;

                // Initialize P2's local game state from Firebase
                if (gameState) {
                    game.discardPile = gameState.discardPile || [];
                    game.currentColor = gameState.currentColor;
                    game.currentValue = gameState.currentValue;
                    // Translate turn perspective: Firebase uses P1's perspective
                    // P2 must flip 'player''opponent' so local game logic works
                    const rawTurn = gameState.currentTurn;
                    game.currentTurn = (playerRole === 'player2')
                        ? (rawTurn === 'player' ? 'opponent' : 'player')
                        : rawTurn;
                    game.direction = gameState.direction || 1;
                    game.activeEffects = gameState.activeEffects || {};
                    game.activeEffects.firewall = game.activeEffects.firewall || { player: false, opponent: false };
                }

                if (hand && hand.length > 0) {
                    game.playerHand = hand;
                }

                // Set the shared deck so P2 can draw cards
                if (deck && deck.length > 0) {
                    game.deck = deck;
                }

                // Hide loading indicators
                if (statusText) statusText.textContent = 'Starting game...';
                if (spinner) spinner.style.display = 'none';
            }

            document.getElementById('opponentName').textContent = opponentName;
            document.getElementById('playerName').textContent = playerName;

            showScreen('gameScreen');
            document.querySelector('.cinco-game').classList.add('online-mode');

            // Re-layout cards after screen is visible (fix for initial positioning)
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    if (game) {
                        if (gameMode === 'online' && !isHost) {
                            // P2: use online-aware UI update with correct perspective
                            // game.currentTurn is already translated to local perspective
                            const isMyTurn = game.currentTurn === 'player';
                            renderPlayerHand(game.playerHand || [], isMyTurn);
                            const opponentCount = p2OpponentCardCount;
                            renderOpponentHand(opponentCount);
                            if (game.discardPile && game.discardPile.length > 0) {
                                renderDiscardPile(game.discardPile[game.discardPile.length - 1]);
                            }
                            // Update turn banner
                            const turnBanner = document.getElementById('turnBanner');
                            const turnText = document.getElementById('turnText');
                            const turnSub = document.getElementById('turnSub');
                            const playerZone = document.getElementById('playerZone');
                            if (isMyTurn) {
                                turnBanner.classList.remove('opponentTurn');
                                turnText.textContent = 'Your Turn';
                                turnSub.textContent = 'Tap once to select, tap again to play';
                                playerZone.classList.add('active');
                            } else {
                                turnBanner.classList.add('opponentTurn');
                                turnText.textContent = "Opponent's Turn";
                                turnSub.textContent = "They're playing... get ready!";
                                playerZone.classList.remove('active');
                            }
                            renderActiveEffects(game.activeEffects);
                            document.getElementById('playerCardCount').textContent = game.playerHand?.length || 0;
                            document.getElementById('opponentCardCount').textContent = opponentCount;
                        } else {
                            updateUI(game.getState());
                        }
                    }
                });
            });
        }

        // Translate game state turn to Firebase (P1) perspective before syncing
        function getStateForFirebase() {
            const state = game.getState();
            if (onlineGame && onlineGame.playerRole === 'player2') {
                // P2's local 'player'/'opponent' is flipped from P1's perspective
                state.currentTurn = state.currentTurn === 'player' ? 'opponent' : 'player';
            }
            return state;
        }

        // Start local/AI game
        async function startGame(mode) {
            gameMode = mode;
            gameStartTime = Date.now();

            game = new CincoGame(mode, {
                onStateChange: updateUI,
                requestColorSelection: requestColorSelection,
                requestFirewallBlock: requestFirewallBlock,
                playAnimation: playAnimation,
                showNotification: showNotification,
                gameOver: handleGameOver,
                onPenaltyDraw: showDrawPenaltyAnimation
            });

            game.startGame();
            showScreen('gameScreen');

            if (mode === 'ai') {
                document.getElementById('opponentName').innerHTML = '&#129302; AI';
            } else if (mode === 'local') {
                document.getElementById('opponentName').textContent = 'Player 2';
            }

            // Re-layout cards after screen is visible (fix for initial positioning)
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    updateUI(game.getState());
                });
            });
        }

        // Handle online state change
        async function handleOnlineStateChange(state) {
            updateUI(state);
        }

        // Handle online state update
        function handleOnlineStateUpdate(state) {
            updateUIFromOnlineState(state);
        }

        // Handle opponent action
        function handleOpponentAction(action) {
            if (action.type === 'play_card') {
                playAnimation(action.card.value, 'opponent');
            } else if (action.type === 'say_cinco') {
                showNotification('warning', 'Opponent said CINCO!');
            }
        }

        // Handle hand update
        function handleHandUpdate(hand) {
            if (game && hand && hand.length > 0) {
                game.playerHand = hand;
                if (gameMode === 'online' && onlineGame) {
                    // Determine if it's our turn based on the current game state
                    const isMyTurn = game.currentTurn === 'player';
                    renderPlayerHand(hand, isMyTurn);
                    document.getElementById('playerCardCount').textContent = hand.length;
                } else {
                    updateUI(game.getState());
                }
            }
        }

        // Handle deck update from Firebase
        function handleDeckUpdate(deck) {
            if (game && deck) {
                game.deck = deck;
            }
        }

        // Update UI
        function updateUI(state) {
            document.getElementById('playerCardCount').textContent = state.playerCardCount || state.playerHand?.length || 0;
            document.getElementById('opponentCardCount').textContent = state.opponentCardCount || state.opponentHand?.length || 0;

            const turnBanner = document.getElementById('turnBanner');
            const turnText = document.getElementById('turnText');
            const turnSub = document.getElementById('turnSub');
            const playerZone = document.getElementById('playerZone');

            if (state.currentTurn === 'player') {
                turnBanner.classList.remove('opponentTurn');
                turnText.textContent = 'Your Turn';
                turnSub.textContent = 'Tap once to select, tap again to play';
                playerZone.classList.add('active');
            } else {
                turnBanner.classList.add('opponentTurn');
                turnText.textContent = state.aiThinking ? 'AI Thinking...' : "Opponent's Turn";
                turnSub.textContent = "They're playing... get ready!";
                playerZone.classList.remove('active');
            }

            renderPlayerHand(state.playerHand || [], state.currentTurn === 'player');
            renderOpponentHand(state.opponentCardCount || state.opponentHand?.length || 0);

            if (state.discardPile && state.discardPile.length > 0) {
                renderDiscardPile(state.discardPile[state.discardPile.length - 1]);
            }

            renderActiveEffects(state.activeEffects);
            updateActiveColor(state.currentColor);

            const drawPile = document.getElementById('drawPile');
            if (state.currentTurn === 'player' && game) {
                const hasPlayableCard = (state.playerHand || []).some(card => game.isCardPlayable(card));
                drawPile.classList.toggle('must-draw', !hasPlayableCard);
            } else {
                drawPile.classList.remove('must-draw');
            }

            updateCincoButtonState(state);
        }

        // Update UI from online state
        function updateUIFromOnlineState(state) {
            document.getElementById('playerCardCount').textContent = state.playerCardCount || 0;
            document.getElementById('opponentCardCount').textContent = state.opponentCardCount || 0;

            const turnBanner = document.getElementById('turnBanner');
            const turnText = document.getElementById('turnText');
            const turnSub = document.getElementById('turnSub');
            const playerZone = document.getElementById('playerZone');
            const myRole = onlineGame?.playerRole || 'player1';
            const isMyTurn = state.currentTurn === (myRole === 'player1' ? 'player' : 'opponent');

            if (isMyTurn) {
                turnBanner.classList.remove('opponentTurn');
                turnText.textContent = 'Your Turn';
                turnSub.textContent = 'Tap once to select, tap again to play';
                playerZone.classList.add('active');
            } else {
                turnBanner.classList.add('opponentTurn');
                turnText.textContent = "Opponent's Turn";
                turnSub.textContent = "They're playing... get ready!";
                playerZone.classList.remove('active');
            }

            if (game) {
                game.currentColor = state.currentColor;
                game.currentValue = state.currentValue;
                game.activeEffects = state.activeEffects || {};
                game.activeEffects.firewall = game.activeEffects.firewall || { player: false, opponent: false };
                // colorLock can be null (no lock) or { color, roundsLeft }
                game.discardPile = state.discardPile || [];
                // Translate turn perspective so game logic works for both players
                game.currentTurn = isMyTurn ? 'player' : 'opponent';
            }

            if (game && game.playerHand && game.playerHand.length > 0) {
                renderPlayerHand(game.playerHand, isMyTurn);
            }

            renderOpponentHand(state.opponentCardCount);
            if (state.discardPile && state.discardPile.length > 0) {
                renderDiscardPile(state.discardPile[state.discardPile.length - 1]);
            }
            renderActiveEffects(state.activeEffects);
            updateActiveColor(state.currentColor);
            updateCincoButtonState(state);
        }

        // Render player hand with fan layout
        function renderPlayerHand(hand, canPlay) {
            const container = document.getElementById('playerHand');
            container.innerHTML = '';

            if (!hand || hand.length === 0) return;

            const n = hand.length;
            const containerRect = container.getBoundingClientRect();
            const safeVal = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe')) || 12;
            const cardW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w')) || 80;
            const available = Math.max(0, containerRect.width - (safeVal * 2));

            let startX, step;
            if (n === 1) {
                startX = safeVal + (available - cardW) / 2;
                step = 0;
            } else {
                const maxStep = (available - cardW) / (n - 1);
                step = Math.max(10, Math.min(maxStep, cardW * 0.62));
                const total = cardW + step * (n - 1);
                startX = safeVal + (available - total) / 2;
            }

            const maxRot = 8; // Clamped to +/-8 degrees max
            const mid = (n - 1) / 2;

            hand.forEach((card, index) => {
                const playable = canPlay && game?.isCardPlayable(card);
                const selected = index === selectedCardIndex;
                const x = startX + (step * index);
                // Clamp rotation to +/-8 degrees
                const rawRot = n > 1 ? ((index - mid) / mid) * maxRot * 0.5 : 0;
                const rot = Math.max(-8, Math.min(8, rawRot));

                const colorClass = card.color === 'wild' ? 'c-wild' : `c-${card.color}`;
                const display = CincoGame.getCardDisplay(card.value);

                const cardEl = document.createElement('div');
                cardEl.className = `card ${colorClass} ${playable ? 'playable' : 'disabled'} ${selected ? 'selected' : ''}`;
                cardEl.dataset.index = index;
                cardEl.dataset.value = card.value;
                cardEl.style.setProperty('--x', `${x}px`);
                cardEl.style.setProperty('--rot', `${isFinite(rot) ? rot : 0}deg`);

                cardEl.innerHTML = `
                    <div class="cardFace">
                        <div class="corner">${display}</div>
                        <div class="corner bottom">${display}</div>
                        <div class="value">${display}</div>
                    </div>
                `;

                cardEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleCardTap(index);
                });

                cardEl.addEventListener('touchstart', (e) => {
                    longPressTimer = setTimeout(() => {
                        showCardDescription(card.value, e.touches[0].clientX, e.touches[0].clientY);
                    }, 500);
                });

                cardEl.addEventListener('touchend', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    hideCardDescription();
                });

                container.appendChild(cardEl);
            });
        }

        // Render opponent hand
        function renderOpponentHand(count) {
            const container = document.getElementById('opponentHand');
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const card = document.createElement('div');
                card.className = 'card back';
                card.setAttribute('aria-hidden', 'true');
                container.appendChild(card);
            }
        }

        // Render discard pile
        function renderDiscardPile(card) {
            const discardPile = document.getElementById('discardPile');
            const display = CincoGame.getCardDisplay(card.value);
            const colorClass = card.color === 'wild' ? 'c-wild' : `c-${card.color}`;

            discardPile.className = `pile discard ${colorClass}`;
            document.getElementById('discardCornerTop').textContent = display;
            document.getElementById('discardCornerBottom').textContent = display;
            document.getElementById('discardValue').textContent = display;
        }

        // Update active color indicator
        function updateActiveColor(color) {
            const dot = document.getElementById('activeColorDot');
            const label = document.getElementById('activeColorLabel');
            if (!dot || !label || !color) return;
            dot.className = `activeColorDot ${color}`;
            label.textContent = color;
        }

        // Render active effects
        function renderActiveEffects(effects) {
            const container = document.getElementById('activeEffects');
            const badges = [];

            if (effects?.colorLock && effects.colorLock.roundsLeft > 0) {
                const colorEmojis = { red: '&#128308;', blue: '&#128309;', green: '&#128994;', yellow: '&#128993;' };
                const c = effects.colorLock.color;
                badges.push(`<div class="effectBadge locked">&#128274; ${colorEmojis[c] || ''} ${c.toUpperCase()} only (${effects.colorLock.roundsLeft} rounds)</div>`);
            }

            container.innerHTML = badges.join('');
        }

        // Handle card tap - TWO-TAP SYSTEM
        async function handleCardTap(index) {
            if (!game) return;

            const state = game.getState();
            const card = state.playerHand?.[index];
            if (!card) return;

            if (state.currentTurn !== 'player') return;

            const isPlayable = game.isCardPlayable(card);

            if (selectedCardIndex === index) {
                if (isPlayable) {
                    const success = game.playCard(index);
                    if (success && gameMode === 'online' && onlineGame) {
                        await onlineGame.playCard(game.discardPile[game.discardPile.length - 1], getStateForFirebase());
                        // Sync deck and opponent hand in case card effects caused draws
                        await onlineGame.updateSharedDeck(game.deck);
                        await onlineGame.updateOpponentHand(game.opponentHand);
                    }
                    selectedCardIndex = null;
                    updateHint(null);
                } else {
                    selectedCardIndex = null;
                    updateHint(null);
                    updateUI(game.getState());
                }
            } else {
                selectedCardIndex = index;
                updateHint(card.value);
                updateUI(game.getState());
            }
        }

        // Deselect when tapping elsewhere
        document.addEventListener('click', (e) => {
            if (selectedCardIndex !== null && !e.target.closest('.card') && !e.target.closest('.pile.draw')) {
                selectedCardIndex = null;
                updateHint(null);
                if (game) updateUI(game.getState());
            }
        });

        // Update hint text
        function updateHint(value) {
            const hintBar = document.getElementById('cincoHint');
            const hintText = document.getElementById('hintText');
            if (!hintBar || !hintText) return;

            if (value) {
                const desc = CincoGame.getCardDescription(value);
                if (desc) {
                    hintText.innerHTML = `<span class="hintStrong">Card effect:</span> ${desc}`;
                    hintBar.classList.add('visible');
                } else {
                    hintBar.classList.remove('visible');
                }
            } else {
                hintBar.classList.remove('visible');
            }
        }

        // Draw pile click
        document.getElementById('drawPile').addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!game) return;

            selectedCardIndex = null;
            const success = game.drawCard();
            if (success && gameMode === 'online' && onlineGame) {
                await onlineGame.drawCard(getStateForFirebase());
                // Sync the deck after drawing so both players share the same deck
                await onlineGame.updateSharedDeck(game.deck);
            }
        });

        // CINCO button state
        function updateCincoButtonState(state) {
            const cincoBtn = document.getElementById('cincoBtn');

            if (gameMode !== 'online') {
                cincoBtn.classList.remove('clickable', 'disabled', 'said');
                return;
            }

            const playerCards = state.playerCardCount || state.playerHand?.length || 0;
            cincoBtn.classList.remove('clickable', 'disabled', 'said');

            if (state.playerSaidCinco) {
                cincoBtn.classList.add('said');
                cincoBtn.textContent = ' CINCO!';
            } else if (playerCards === 1) {
                cincoBtn.classList.add('clickable');
                cincoBtn.textContent = 'CINCO!';
            } else {
                cincoBtn.classList.add('disabled');
                cincoBtn.textContent = 'CINCO!';
            }
        }

        // Cinco button click
        document.getElementById('cincoBtn').addEventListener('click', async () => {
            if (!game || gameMode !== 'online') return;

            const playerCards = game.playerHand?.length || 0;
            const cincoBtn = document.getElementById('cincoBtn');

            if (playerCards === 1 && !game.playerSaidCinco) {
                const success = game.sayCinco();
                if (success) {
                    cincoBtn.classList.remove('clickable');
                    cincoBtn.classList.add('said');
                    cincoBtn.textContent = ' CINCO!';
                    showNotification('success', 'CINCO!');

                    if (onlineGame) {
                        await onlineGame.sayCinco();
                    }
                }
            } else if (playerCards !== 1) {
                showNotification('error', 'Wrong! Draw 2 penalty!');
                game.drawCard();
                game.drawCard();
                updateUI(game.getState());
            }
        });

        // Color selection
        function requestColorSelection(callback) {
            colorSelectionCallback = callback;

            if (game?.discardPile?.length > 0) {
                pendingWildCard = game.discardPile[game.discardPile.length - 1];
            }

            // Wild cards break color lock, so all colors are available
            document.querySelectorAll('.cinco-color-option').forEach(option => {
                option.classList.remove('locked');
                option.disabled = false;
            });

            document.getElementById('colorPicker').classList.add('active');
        }

        document.querySelectorAll('.cinco-color-option').forEach(option => {
            option.addEventListener('click', () => {
                if (option.disabled || option.classList.contains('locked')) return;

                const color = option.dataset.color;
                document.getElementById('colorPicker').classList.remove('active');
                if (colorSelectionCallback) {
                    colorSelectionCallback(color);
                    colorSelectionCallback = null;
                }
                pendingWildCard = null;
            });
        });

        document.getElementById('colorPickerClose').addEventListener('click', (e) => {
            e.stopPropagation();
            cancelColorPicker();
        });

        document.getElementById('colorPicker').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                cancelColorPicker();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('colorPicker').classList.contains('active')) {
                cancelColorPicker();
            }
        });

        function cancelColorPicker() {
            document.getElementById('colorPicker').classList.remove('active');
            if (pendingWildCard && game) {
                game.playerHand.push(pendingWildCard);
                game.discardPile.pop();
                updateUI(game.getState());
            }
            colorSelectionCallback = null;
            pendingWildCard = null;
            selectedCardIndex = null;
        }

        // Card description tooltip
        function showCardDescription(value, x, y) {
            const desc = CincoGame.getCardDescription(value);
            if (!desc) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'cinco-card-tooltip visible';
            tooltip.textContent = desc;
            tooltip.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y - 50}px;
                background: rgba(26, 22, 48, 0.95);
                border: 1px solid rgba(255,246,232,.25);
                border-radius: 8px;
                padding: 10px 16px;
                font-size: 12px;
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,.4);
                pointer-events: none;
                z-index: 3000;
                max-width: 200px;
                text-align: center;
            `;
            tooltip.id = 'cardTooltip';
            document.body.appendChild(tooltip);
        }

        function hideCardDescription() {
            const tooltip = document.getElementById('cardTooltip');
            if (tooltip) tooltip.remove();
        }

        // Firewall block prompt
        let firewallBlockCallback = null;

        function requestFirewallBlock(attackType, callback) {
            firewallBlockCallback = callback;

            const attackNames = {
                'neuraldrain': '+2 Attack',
                'overdrive': '+3 Attack',
                'empblast': 'EMP Blast (Hand Wipe)'
            };

            const prompt = document.getElementById('firewallPrompt');
            document.getElementById('firewallPromptTitle').textContent = `${attackNames[attackType] || 'Incoming Attack'}!`;
            document.getElementById('firewallPromptDesc').textContent =
                `You have a Firewall card in your hand. Use it to block this attack?`;
            prompt.classList.add('active');
        }

        document.getElementById('firewallBlockBtn').addEventListener('click', () => {
            document.getElementById('firewallPrompt').classList.remove('active');
            if (firewallBlockCallback) {
                firewallBlockCallback(true);
                firewallBlockCallback = null;
            }
        });

        document.getElementById('firewallAcceptBtn').addEventListener('click', () => {
            document.getElementById('firewallPrompt').classList.remove('active');
            if (firewallBlockCallback) {
                firewallBlockCallback(false);
                firewallBlockCallback = null;
            }
        });

        // Draw penalty animation - UNO-style sequential card draw
        function showDrawPenaltyAnimation(targetPlayer, count) {
            const overlay = document.getElementById('drawPenaltyOverlay');
            const drawPileEl = document.getElementById('drawPile');
            const playerArea = document.querySelector('.cinco-player-area');

            // Get draw pile position as animation start point
            const pileRect = drawPileEl.getBoundingClientRect();
            const startX = pileRect.left + pileRect.width / 2 - 25;
            const startY = pileRect.top + pileRect.height / 2 - 36;

            // Get player hand area as animation end point
            const handRect = playerArea ? playerArea.getBoundingClientRect() : null;
            const endX = handRect ? handRect.left + handRect.width / 2 - 25 : window.innerWidth / 2 - 25;
            const endY = handRect ? handRect.top + 20 : window.innerHeight - 120;

            // Show the big "+N" badge in the center
            const badge = document.createElement('div');
            badge.className = 'draw-penalty-badge';
            badge.textContent = `+${count}`;
            document.body.appendChild(badge);

            // Animate cards one at a time
            const delay = 500;
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const card = document.createElement('div');
                    card.className = 'draw-penalty-card';
                    card.textContent = '?';
                    card.style.left = startX + 'px';
                    card.style.top = startY + 'px';
                    card.style.transform = 'scale(1)';
                    overlay.appendChild(card);

                    // Force reflow then start move
                    card.offsetHeight;
                    card.classList.add('animating');
                    card.style.left = endX + 'px';
                    card.style.top = endY + 'px';
                    card.style.transform = 'scale(0.8)';

                    // Fade out on landing
                    setTimeout(() => {
                        card.classList.remove('animating');
                        card.classList.add('landing');
                        setTimeout(() => card.remove(), 200);
                    }, 450);
                }, i * delay);
            }

            // Clean up after all cards done
            setTimeout(() => {
                overlay.innerHTML = '';
                badge.remove();
            }, count * delay + 700);
        }

        // Animations
        function playAnimation(type, playedBy = 'player') {
            showActionBanner(type, playedBy);
        }

        function showActionBanner(cardType, playedBy) {
            const banner = document.getElementById('actionBanner');
            const icon = document.getElementById('bannerIcon');
            const title = document.getElementById('bannerTitle');
            const description = document.getElementById('bannerDescription');

            const playerLabel = playedBy === 'player' ? 'You' : (gameMode === 'ai' ? 'AI' : 'Opponent');

            const announcements = {
                'quantumskip': { icon: '&#128683;', title: `${playerLabel} played Skip`, description: 'Turn skipped', type: 'special' },
                'reversepolarity': { icon: '&#128260;', title: `${playerLabel} played Reverse`, description: 'Direction reversed', type: 'special' },
                'neuraldrain': { icon: '+2', title: `${playerLabel} played +2`, description: 'Draw 2 cards', type: 'attack' },
                'overdrive': { icon: '+3', title: `${playerLabel} played +3`, description: 'Draw 3 cards', type: 'attack' },
                'systemoverload': { icon: '+4', title: `${playerLabel} played Wild +4`, description: 'Draw 4 cards', type: 'attack' },
                'empblast': { icon: '&#128165;', title: `${playerLabel} played Wipe`, description: 'Hand wiped', type: 'attack' },
                'firewall': { icon: '&#128737;', title: `${playerLabel} played Firewall`, description: 'Ready to block next attack', type: 'defense' },
                'adaptiveprotocol': { icon: '', title: `${playerLabel} played Wild`, description: 'Color changed', type: 'wild' },
                'turnsteal': { icon: '&#9889;', title: `${playerLabel} played Extra Turn`, description: 'Extra turn', type: 'special' },
                'systemlockdown': { icon: '&#128274;', title: `${playerLabel} played Lock`, description: 'Color locked', type: 'special' },
                'mirrorcode': { icon: '&#128101;', title: `${playerLabel} played Copy`, description: 'Effect copied', type: 'wild' },
                'firewall_block': { icon: '&#128737;&#128165;', title: 'Shield Block!', description: 'Attack absorbed', type: 'defense' }
            };

            const announcement = announcements[cardType];
            if (!announcement) return;

            icon.innerHTML = announcement.icon;
            title.textContent = announcement.title;
            description.textContent = announcement.description;

            banner.classList.remove('attack', 'defense', 'wild', 'special');
            banner.classList.add(announcement.type);
            banner.classList.add('show');

            setTimeout(() => banner.classList.remove('show'), 4500);
        }

        // Game over
        async function handleGameOver(winner, result) {
            const isWin = (winner === 'player' && gameMode !== 'online') ||
                          (winner === onlineGame?.playerRole);

            document.getElementById('resultEmoji').innerHTML = isWin ? '&#127942;' : '&#128532;';
            document.getElementById('resultMessage').textContent = isWin ? 'You Win!' : 'You Lose!';
            document.getElementById('resultDetails').textContent = isWin ?
                'Congratulations!' : 'Better luck next time!';

            showScreen('gameOverScreen');
        }
    </script>
</body>
</html>
