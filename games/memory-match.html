<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Match - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        .player-indicator {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stats-h2h {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        .player-stats-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .player-stats-box.active-turn {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .player-stats-box h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: center;
        }

        .h2h-stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 10px;
        }

        .h2h-stat-label {
            color: #666;
            font-size: 0.95em;
        }

        .h2h-stat-value {
            color: #764ba2;
            font-weight: bold;
            font-size: 1.3em;
        }

        .vs-separator {
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
            text-align: center;
        }

        .memory-grid {
            display: grid;
            gap: 10px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            padding: 0;
            box-sizing: border-box;
            overflow: visible;
        }

        .memory-grid.grid-2x4 { grid-template-columns: repeat(4, 1fr); max-width: 500px; }
        .memory-grid.grid-3x4 { grid-template-columns: repeat(4, 1fr); max-width: 550px; }
        .memory-grid.grid-4x4 { grid-template-columns: repeat(4, 1fr); max-width: 600px; }
        .memory-grid.grid-4x5 { grid-template-columns: repeat(5, 1fr); max-width: 650px; }
        .memory-grid.grid-5x6 { grid-template-columns: repeat(6, 1fr); max-width: 700px; }
        .memory-grid.grid-6x6 { grid-template-columns: repeat(6, 1fr); max-width: 750px; }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5em, 4vw, 3em);
            transition: all 0.3s ease;
            position: relative;
            min-height: 60px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .memory-card:active {
            transform: scale(0.95);
        }

        .memory-card.flipped,
        .memory-card.matched {
            background: white;
            border: 3px solid #667eea;
            transform: scale(1);
        }

        .memory-card .card-front {
            display: none;
        }

        .memory-card.flipped .card-front,
        .memory-card.matched .card-front {
            display: block;
        }

        .memory-card.matched {
            opacity: 0.5;
            cursor: default;
        }

        /* Image card styling */
        .memory-card .card-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 7px;
            display: block;
        }

        /* Only show image card front when flipped or matched */
        .memory-card.image-card.flipped .card-front,
        .memory-card.image-card.matched .card-front {
            width: 100%;
            height: 100%;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Image error fallback */
        .memory-card .card-front .image-error {
            font-size: 2em;
            color: #e74c3c;
        }

        .instructions {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .difficulty-buttons, .theme-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .difficulty-buttons button,
        .theme-buttons button {
            padding: 15px;
            font-size: 1em;
            position: relative;
            background: white;
            color: #667eea;
            border: 3px solid #ddd;
            transition: all 0.2s;
        }

        .difficulty-buttons button.selected,
        .theme-buttons button.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .difficulty-buttons button:hover,
        .theme-buttons button:hover {
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .leave-game-btn {
            background: transparent;
            border: 2px solid #e74c3c;
            color: #e74c3c;
            font-size: 1em;
            padding: 12px;
            margin-top: 20px;
            min-height: 48px;
            touch-action: manipulation;
        }

        .leave-game-btn:hover {
            background: #e74c3c;
            color: white;
        }

        @media (hover: none) and (pointer: coarse) {
            .leave-game-btn:active {
                background: #e74c3c;
                color: white;
                transform: scale(0.98);
            }
        }

        .start-screen, .game-screen, .end-screen, .settings-screen,
        .online-lobby-screen, .create-game-screen, .join-game-screen,
        .waiting-room-screen, .connecting-screen, .opponent-playing-screen {
            display: none;
        }

        .start-screen.active, .game-screen.active, .end-screen.active, .settings-screen.active,
        .online-lobby-screen.active, .create-game-screen.active, .join-game-screen.active,
        .waiting-room-screen.active, .connecting-screen.active, .opponent-playing-screen.active {
            display: block;
        }

        .score-display {
            text-align: center;
            font-size: 2.5em;
            color: #667eea;
            margin: 30px 0;
            font-weight: bold;
        }

        .message {
            text-align: center;
            font-size: 1.3em;
            color: #666;
            margin: 20px 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .player-result {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .player-result h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .player-result .score {
            font-size: 2.5em;
            font-weight: bold;
            color: #764ba2;
            margin: 10px 0;
        }

        .player-result .stat-item {
            margin: 8px 0;
            color: #666;
        }

        /* Online Lobby Styles */
        .lobby-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .lobby-card {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .lobby-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .lobby-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .lobby-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .lobby-card p {
            color: #666;
            font-size: 0.9em;
        }

        .name-input-container {
            margin-bottom: 25px;
        }

        .name-input-container label {
            display: block;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .name-input-container input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 3px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        .name-input-container input:focus {
            outline: none;
            border-color: #667eea;
        }

        .session-code-display {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            border: 3px solid #667eea;
        }

        .code-label {
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .session-code {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .copy-code-btn {
            background: #667eea;
            color: white;
            width: auto;
            display: inline-block;
            padding: 12px 30px;
            font-size: 1em;
        }

        .copy-code-btn:hover {
            background: #764ba2;
        }

        .waiting-animation, .ready-animation {
            text-align: center;
            padding: 40px 20px;
        }

        .dot-pulse {
            width: 60px;
            height: 60px;
            border: 4px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            font-size: 3em;
            line-height: 80px;
            margin: 0 auto 20px;
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #f44336;
        }

        .back-btn, .cancel-btn {
            background: white;
            color: #667eea;
            border: 3px solid #667eea;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            border: none;
        }

        .cancel-btn:hover {
            background: #da190b;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .game-container {
                padding: 20px 10px !important;
                max-width: 100vw !important;
            }

            /* Make all touch targets at least 48px (mobile standard) */
            button {
                min-height: 48px;
                font-size: 1em;
                padding: 12px 20px;
            }

            .lobby-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .lobby-card {
                padding: 25px;
                min-height: 120px;
            }

            .session-code {
                font-size: 2em;
                letter-spacing: 4px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .difficulty-buttons,
            .theme-buttons {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .difficulty-buttons button,
            .theme-buttons button {
                min-height: 52px;
                font-size: 1.1em;
            }

            .stat-box {
                min-width: 80px;
                padding: 12px 15px;
            }

            .stat-value {
                font-size: 1.5em;
            }

            .score-display {
                font-size: 2em;
            }

            .player-indicator {
                font-size: 1.2em;
                padding: 12px;
            }

            .stats-h2h {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .vs-separator {
                font-size: 1.2em;
                padding: 8px 0;
            }

            .player-stats-box {
                padding: 15px;
            }

            .h2h-stat-value {
                font-size: 1.1em;
            }

            .memory-grid {
                gap: 6px !important;
                padding: 0 !important;
                max-width: 95vw !important;
                width: 95vw !important;
            }

            .memory-grid.grid-2x4,
            .memory-grid.grid-3x4,
            .memory-grid.grid-4x4 {
                max-width: 92vw !important;
                width: 92vw !important;
                gap: 5px !important;
            }

            .memory-grid.grid-4x5 {
                max-width: 94vw !important;
                width: 94vw !important;
                gap: 4px !important;
            }

            .memory-grid.grid-5x6,
            .memory-grid.grid-6x6 {
                max-width: 96vw !important;
                width: 96vw !important;
                gap: 3px !important;
            }

            .memory-card {
                min-height: 50px;
                font-size: clamp(1.5em, 4vw, 2.5em);
            }

            .memory-grid.grid-5x6 .memory-card,
            .memory-grid.grid-6x6 .memory-card {
                min-height: 40px;
                font-size: clamp(1em, 3vw, 2em);
            }

            /* Input fields should be easier to tap */
            input {
                min-height: 48px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Game title adjustments */
            .game-title {
                font-size: 2em;
            }

            .game-subtitle {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 15px 8px !important;
                max-width: 100vw !important;
            }

            .memory-grid {
                gap: 4px !important;
                padding: 0 !important;
                max-width: 96vw !important;
                width: 96vw !important;
            }

            .memory-grid.grid-2x4,
            .memory-grid.grid-3x4,
            .memory-grid.grid-4x4 {
                max-width: 94vw !important;
                width: 94vw !important;
                gap: 3px !important;
            }

            .memory-grid.grid-4x5 {
                max-width: 96vw !important;
                width: 96vw !important;
                gap: 2px !important;
            }

            .memory-grid.grid-5x6,
            .memory-grid.grid-6x6 {
                max-width: 97vw !important;
                width: 97vw !important;
                gap: 2px !important;
            }

            .memory-card {
                min-height: 45px;
                border-radius: 8px;
                font-size: clamp(1.2em, 4vw, 2em);
            }

            .memory-grid.grid-5x6 .memory-card,
            .memory-grid.grid-6x6 .memory-card {
                min-height: 35px;
                font-size: clamp(0.9em, 3vw, 1.5em);
            }

            .stat-label {
                font-size: 0.8em;
            }

            button {
                font-size: 0.95em;
            }

            .player-indicator {
                font-size: 1.1em;
                padding: 10px;
            }

            .instructions {
                padding: 15px;
                font-size: 0.95em;
            }

            .lobby-card {
                padding: 20px;
            }

            .lobby-icon {
                font-size: 2.5em;
            }
        }

        /* Landscape mobile optimizations */
        @media (max-width: 896px) and (orientation: landscape) {
            .memory-grid {
                max-width: 600px;
                margin: 10px auto;
            }

            .player-indicator {
                margin-bottom: 10px;
                padding: 8px;
            }

            .stats,
            .stats-h2h {
                margin-bottom: 15px;
            }
        }

        /* Touch-specific improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Better touch feedback */
            button:active {
                transform: scale(0.97);
            }

            .memory-card:active {
                transform: scale(0.92);
            }

            .lobby-card:active {
                transform: translateY(-2px);
            }

            /* Larger tap targets for small buttons */
            .copy-code-btn,
            .back-btn,
            .cancel-btn {
                min-height: 48px;
                padding: 12px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="../index.html" class="back-link">‚Üê Back to Games</a>
        <h1 class="game-title">üéØ Memory Match</h1>
        <p class="game-subtitle">Find all the pairs!</p>

        <!-- Online Lobby Screen -->
        <div class="online-lobby-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">üåê Play Online</h2>
            <div class="lobby-options">
                <div class="lobby-card" onclick="showCreateGame()">
                    <div class="lobby-icon">‚ûï</div>
                    <h3>Create Game</h3>
                    <p>Start a new game and get a code to share</p>
                </div>
                <div class="lobby-card" onclick="showJoinGame()">
                    <div class="lobby-icon">üîó</div>
                    <h3>Join Game</h3>
                    <p>Enter a code to join a game</p>
                </div>
            </div>
        </div>

        <!-- Create Game Screen -->
        <div class="create-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Create New Game</h2>
            <div class="name-input-container">
                <label for="player1Name">Your Name:</label>
                <input type="text" id="player1Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <button onclick="createGameSession()">Create Game & Get Code</button>
        </div>

        <!-- Waiting Room Screen -->
        <div class="waiting-room-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">Waiting for Player 2...</h2>
            <div class="session-code-display">
                <div class="code-label">Share this code with your partner:</div>
                <div class="session-code" id="sessionCodeDisplay">------</div>
                <button class="copy-code-btn" onclick="copySessionCode()">üìã Copy Code</button>
            </div>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <p>Waiting for your partner to join...</p>
            </div>
            <button class="cancel-btn" onclick="cancelSession()">Cancel</button>
        </div>

        <!-- Join Game Screen -->
        <div class="join-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Join Game</h2>
            <div class="name-input-container">
                <label for="player2Name">Your Name:</label>
                <input type="text" id="player2Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <div class="name-input-container">
                <label for="sessionCodeInput">Game Code:</label>
                <input type="text" id="sessionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="text-transform: uppercase;" />
            </div>
            <div id="joinErrorMessage" class="error-message" style="display: none;"></div>
            <button onclick="joinGameSession()">Join Game</button>
        </div>

        <!-- Connecting Screen -->
        <div class="connecting-screen">
            <h2 style="color: #667eea; text-align: center;">‚ú® Connected!</h2>
            <p style="text-align: center; font-size: 1.2em; margin: 20px 0;">
                You're playing with <strong id="connectedPartnerName">Partner</strong>
            </p>
            <div class="ready-animation">
                <div class="checkmark">‚úì</div>
                <p>Choose game settings...</p>
            </div>
        </div>

        <!-- Opponent Playing Screen -->
        <div class="opponent-playing-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;" id="opponentPlayingTitle">Opponent is playing...</h2>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <p style="font-size: 1.3em; font-weight: bold; color: #764ba2; margin-top: 20px;">
                    Matches: <span id="opponentMatchesLive">0</span> / <span id="totalPairs">8</span>
                </p>
            </div>
            <div class="stats" style="margin-top: 40px;">
                <div class="stat-box">
                    <div class="stat-label">Opponent Score</div>
                    <div class="stat-value" id="opponentScoreLive">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Opponent Moves</div>
                    <div class="stat-value" id="opponentMovesLive">0</div>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div class="settings-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Game Settings</h2>

            <h3 style="color: #764ba2; margin-bottom: 10px;">Game Mode:</h3>
            <div class="difficulty-buttons">
                <button onclick="selectGameMode('classic')">Classic Mode</button>
                <button onclick="selectGameMode('headtohead')">Head to Head</button>
            </div>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 20px; padding: 0 10px;">
                <strong>Classic:</strong> Each player completes the full board separately<br>
                <strong>Head to Head:</strong> Take turns flipping cards - match to continue, miss to switch turns
            </p>

            <h3 style="color: #764ba2; margin-bottom: 10px;">Difficulty:</h3>
            <div class="difficulty-buttons">
                <button onclick="selectDifficulty('easy')">Easy (8 cards)</button>
                <button onclick="selectDifficulty('medium')">Medium (12 cards)</button>
                <button onclick="selectDifficulty('hard')">Hard (16 cards)</button>
                <button onclick="selectDifficulty('expert')">Expert (20 cards)</button>
                <button onclick="selectDifficulty('master')">Master (30 cards)</button>
                <button onclick="selectDifficulty('insane')">Insane (36 cards)</button>
            </div>

            <h3 style="color: #764ba2; margin-bottom: 10px; margin-top: 20px;">Theme:</h3>

            <!-- Emoji Themes -->
            <h4 style="color: #999; font-size: 0.9em; margin: 15px 0 8px;">Emoji Themes</h4>
            <div class="theme-buttons">
                <button onclick="selectTheme('animals')">üê∂ Animals</button>
                <button onclick="selectTheme('food')">üçï Food</button>
                <button onclick="selectTheme('nature')">üåª Nature</button>
                <button onclick="selectTheme('emojis')">üòÄ Emojis</button>
            </div>

            <!-- Image Themes -->
            <h4 style="color: #999; font-size: 0.9em; margin: 15px 0 8px;">Image Themes</h4>
            <div class="theme-buttons">
                <button onclick="selectTheme('memes')">üòÇ Memes & Internet</button>
                <button onclick="selectTheme('politics')">üèõÔ∏è Political Figures</button>
                <button onclick="selectTheme('tech')">ü§ñ Tech & AI</button>
                <button onclick="selectTheme('celebrities')">‚≠ê Celebrities</button>
            </div>
        </div>

        <!-- Start Screen -->
        <div class="start-screen active">
            <div class="instructions">
                <h3>How to Play:</h3>
                <ul>
                    <li>Click on cards to flip them and find matching pairs</li>
                    <li>Each match = 10 points</li>
                    <li><strong>Classic Mode:</strong> Each player completes the board separately, best score wins!</li>
                    <li><strong>Head to Head Mode:</strong> Take turns flipping cards - find a match to continue your turn, miss to switch turns!</li>
                    <li>Choose your game mode, difficulty, and theme to begin üéØ</li>
                </ul>
            </div>
            <button onclick="showSettings()">Start Game</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen">
            <div class="player-indicator" id="playerIndicator">Player 1's Turn</div>

            <!-- Classic Mode Stats (Single Player) -->
            <div class="stats" id="classicStats">
                <div class="stat-box">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Moves</div>
                    <div class="stat-value" id="moves">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Matches</div>
                    <div class="stat-value" id="matches">0</div>
                </div>
            </div>

            <!-- Head to Head Mode Stats (Both Players) -->
            <div class="stats-h2h" id="headToHeadStats" style="display: none;">
                <div class="player-stats-box" id="player1StatsBox">
                    <h4 id="p1NameLive">Player 1</h4>
                    <div class="h2h-stat-row">
                        <span class="h2h-stat-label">Score:</span>
                        <span class="h2h-stat-value" id="p1ScoreLive">0</span>
                    </div>
                    <div class="h2h-stat-row">
                        <span class="h2h-stat-label">Matches:</span>
                        <span class="h2h-stat-value" id="p1MatchesLive">0</span>
                    </div>
                </div>
                <div class="vs-separator">VS</div>
                <div class="player-stats-box" id="player2StatsBox">
                    <h4 id="p2NameLive">Player 2</h4>
                    <div class="h2h-stat-row">
                        <span class="h2h-stat-label">Score:</span>
                        <span class="h2h-stat-value" id="p2ScoreLive">0</span>
                    </div>
                    <div class="h2h-stat-row">
                        <span class="h2h-stat-label">Matches:</span>
                        <span class="h2h-stat-value" id="p2MatchesLive">0</span>
                    </div>
                </div>
            </div>

            <div class="memory-grid" id="memoryGrid"></div>

            <button class="leave-game-btn" onclick="leaveGame()" style="margin-top: 20px;">Leave Game</button>
        </div>

        <!-- Results Screen -->
        <div class="end-screen">
            <div class="score-display" id="finalScore">üèÜ Player 1 Wins!</div>
            <div class="message" id="finalMessage"></div>

            <div class="results-grid">
                <div class="player-result">
                    <h3 id="p1NameResult">Player 1</h3>
                    <div class="score" id="p1Score">0</div>
                    <div class="stat-item">Moves: <span id="p1Moves">0</span></div>
                    <div class="stat-item">Matches: <span id="p1Matches">0</span></div>
                </div>
                <div class="player-result">
                    <h3 id="p2NameResult">Player 2</h3>
                    <div class="score" id="p2Score">0</div>
                    <div class="stat-item">Moves: <span id="p2Moves">0</span></div>
                    <div class="stat-item">Matches: <span id="p2Matches">0</span></div>
                </div>
            </div>

            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        // Emoji themes
        const emojiThemes = {
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'ü¶Å'],
            food: ['üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'üßÅ', 'üç©', 'üç™', 'üéÇ', 'üç∞'],
            nature: ['üåª', 'üå∫', 'üåπ', 'üå∑', 'üå∏', 'üåº', 'üçÄ', 'üåø', 'üå≤', 'üå≥'],
            emojis: ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üò¥', 'ü§©', 'üòú', 'ü•≥', 'üòá']
        };

        // Image themes (using free CDN images)
        const imageThemes = {
            memes: [
                'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400',  // Cat
                'https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=400',  // Dog
                'https://images.unsplash.com/photo-1529778873920-4da4926a72c2?w=400',  // Cute cat
                'https://images.unsplash.com/photo-1561948955-570b270e7c36?w=400',  // Cat meme face
                'https://images.unsplash.com/photo-1573865526739-10c1de0b5d9d?w=400',  // Dog meme
                'https://images.unsplash.com/photo-1517849845537-4d257902454a?w=400',  // Dog silly
                'https://images.unsplash.com/photo-1511044568932-338cba0ad803?w=400',  // Funny dog
                'https://images.unsplash.com/photo-1518288774672-b94e808873ff?w=400',  // Cat close up
                'https://images.unsplash.com/photo-1478098711619-5ab0b478d6e6?w=400',  // Silly cat
                'https://images.unsplash.com/photo-1541599468348-e96984315921?w=400',  // Happy dog
                'https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=400',  // Funny dog face
                'https://images.unsplash.com/photo-1526336024174-e58f5cdd8e13?w=400',  // Cat meme
                'https://images.unsplash.com/photo-1535930891776-0c2dfb7fda1a?w=400',  // Dog portrait
                'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=400',  // Cat funny
                'https://images.unsplash.com/photo-1560807707-8cc77767d783?w=400',  // Dog happy
                'https://images.unsplash.com/photo-1592194996308-7b43878e84a6?w=400',  // Cute cat face
                'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=400',  // Dog smiling
                'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?w=400'   // Cat portrait
            ],
            politics: [
                'https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?w=400',  // White House
                'https://images.unsplash.com/photo-1555083488-b736b2f10da5?w=400',  // Capitol
                'https://images.unsplash.com/photo-1555083488-e5c0faa85e2a?w=400',  // American flag
                'https://images.unsplash.com/photo-1563906267088-b029e7101114?w=400',  // Politics symbols
                'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400',  // Statue of Liberty
                'https://images.unsplash.com/photo-1526976240761-2e4f55c8f072?w=400',  // Political building
                'https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?w=400',  // Government
                'https://images.unsplash.com/photo-1541872705-1f73c6400ec9?w=400',  // Eagle
                'https://images.unsplash.com/photo-1513735492246-483525079686?w=400',  // Political symbols
                'https://images.unsplash.com/photo-1491975474562-1f4e30bc9468?w=400',  // Patriotic
                'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=400',  // Meeting
                'https://images.unsplash.com/photo-1534536281715-e28d76689b4d?w=400',  // USA theme
                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400',  // Mountains USA
                'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400',  // Mountains patriotic
                'https://images.unsplash.com/photo-1484820540004-14229fe36ca4?w=400',  // Democracy
                'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400',  // Buildings
                'https://images.unsplash.com/photo-1494922275507-58dc039ad5a8?w=400',  // Monument
                'https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=400'   // Flag waving
            ],
            tech: [
                'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=400',  // AI/ChatGPT
                'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?w=400',  // Robot
                'https://images.unsplash.com/photo-1655393001768-d946c97d6fd1?w=400',  // AI brain
                'https://images.unsplash.com/photo-1535378620166-273708d44e4c?w=400',  // Circuit board
                'https://images.unsplash.com/photo-1523961131990-5ea7c61b2107?w=400',  // Laptop code
                'https://images.unsplash.com/photo-1531746790731-6c087fecd65a?w=400',  // Microchip
                'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=400',  // Robot hand
                'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=400',  // Tech abstract
                'https://images.unsplash.com/photo-1518770660439-4636190af475?w=400',  // Technology
                'https://images.unsplash.com/photo-1488590528505-98d2b5aba04b?w=400',  // Laptop
                'https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=400',  // Data matrix
                'https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=400',  // Code screen
                'https://images.unsplash.com/photo-1563206767-5b18f218e8de?w=400',  // Circuit
                'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=400',  // Robot future
                'https://images.unsplash.com/photo-1639322537228-f710d846310a?w=400',  // AI concept
                'https://images.unsplash.com/photo-1587614382346-4ec70e388b28?w=400',  // Digital brain
                'https://images.unsplash.com/photo-1593642532842-98d0fd5ebc1a?w=400',  // Laptop work
                'https://images.unsplash.com/photo-1558494949-ef010cbdcc31?w=400'   // Tech workspace
            ],
            celebrities: [
                'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=400',  // Music
                'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=400',  // Concert
                'https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?w=400',  // Stage
                'https://images.unsplash.com/photo-1501281668745-f7f57925c3b4?w=400',  // Microphone
                'https://images.unsplash.com/photo-1598387993441-a364f854c3e1?w=400',  // Performance
                'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=400',  // Guitar
                'https://images.unsplash.com/photo-1524368535928-5b5e00ddc76b?w=400',  // Stage lights
                'https://images.unsplash.com/photo-1429962714451-bb934ecdc4ec?w=400',  // Audience
                'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400',  // DJ
                'https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400',  // Music festival
                'https://images.unsplash.com/photo-1459749411175-04bf5292ceea?w=400',  // Recording studio
                'https://images.unsplash.com/photo-1507838153414-b4b713384a76?w=400',  // Vinyl
                'https://images.unsplash.com/photo-1571330735066-03aaa9429d89?w=400',  // Music notes
                'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?w=400',  // Piano
                'https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=400',  // Music studio
                'https://images.unsplash.com/photo-1487180144351-b8472da7d491?w=400',  // Turntable
                'https://images.unsplash.com/photo-1509114397022-ed747cca3f65?w=400',  // Concert crowd
                'https://images.unsplash.com/photo-1510915361894-db8b60106cb1?w=400'   // Music equipment
            ]
        };

        // Theme metadata
        const themeMetadata = {
            animals: { type: 'emoji', icon: 'üê∂', label: 'Animals' },
            food: { type: 'emoji', icon: 'üçï', label: 'Food' },
            nature: { type: 'emoji', icon: 'üåª', label: 'Nature' },
            emojis: { type: 'emoji', icon: 'üòÄ', label: 'Emojis' },
            memes: { type: 'image', icon: 'üòÇ', label: 'Memes & Internet' },
            politics: { type: 'image', icon: 'üèõÔ∏è', label: 'Political Figures' },
            tech: { type: 'image', icon: 'ü§ñ', label: 'Tech & AI' },
            celebrities: { type: 'image', icon: '‚≠ê', label: 'Celebrities' }
        };

        // Helper function to get theme content
        function getThemeContent(themeName) {
            const metadata = themeMetadata[themeName];
            if (!metadata) return emojiThemes.animals; // fallback

            if (metadata.type === 'emoji') {
                return emojiThemes[themeName];
            } else {
                return imageThemes[themeName];
            }
        }

        // Image error handler
        window.handleImageError = function(img, index) {
            console.error(`Failed to load image for card ${index}`);
            img.parentElement.innerHTML = '<span class="image-error">üñºÔ∏è</span>';
        };

        // Game mode detection
        const urlParams = new URLSearchParams(window.location.search);
        const gameMode = urlParams.get('mode') || 'local';
        let multiplayerSession = null;
        let playerNames = { player1: 'Player 1', player2: 'Player 2' };
        let hasStartedTurn = false;
        let lastFlippedIndices = [];
        let myLastFlipTime = 0; // Track when I last flipped cards

        // Game settings
        let selectedDifficulty = 'hard';
        let selectedTheme = 'animals';
        let pairCount = 8;
        let gamePlayMode = 'classic'; // 'classic' or 'headtohead'

        // Game state
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let matchedCardIndices = []; // Track which cards have been matched
        let moves = 0;
        let score = 0;
        let currentPlayer = 1;
        let currentTurnPlayer = 1; // For head-to-head mode
        let canFlip = true;

        let player1Score = 0;
        let player1Moves = 0;
        let player1Matches = 0;
        let player2Score = 0;
        let player2Moves = 0;
        let player2Matches = 0;

        let gameBoard = [];

        // Initialize based on mode
        if (gameMode === 'online') {
            console.log('Starting in online mode');
            multiplayerSession = new MultiplayerSession('memory-match');

            // Try to auto-reconnect to existing session
            (async () => {
                const reconnectResult = await MultiplayerSession.autoReconnect('memory-match');

                if (reconnectResult) {
                    // Successfully reconnected!
                    multiplayerSession = reconnectResult.session;
                    const gameState = reconnectResult.result.gameState || {};

                    console.log('Auto-reconnected to session:', reconnectResult.result.sessionId);
                    console.log('Game state:', gameState);

                    // Set player names
                    if (multiplayerSession.playerNumber === 1) {
                        playerNames.player1 = multiplayerSession.playerName;
                        playerNames.player2 = multiplayerSession.opponentName || 'Player 2';
                    } else {
                        playerNames.player2 = multiplayerSession.playerName;
                        playerNames.player1 = multiplayerSession.opponentName || 'Player 1';
                    }

                    // Listen for game state changes
                    multiplayerSession.on('onGameStateChange', handleOnlineGameStateChange);

                    // Check game status and resume
                    if (gameState.status === 'waiting') {
                        // Still in waiting room
                        document.querySelector('.start-screen').classList.remove('active');
                        document.querySelector('.waiting-room-screen').classList.add('active');
                        document.getElementById('sessionCodeDisplay').textContent = multiplayerSession.sessionId;
                    } else if (gameState.status === 'selecting-settings' || !gameState.status) {
                        // In settings selection
                        showSettings();
                    } else if (gameState.status === 'in-progress') {
                        // Game is in progress - restore state
                        if (gameState.gamePlayMode) {
                            gamePlayMode = gameState.gamePlayMode;
                        }
                        if (gameState.difficulty) {
                            selectedDifficulty = gameState.difficulty;
                        }
                        if (gameState.theme) {
                            selectedTheme = gameState.theme;
                        }
                        if (gameState.pairCount) {
                            pairCount = gameState.pairCount;
                        }
                        if (gameState.gameBoard) {
                            gameBoard = gameState.gameBoard;
                        }

                        // Restore scores
                        player1Score = gameState.player1Score || 0;
                        player1Matches = gameState.player1Matches || 0;
                        player2Score = gameState.player2Score || 0;
                        player2Matches = gameState.player2Matches || 0;

                        if (gameState.currentTurnPlayer) {
                            currentTurnPlayer = gameState.currentTurnPlayer;
                        }

                        // Start the game
                        hasStartedTurn = false; // Reset this so game can start
                        startGame();
                    } else if (gameState.status === 'finished') {
                        // Game finished - show results
                        player1Score = gameState.player1Score || 0;
                        player1Matches = gameState.player1Matches || 0;
                        player2Score = gameState.player2Score || 0;
                        player2Matches = gameState.player2Matches || 0;
                        showResults();
                    }
                } else {
                    // No active session, show lobby
                    document.querySelector('.start-screen').classList.remove('active');
                    document.querySelector('.online-lobby-screen').classList.add('active');
                }
            })();
        }

        // Online Lobby Functions
        window.showCreateGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.create-game-screen').classList.add('active');
        };

        window.showJoinGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.add('active');
        };

        window.backToLobby = function() {
            document.querySelector('.create-game-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            document.getElementById('joinErrorMessage').style.display = 'none';
        };

        window.createGameSession = async function() {
            const playerName = document.getElementById('player1Name').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }

            playerNames.player1 = playerName;
            const result = await multiplayerSession.createSession(playerName);

            if (result.success) {
                console.log('Session created:', result.sessionId);
                document.querySelector('.create-game-screen').classList.remove('active');
                document.querySelector('.waiting-room-screen').classList.add('active');
                document.getElementById('sessionCodeDisplay').textContent = result.sessionId;

                // Listen for player 2 joining
                multiplayerSession.on('onPlayerJoined', async (player2Name) => {
                    console.log('Player 2 joined:', player2Name);
                    playerNames.player2 = player2Name;
                    document.getElementById('connectedPartnerName').textContent = player2Name;
                    document.querySelector('.waiting-room-screen').classList.remove('active');
                    document.querySelector('.connecting-screen').classList.add('active');

                    // Initialize game state
                    await multiplayerSession.updateGameState({
                        currentPlayer: 1,
                        difficulty: null,
                        theme: null,
                        status: 'selecting-settings'
                    });

                    setTimeout(() => {
                        showSettings();
                    }, 2000);
                });

                // Listen for game state changes
                multiplayerSession.on('onGameStateChange', handleOnlineGameStateChange);
            } else {
                alert('Error creating session: ' + result.error);
            }
        };

        window.joinGameSession = async function() {
            const playerName = document.getElementById('player2Name').value.trim();
            const sessionCode = document.getElementById('sessionCodeInput').value.trim();

            if (!playerName || !sessionCode) {
                document.getElementById('joinErrorMessage').textContent = 'Please enter both your name and the game code';
                document.getElementById('joinErrorMessage').style.display = 'block';
                return;
            }

            playerNames.player2 = playerName;
            const result = await multiplayerSession.joinSession(sessionCode, playerName);

            if (result.success) {
                console.log('Joined session:', sessionCode);
                playerNames.player1 = result.opponentName;
                document.getElementById('connectedPartnerName').textContent = result.opponentName;
                document.querySelector('.join-game-screen').classList.remove('active');
                document.querySelector('.connecting-screen').classList.add('active');

                // Listen for game state changes
                multiplayerSession.on('onGameStateChange', handleOnlineGameStateChange);

                setTimeout(() => {
                    showSettings();
                }, 2000);
            } else {
                document.getElementById('joinErrorMessage').textContent = result.error;
                document.getElementById('joinErrorMessage').style.display = 'block';
            }
        };

        window.copySessionCode = function() {
            const code = document.getElementById('sessionCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        };

        window.cancelSession = async function() {
            if (multiplayerSession) {
                await multiplayerSession.disconnect();
            }
            location.reload();
        };

        // Inactivity tracking
        let lastActivityTime = Date.now();
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 60000; // 60 seconds

        function trackActivity() {
            lastActivityTime = Date.now();
        }

        function checkInactivity() {
            const inactiveTime = Date.now() - lastActivityTime;
            if (inactiveTime >= INACTIVITY_TIMEOUT) {
                console.log('Game inactive for 60 seconds, auto-closing...');
                leaveGame();
            }
        }

        function startInactivityTimer() {
            // Track activity on any user interaction
            document.addEventListener('click', trackActivity);
            document.addEventListener('touchstart', trackActivity);
            document.addEventListener('keydown', trackActivity);

            // Check for inactivity every 5 seconds
            inactivityTimer = setInterval(checkInactivity, 5000);
        }

        function stopInactivityTimer() {
            if (inactivityTimer) {
                clearInterval(inactivityTimer);
                inactivityTimer = null;
            }
            document.removeEventListener('click', trackActivity);
            document.removeEventListener('touchstart', trackActivity);
            document.removeEventListener('keydown', trackActivity);
        }

        // Leave game function
        window.leaveGame = async function() {
            console.log('Leaving game...');

            // Stop inactivity timer
            stopInactivityTimer();

            // Clear active session from localStorage
            if (typeof MultiplayerSession !== 'undefined' && MultiplayerSession.clearActiveSession) {
                MultiplayerSession.clearActiveSession();
            }

            // Disconnect from multiplayer session
            if (multiplayerSession) {
                await multiplayerSession.disconnect();
            }

            // Reset game state
            score = 0;
            moves = 0;
            matchedPairs = 0;
            flippedCards = [];
            matchedCardIndices = [];
            player1Score = 0;
            player1Moves = 0;
            player1Matches = 0;
            player2Score = 0;
            player2Moves = 0;
            player2Matches = 0;

            // Return to appropriate screen
            document.querySelector('.game-screen').classList.remove('active');
            if (gameMode === 'online') {
                document.querySelector('.online-lobby-screen').classList.add('active');
            } else {
                document.querySelector('.start-screen').classList.add('active');
            }
        };

        function handleOnlineGameStateChange(gameState) {
            console.log('Game state changed:', gameState);

            // Update scores
            player1Score = gameState.player1Score || 0;
            player1Moves = gameState.player1Moves || 0;
            player1Matches = gameState.player1Matches || 0;
            player2Score = gameState.player2Score || 0;
            player2Moves = gameState.player2Moves || 0;
            player2Matches = gameState.player2Matches || 0;

            // Sync game play mode
            if (gameState.gamePlayMode) {
                gamePlayMode = gameState.gamePlayMode;
            }

            // Sync turn player (for head-to-head mode)
            if (gameState.currentTurnPlayer && gamePlayMode === 'headtohead') {
                const previousTurnPlayer = currentTurnPlayer;
                currentTurnPlayer = gameState.currentTurnPlayer;

                // CRITICAL: When turn switches, force clear all flipped cards
                if (previousTurnPlayer !== currentTurnPlayer) {
                    console.log(`[Player ${multiplayerSession.playerNumber}] Turn switched from Player ${previousTurnPlayer} to Player ${currentTurnPlayer}`);
                    console.log(`[Player ${multiplayerSession.playerNumber}] Force clearing all flipped cards due to turn switch`);

                    // Remove ALL flipped classes when turn switches
                    document.querySelectorAll('.memory-card.flipped').forEach(card => {
                        if (!card.classList.contains('matched')) {
                            card.classList.remove('flipped');
                            console.log(`[Player ${multiplayerSession.playerNumber}] Removed flipped class from card ${card.getAttribute('data-index')} (turn switch)`);
                        }
                    });

                    // Clear local state
                    flippedCards = [];
                }

                // Update turn indicator
                if (gameMode === 'online') {
                    const isMyTurn = multiplayerSession.playerNumber === currentTurnPlayer;
                    const turnPlayerName = playerNames[`player${currentTurnPlayer}`];
                    const indicator = document.getElementById('playerIndicator');
                    if (indicator) {
                        indicator.textContent = isMyTurn ? 'Your Turn' : `${turnPlayerName}'s Turn`;
                    }
                }

                updateStats();
            }

            // Update card UI for flipped and matched cards (head-to-head mode only)
            if (gamePlayMode === 'headtohead' && gameMode === 'online') {
                // Update flipped cards to match Firebase state
                if (gameState.flippedCardIndices !== undefined) {
                    const currentFlippedIndices = gameState.flippedCardIndices || [];

                    console.log(`[Player ${multiplayerSession.playerNumber}] Received flippedCardIndices from Firebase:`, currentFlippedIndices);
                    console.log(`[Player ${multiplayerSession.playerNumber}] Current local flippedCards:`, flippedCards);

                    // ALWAYS sync UI to match Firebase state - no skip logic
                    // This ensures both players always see the same cards

                    // Step 1: Remove ALL flipped classes from non-matched cards
                    const flippedElements = document.querySelectorAll('.memory-card.flipped');
                    console.log(`[Player ${multiplayerSession.playerNumber}] Found ${flippedElements.length} cards with flipped class`);

                    flippedElements.forEach(card => {
                        if (!card.classList.contains('matched')) {
                            const cardIndex = card.getAttribute('data-index');
                            console.log(`[Player ${multiplayerSession.playerNumber}] Removing flipped class from card ${cardIndex}`);
                            card.classList.remove('flipped');
                        }
                    });

                    // Step 2: Add flipped class ONLY to cards specified in Firebase
                    currentFlippedIndices.forEach(index => {
                        const card = document.querySelector(`[data-index="${index}"]`);
                        if (card && !card.classList.contains('matched')) {
                            console.log(`[Player ${multiplayerSession.playerNumber}] Adding flipped class to card ${index}`);
                            card.classList.add('flipped');
                        } else if (!card) {
                            console.error(`[Player ${multiplayerSession.playerNumber}] ERROR: Card not found for index ${index}`);
                        }
                    });

                    console.log(`[Player ${multiplayerSession.playerNumber}] UI update complete. ${currentFlippedIndices.length} cards should be flipped.`);
                }

                // Update matched cards
                if (gameState.matchedCardIndices !== undefined) {
                    const currentMatchedIndices = gameState.matchedCardIndices || [];
                    matchedCardIndices = [...currentMatchedIndices];

                    currentMatchedIndices.forEach(index => {
                        const card = document.querySelector(`[data-index="${index}"]`);
                        if (card && !card.classList.contains('matched')) {
                            card.classList.remove('flipped');
                            card.classList.add('matched');
                        }
                    });

                    // Update matched pairs count
                    matchedPairs = Math.floor(currentMatchedIndices.length / 2);
                }
            }

            // Handle settings selection
            if (gameState.difficulty && gameState.theme && !selectedDifficulty) {
                selectedDifficulty = gameState.difficulty;
                selectedTheme = gameState.theme;
                pairCount = gameState.pairCount;
                console.log('Settings selected by opponent:', selectedDifficulty, selectedTheme);
            }

            // Handle game status changes
            if (gameState.status === 'in-progress' && gamePlayMode === 'classic' && gameState.currentPlayer !== multiplayerSession.playerNumber) {
                // Classic mode: Opponent is playing, show progress
                console.log('Opponent is playing...');
                document.querySelector('.game-screen').classList.remove('active');
                document.querySelector('.settings-screen').classList.remove('active');
                document.querySelector('.connecting-screen').classList.remove('active');
                document.querySelector('.opponent-playing-screen').classList.add('active');

                const opponentPlayerNum = gameState.currentPlayer;
                const opponentName = playerNames[`player${opponentPlayerNum}`];
                document.getElementById('opponentPlayingTitle').textContent = `${opponentName} is playing...`;
                document.getElementById('opponentMatchesLive').textContent = gameState[`player${opponentPlayerNum}Matches`] || 0;
                document.getElementById('totalPairs').textContent = pairCount;
                document.getElementById('opponentScoreLive').textContent = gameState[`player${opponentPlayerNum}Score`] || 0;
                document.getElementById('opponentMovesLive').textContent = gameState[`player${opponentPlayerNum}Moves`] || 0;

            } else if (gameState.status === 'in-progress' && gamePlayMode === 'headtohead' && !hasStartedTurn) {
                // Head-to-head mode: both players play on same board
                console.log('[Player 2] Received game start signal - loading board from Firebase');
                if (gameState.gameBoard) {
                    gameBoard = gameState.gameBoard;
                    selectedDifficulty = gameState.difficulty;
                    selectedTheme = gameState.theme;
                    pairCount = gameState.pairCount;
                    console.log('[Player 2] Loaded game board from Firebase:', gameBoard);
                    console.log('[Player 2] Settings - difficulty:', selectedDifficulty, 'theme:', selectedTheme, 'pairs:', pairCount);
                    startGame();
                } else {
                    console.error('[Player 2] ERROR: Game board not found in Firebase state!');
                }

            } else if (gameState.status === 'player2-turn' && multiplayerSession.playerNumber === 2 && !hasStartedTurn) {
                console.log('[Player 2] My turn! Loading board from Firebase');
                // Load settings and board from Firebase
                if (gameState.gameBoard) {
                    gameBoard = gameState.gameBoard;
                    selectedDifficulty = gameState.difficulty;
                    selectedTheme = gameState.theme;
                    pairCount = gameState.pairCount;
                    console.log('[Player 2] Loaded game board:', gameBoard);
                    startGame();
                } else {
                    console.error('[Player 2] ERROR: Game board not found in Firebase state!');
                }
            } else if (gameState.status === 'finished') {
                console.log('Game finished, showing results');
                showResults();
            }
        }

        window.showSettings = function() {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.connecting-screen').classList.remove('active');
            document.querySelector('.settings-screen').classList.add('active');

            // If online mode and Player 2, disable buttons and show waiting message
            if (gameMode === 'online' && multiplayerSession && multiplayerSession.playerNumber === 2) {
                const settingsTitle = document.querySelector('.settings-screen h2');
                settingsTitle.textContent = 'Waiting for ' + playerNames.player1 + ' to select settings...';
                settingsTitle.style.color = '#764ba2';

                // Disable all buttons for Player 2
                document.querySelectorAll('.settings-screen button').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
            }
        };

        window.selectGameMode = function(mode) {
            gamePlayMode = mode;
            console.log('Game mode set to:', gamePlayMode);

            // Visual feedback: highlight selected button
            document.querySelectorAll('.difficulty-buttons button').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(mode === 'classic' ? 'classic' : 'head to head')) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        };

        window.selectDifficulty = function(difficulty) {
            selectedDifficulty = difficulty;

            switch(difficulty) {
                case 'easy': pairCount = 4; break;
                case 'medium': pairCount = 6; break;
                case 'hard': pairCount = 8; break;
                case 'expert': pairCount = 10; break;
                case 'master': pairCount = 15; break;
                case 'insane': pairCount = 18; break;
            }

            // Visual feedback: highlight selected button
            document.querySelectorAll('.difficulty-buttons button').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(difficulty)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        };

        window.selectTheme = async function(theme) {
            selectedTheme = theme;

            // Visual feedback: clear ALL theme selections first, then highlight selected
            document.querySelectorAll('.settings-screen .theme-buttons button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Now add selected to the clicked theme
            document.querySelectorAll('.settings-screen .theme-buttons button').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${theme}'`)) {
                    btn.classList.add('selected');
                }
            });

            if (gameMode === 'online') {
                // Only Player 1 can select settings and start the game in online mode
                if (multiplayerSession.playerNumber !== 1) {
                    console.log('[Player 2] Waiting for Player 1 to select settings...');
                    return;
                }

                // For head-to-head mode, Player 1 needs to create and send the board immediately
                let initialGameBoard = null;
                if (gamePlayMode === 'headtohead') {
                    const themeContent = getThemeContent(selectedTheme);
                    const selectedItems = themeContent.slice(0, pairCount);
                    const cardPairs = [...selectedItems, ...selectedItems];
                    initialGameBoard = cardPairs.sort(() => Math.random() - 0.5);
                    console.log('[Player 1] Created game board:', initialGameBoard);
                }

                // Update settings in Firebase (including gameBoard for head-to-head)
                const gameStateUpdate = {
                    difficulty: selectedDifficulty,
                    theme: selectedTheme,
                    pairCount: pairCount,
                    gamePlayMode: gamePlayMode,
                    status: 'in-progress',
                    currentPlayer: 1,
                    currentTurnPlayer: 1
                };

                if (initialGameBoard) {
                    gameStateUpdate.gameBoard = initialGameBoard;
                    gameStateUpdate.flippedCardIndices = [];
                    gameStateUpdate.matchedCardIndices = [];
                }

                console.log('[Player 1] Syncing game settings to Firebase...');
                await multiplayerSession.updateGameState(gameStateUpdate);

                if (initialGameBoard) {
                    gameBoard = initialGameBoard;
                }
                startGame();
            } else {
                startGame();
            }
        };

        function createBoard() {
            const themeContent = getThemeContent(selectedTheme);
            const selectedItems = themeContent.slice(0, pairCount);
            const cardPairs = [...selectedItems, ...selectedItems];
            return cardPairs.sort(() => Math.random() - 0.5);
        }

        async function startGame() {
            if (gameMode === 'online') {
                // Validate that we have a game board in online mode
                if (gamePlayMode === 'headtohead') {
                    if (!gameBoard || gameBoard.length === 0) {
                        console.error('[ERROR] startGame called but gameBoard is empty in online head-to-head mode!');
                        console.error('This should never happen - board should be created by Player 1 or loaded from Firebase');
                        return; // Don't start the game without a valid board
                    }
                    console.log(`[Player ${multiplayerSession.playerNumber}] Starting game with board:`, gameBoard);
                }

                // For classic mode, Player 1 creates board when needed
                if (gamePlayMode === 'classic' && multiplayerSession.playerNumber === 1 && currentPlayer === 1 && !gameBoard.length) {
                    gameBoard = createBoard();
                    await multiplayerSession.updateGameState({
                        gameBoard: gameBoard
                    });
                }
                hasStartedTurn = true;
            } else {
                // Local mode
                if (gamePlayMode === 'classic') {
                    if (currentPlayer === 1) {
                        gameBoard = createBoard();
                    }
                } else {
                    // Head-to-head: create board only once
                    if (!gameBoard.length) {
                        gameBoard = createBoard();
                    }
                }
            }

            cards = [...gameBoard];
            flippedCards = [];
            matchedPairs = 0;
            matchedCardIndices = [];
            lastFlippedIndices = [];
            moves = 0;
            score = 0;
            canFlip = true;

            // For head-to-head mode, reset turn player
            if (gamePlayMode === 'headtohead') {
                currentTurnPlayer = 1;
                // Reset both players' scores if starting new game
                if (!gameBoard.length || currentPlayer === 1) {
                    player1Score = 0;
                    player1Matches = 0;
                    player2Score = 0;
                    player2Matches = 0;
                }
            }

            // Hide all other screens and show game screen
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.settings-screen').classList.remove('active');
            document.querySelector('.opponent-playing-screen').classList.remove('active');
            document.querySelector('.connecting-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.waiting-room-screen').classList.remove('active');
            document.querySelector('.game-screen').classList.add('active');

            // Show/hide appropriate stats display
            if (gamePlayMode === 'headtohead') {
                document.getElementById('classicStats').style.display = 'none';
                document.getElementById('headToHeadStats').style.display = 'grid';

                // Update player names in head-to-head stats
                document.getElementById('p1NameLive').textContent = playerNames.player1;
                document.getElementById('p2NameLive').textContent = playerNames.player2;
            } else {
                document.getElementById('classicStats').style.display = 'flex';
                document.getElementById('headToHeadStats').style.display = 'none';
            }

            if (gameMode === 'online' && gamePlayMode === 'headtohead') {
                // In online head-to-head, show whose turn it is
                const isMyTurn = multiplayerSession.playerNumber === currentTurnPlayer;
                const turnPlayerName = playerNames[`player${currentTurnPlayer}`];
                document.getElementById('playerIndicator').textContent = isMyTurn ?
                    'Your Turn' :
                    `${turnPlayerName}'s Turn`;
            } else if (gameMode === 'online') {
                document.getElementById('playerIndicator').textContent = 'Your Turn';
            } else if (gamePlayMode === 'headtohead') {
                document.getElementById('playerIndicator').textContent = `${playerNames[`player${currentTurnPlayer}`]}'s Turn`;
            } else {
                document.getElementById('playerIndicator').textContent = `${playerNames[`player${currentPlayer}`]}'s Turn`;
            }

            renderBoard();
            updateStats();

            // Start inactivity timer
            startInactivityTimer();
        }

        function renderBoard() {
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = '';

            // Set grid class based on difficulty
            grid.className = 'memory-grid';
            if (pairCount === 4) grid.classList.add('grid-2x4');
            else if (pairCount === 6) grid.classList.add('grid-3x4');
            else if (pairCount === 8) grid.classList.add('grid-4x4');
            else if (pairCount === 10) grid.classList.add('grid-4x5');
            else if (pairCount === 15) grid.classList.add('grid-5x6');
            else if (pairCount === 18) grid.classList.add('grid-6x6');

            // Check if theme is image-based
            const isImageTheme = themeMetadata[selectedTheme]?.type === 'image';

            cards.forEach((content, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                if (isImageTheme) card.classList.add('image-card');
                card.dataset.index = index;

                let cardFrontHTML;
                if (isImageTheme) {
                    cardFrontHTML = `
                        <span class="card-front">
                            <img src="${content}"
                                 alt="Memory card"
                                 loading="lazy"
                                 onerror="handleImageError(this, ${index})">
                        </span>
                    `;
                } else {
                    cardFrontHTML = `<span class="card-front">${content}</span>`;
                }

                card.innerHTML = cardFrontHTML;
                card.addEventListener('click', () => flipCard(index));
                grid.appendChild(card);
            });
        }

        async function flipCard(index) {
            if (!canFlip) return;

            // In online head-to-head mode, only allow the current turn player to flip
            if (gameMode === 'online' && gamePlayMode === 'headtohead') {
                if (multiplayerSession.playerNumber !== currentTurnPlayer) {
                    console.log(`Not your turn! It's Player ${currentTurnPlayer}'s turn.`);
                    return;
                }
            }

            const card = document.querySelector(`[data-index="${index}"]`);
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
            if (flippedCards.length >= 2) return;

            card.classList.add('flipped');
            flippedCards.push(index);

            // Sync flipped cards immediately in online head-to-head mode
            if (gameMode === 'online' && gamePlayMode === 'headtohead') {
                myLastFlipTime = Date.now(); // Track when I flipped
                await multiplayerSession.updateGameState({
                    flippedCardIndices: [...flippedCards]
                });
            }

            if (flippedCards.length === 2) {
                if (gamePlayMode === 'classic') {
                    moves++;
                }
                updateStats();

                if (gameMode === 'online') {
                    await syncGameState();
                }

                checkMatch();
            }
        }

        async function syncGameState() {
            if (gamePlayMode === 'headtohead') {
                // In head-to-head mode, sync both players' scores
                await multiplayerSession.updateGameState({
                    player1Score: player1Score,
                    player1Matches: player1Matches,
                    player2Score: player2Score,
                    player2Matches: player2Matches,
                    currentTurnPlayer: currentTurnPlayer
                });
            } else {
                // In classic mode, sync only current player's stats
                const playerNum = multiplayerSession.playerNumber;
                await multiplayerSession.updateGameState({
                    [`player${playerNum}Score`]: score,
                    [`player${playerNum}Moves`]: moves,
                    [`player${playerNum}Matches`]: matchedPairs
                });
            }
        }

        function checkMatch() {
            canFlip = false;
            const [index1, index2] = flippedCards;
            const card1 = document.querySelector(`[data-index="${index1}"]`);
            const card2 = document.querySelector(`[data-index="${index2}"]`);

            if (cards[index1] === cards[index2]) {
                setTimeout(async () => {
                    console.log(`[Player ${gameMode === 'online' ? multiplayerSession.playerNumber : currentPlayer}] MATCH! Cards ${index1} and ${index2}`);

                    // Update game state
                    matchedPairs++;
                    matchedCardIndices.push(index1, index2);

                    if (gamePlayMode === 'headtohead') {
                        // In head-to-head, update current turn player's score
                        if (currentTurnPlayer === 1) {
                            player1Score += 10;
                            player1Matches++;
                        } else {
                            player2Score += 10;
                            player2Matches++;
                        }
                        console.log(`Player ${currentTurnPlayer} found a match! They continue.`);
                    } else {
                        score += 10;
                    }

                    // Clear flipped cards array
                    flippedCards = [];
                    canFlip = true;
                    updateStats();

                    if (gameMode === 'online' && gamePlayMode === 'headtohead') {
                        // In online head-to-head mode, sync to Firebase and let it handle the UI update
                        myLastFlipTime = 0;

                        console.log(`[Player ${multiplayerSession.playerNumber}] Syncing match to Firebase: matchedCardIndices=${matchedCardIndices}`);

                        await multiplayerSession.updateGameState({
                            player1Score: player1Score,
                            player1Matches: player1Matches,
                            player2Score: player2Score,
                            player2Matches: player2Matches,
                            matchedCardIndices: [...matchedCardIndices],
                            flippedCardIndices: []
                        });

                        console.log(`[Player ${multiplayerSession.playerNumber}] Match sync complete`);
                    } else if (gameMode === 'online') {
                        // Classic mode online
                        await syncGameState();
                    } else {
                        // Local mode - update UI immediately
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                    }

                    if (matchedPairs === pairCount) {
                        endGame();
                    }
                }, 500);
            } else {
                setTimeout(async () => {
                    console.log(`[Player ${gameMode === 'online' ? multiplayerSession.playerNumber : currentPlayer}] No match! Flipping cards back...`);
                    console.log(`[Player ${gameMode === 'online' ? multiplayerSession.playerNumber : currentPlayer}] Cards to flip back:`, [index1, index2]);

                    if (gamePlayMode === 'headtohead') {
                        // No match: switch turn to other player
                        currentTurnPlayer = currentTurnPlayer === 1 ? 2 : 1;
                        console.log(`No match! Switching to Player ${currentTurnPlayer}`);

                        if (gameMode === 'online') {
                            const isMyTurn = multiplayerSession.playerNumber === currentTurnPlayer;
                            const turnPlayerName = playerNames[`player${currentTurnPlayer}`];
                            document.getElementById('playerIndicator').textContent = isMyTurn ?
                                'Your Turn' :
                                `${turnPlayerName}'s Turn`;

                            // Clear local state
                            flippedCards = [];
                            myLastFlipTime = 0;

                            console.log(`[Player ${multiplayerSession.playerNumber}] Syncing to Firebase: currentTurnPlayer=${currentTurnPlayer}, flippedCardIndices=[]`);

                            // Sync to Firebase first
                            await multiplayerSession.updateGameState({
                                currentTurnPlayer: currentTurnPlayer,
                                flippedCardIndices: []
                            });

                            console.log(`[Player ${multiplayerSession.playerNumber}] Firebase sync complete`);

                            // ALSO flip back locally to ensure immediate visual feedback
                            // This ensures cards flip back even if Firebase update is delayed
                            card1.classList.remove('flipped');
                            card2.classList.remove('flipped');
                            console.log(`[Player ${multiplayerSession.playerNumber}] Local flip-back complete`);
                        } else {
                            // Local mode: flip back locally
                            card1.classList.remove('flipped');
                            card2.classList.remove('flipped');
                            document.getElementById('playerIndicator').textContent = `${playerNames[`player${currentTurnPlayer}`]}'s Turn`;
                            flippedCards = [];
                        }
                    } else {
                        // Classic mode
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        score -= 2;
                        flippedCards = [];
                    }

                    canFlip = true;
                    updateStats();
                }, 1000);
            }
        }

        function updateStats() {
            if (gamePlayMode === 'headtohead') {
                // Update head-to-head stats for both players
                document.getElementById('p1ScoreLive').textContent = player1Score;
                document.getElementById('p1MatchesLive').textContent = player1Matches;
                document.getElementById('p2ScoreLive').textContent = player2Score;
                document.getElementById('p2MatchesLive').textContent = player2Matches;

                // Highlight active player's box
                const p1Box = document.getElementById('player1StatsBox');
                const p2Box = document.getElementById('player2StatsBox');
                if (currentTurnPlayer === 1) {
                    p1Box.classList.add('active-turn');
                    p2Box.classList.remove('active-turn');
                } else {
                    p1Box.classList.remove('active-turn');
                    p2Box.classList.add('active-turn');
                }
            } else {
                // Classic mode stats
                document.getElementById('score').textContent = score;
                document.getElementById('moves').textContent = moves;
                document.getElementById('matches').textContent = matchedPairs;
            }
        }

        async function endGame() {
            // Stop inactivity timer
            stopInactivityTimer();

            if (gamePlayMode === 'headtohead') {
                // In head-to-head mode, game ends immediately
                console.log('Head-to-head game finished!');

                if (gameMode === 'online') {
                    await multiplayerSession.updateGameState({
                        status: 'finished',
                        player1Score: player1Score,
                        player1Matches: player1Matches,
                        player2Score: player2Score,
                        player2Matches: player2Matches
                    });
                }

                setTimeout(() => {
                    showResults();
                }, 1000);

            } else if (gameMode === 'online') {
                // Classic mode online
                const playerNum = multiplayerSession.playerNumber;
                const updates = {
                    [`player${playerNum}Score`]: score,
                    [`player${playerNum}Moves`]: moves,
                    [`player${playerNum}Matches`]: matchedPairs
                };

                if (playerNum === 1) {
                    updates.status = 'player2-turn';
                    updates.currentPlayer = 2;
                    console.log('Player 1 finished, switching to Player 2');

                    await multiplayerSession.updateGameState(updates);

                    document.querySelector('.game-screen').classList.remove('active');
                    document.querySelector('.opponent-playing-screen').classList.add('active');
                    document.getElementById('opponentPlayingTitle').textContent = `${playerNames.player2} is playing...`;
                } else {
                    updates.status = 'finished';
                    updates.currentPlayer = 0;
                    console.log('Player 2 finished, game over');

                    await multiplayerSession.updateGameState(updates);
                }
            } else {
                // Classic mode local
                if (currentPlayer === 1) {
                    player1Score = score;
                    player1Moves = moves;
                    player1Matches = matchedPairs;

                    setTimeout(() => {
                        currentPlayer = 2;
                        document.getElementById('playerIndicator').textContent = `${playerNames.player2}'s Turn`;

                        setTimeout(() => {
                            startGame();
                        }, 1000);
                    }, 1500);
                } else {
                    player2Score = score;
                    player2Moves = moves;
                    player2Matches = matchedPairs;

                    setTimeout(() => {
                        showResults();
                    }, 1000);
                }
            }
        }

        function showResults() {
            document.querySelector('.game-screen').classList.remove('active');
            document.querySelector('.opponent-playing-screen').classList.remove('active');
            document.querySelector('.end-screen').classList.add('active');

            // Update player names
            document.getElementById('p1NameResult').textContent = playerNames.player1;
            document.getElementById('p2NameResult').textContent = playerNames.player2;

            document.getElementById('p1Score').textContent = player1Score;
            document.getElementById('p1Matches').textContent = player1Matches;

            document.getElementById('p2Score').textContent = player2Score;
            document.getElementById('p2Matches').textContent = player2Matches;

            // In head-to-head mode, we don't track moves separately
            if (gamePlayMode === 'headtohead') {
                document.getElementById('p1Moves').textContent = '-';
                document.getElementById('p2Moves').textContent = '-';
            } else {
                document.getElementById('p1Moves').textContent = player1Moves;
                document.getElementById('p2Moves').textContent = player2Moves;
            }

            let winnerText = '';
            if (player1Score > player2Score) {
                winnerText = `üèÜ ${playerNames.player1} Wins!`;
            } else if (player2Score > player1Score) {
                winnerText = `üèÜ ${playerNames.player2} Wins!`;
            } else {
                winnerText = 'ü§ù It\'s a Tie!';
            }

            document.getElementById('finalScore').textContent = winnerText;

            const scoreDiff = Math.abs(player1Score - player2Score);
            if (scoreDiff === 0) {
                document.getElementById('finalMessage').textContent = 'Perfectly matched minds!';
            } else if (scoreDiff <= 5) {
                document.getElementById('finalMessage').textContent = 'So close! Great game!';
            } else {
                document.getElementById('finalMessage').textContent = 'Well played!';
            }

            if (gameMode === 'online') {
                multiplayerSession.endSession();
                // Clear active session since game is over
                MultiplayerSession.clearActiveSession();
            }
        }
    </script>
</body>
</html>
