<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossword Clash - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Shared Styles */
        * {
            transition: all 0.2s ease;
        }

        .player-indicator {
            text-align: center; font-size: 1.2em; font-weight: bold; color: #764ba2;
            padding: 10px; background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            border-radius: 25px; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .cw-container {
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }

        .grid-wrapper {
            background: linear-gradient(145deg, #2c2c2c, #3a3a3a);
            padding: 8px; border-radius: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.1);
        }

        .cw-grid {
            display: grid; gap: 2px; background: #2c2c2c;
            border: 3px solid #444;
            border-radius: 15px;
            overflow: hidden;
        }

        .cell {
            background: white; position: relative; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2em; text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .cell:hover:not(.black):not(.correct) {
            background: #f5f5f5;
            transform: scale(1.05);
        }

        .cell.black {
            background: linear-gradient(145deg, #1a1a1a, #2c2c2c);
            cursor: default;
        }

        .cell.selected {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.6), inset 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1.08);
        }

        .cell.correct {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            color: #1b5e20;
            animation: correctPulse 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        @keyframes correctPulse {
            0% {
                transform: scale(1) rotate(0deg);
                background: white;
                box-shadow: 0 0 0 rgba(76, 175, 80, 0);
            }
            30% {
                transform: scale(1.15) rotate(2deg);
                background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
            }
            50% {
                transform: scale(1.2) rotate(-2deg);
            }
            70% {
                transform: scale(1.1) rotate(1deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            }
        }

        .cell.hint {
            animation: hintReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes hintReveal {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 152, 0, 0);
            }
            25% {
                transform: scale(1.2) rotateY(90deg);
                box-shadow: 0 0 30px rgba(255, 152, 0, 0.9);
            }
            50% {
                transform: scale(1.3) rotateY(180deg);
                box-shadow: 0 0 40px rgba(255, 152, 0, 1);
            }
            75% {
                transform: scale(1.2) rotateY(270deg);
                box-shadow: 0 0 30px rgba(255, 152, 0, 0.9);
            }
            100% {
                transform: scale(1) rotateY(360deg);
                box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            }
        }

        .cell-num {
            position: absolute; top: 1px; left: 2px;
            font-size: 0.5em; color: #666; font-weight: normal;
            pointer-events: none;
        }

        .clues-container {
            width: 100%; margin-top: 20px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }

        .clue-box {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .clue-box h3 {
            color: #667eea;
            border-bottom: 3px solid #eef2ff;
            padding-bottom: 8px;
            margin-top: 0;
        }

        .clue-list {
            list-style: none; padding: 0;
            max-height: 200px; overflow-y: auto;
        }

        .clue-item {
            padding: 8px 10px; font-size: 0.9em;
            cursor: pointer;
            border-radius: 10px;
            margin: 4px 0;
        }

        .clue-item:hover {
            color: #764ba2;
            font-weight: bold;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            transform: translateX(5px);
        }

        .clue-item.active {
            color: #764ba2;
            font-weight: bold;
            background: linear-gradient(135deg, #e8ecff 0%, #dce4ff 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        /* Hint Modal */
        .hint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .hint-modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .hint-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .hint-content h2 {
            color: #ff9800;
            margin-top: 0;
            font-size: 1.5em;
        }

        .hint-clue {
            font-size: 1.2em;
            color: #333;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 15px;
            border-left: 4px solid #ff9800;
        }

        .hint-reveal {
            font-size: 1.1em;
            color: #2c5282;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e6f3ff 0%, #cfe8ff 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        /* Mobile */
        @media(max-width: 600px) {
            .cell { width: 30px; height: 30px; font-size: 1em; }
            .clues-container { grid-template-columns: 1fr; }
            .hint-content {
                padding: 20px;
                width: 90%;
            }
        }

        /* Screens */
        .start-screen, .game-screen, .end-screen, .online-lobby-screen,
        .create-game-screen, .join-game-screen, .waiting-room-screen,
        .connecting-screen {
            display: none;
        }
        .active { display: block; }

        button {
            width: 100%; padding: 12px; font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 25px;
            margin-top: 10px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        /* Particle effect */
        @keyframes particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx, 0), var(--ty, -50px)) scale(0);
                opacity: 0;
            }
        }

        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
            animation: particle 0.8s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="game-container" style="max-width: 800px; margin: 0 auto; padding: 15px;">
        <div class="game-header">
            <a href="../index.html" class="back-link">‚Üê Back to Games</a>
            <div class="mode-toggle" role="group" aria-label="Play mode">
                <button type="button" class="mode-btn" data-mode="local">üè† Local</button>
                <button type="button" class="mode-btn" data-mode="online">üåê Online</button>
            </div>
        </div>
        <p class="mode-status">Mode: <span id="modeBadge">Local</span></p>
        <h1 class="game-title">üß© Crossword Clash</h1>
        <p class="game-subtitle">Race to complete the puzzle!</p>

        <div class="start-screen active">
            <div style="background: #f8f9ff; padding: 20px; border-radius: 25px; margin-bottom: 20px;">
                <h3>How to Play:</h3>
                <p>Race to finish the puzzle! First to complete all words correctly wins.</p>
            </div>
            <h3>Select Puzzle:</h3>
            <div style="display: grid; gap: 10px;">
                <button onclick="selectPuzzle('mini')">‚ö° Mini (5x5)</button>
                <button onclick="selectPuzzle('midi')">üß† Midi (7x7)</button>
                <button onclick="selectPuzzle('daily')">üìÖ Daily (10x10)</button>
            </div>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button onclick="showOnlineLobby()" style="background: white; color: #667eea; border: 2px solid #667eea;">üåê Play Online</button>
            </div>
        </div>

        <div class="online-lobby-screen">
            <h2>Online Lobby</h2>
            <button onclick="createGame()">Create Game</button>
            <button onclick="joinGameUI()">Join Game</button>
            <button onclick="location.reload()" style="background: #eee; color: #333;">Back</button>
        </div>
        <div class="create-game-screen">
            <input id="p1Name" placeholder="Your Name" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <button onclick="doCreate()">Get Code</button>
        </div>
        <div class="join-game-screen">
            <input id="p2Name" placeholder="Your Name" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <input id="code" placeholder="Game Code" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <button onclick="doJoin()">Join</button>
        </div>
        <div class="waiting-room-screen">
            <h2>Game Code: <span id="sessCode">---</span></h2>
            <p>Waiting for opponent...</p>
        </div>

        <div class="game-screen">
            <div class="player-indicator" id="timer">Time: 00:00</div>

            <div style="text-align: center; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%); border-radius: 25px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);">
                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="progress">0%</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Completed</div>
            </div>

            <div class="cw-container">
                <div class="grid-wrapper">
                    <div id="grid" class="cw-grid"></div>
                </div>
            </div>

            <div class="clues-container">
                <div class="clue-box">
                    <h3>Across</h3>
                    <ul id="accClues" class="clue-list"></ul>
                </div>
                <div class="clue-box">
                    <h3>Down</h3>
                    <ul id="downClues" class="clue-list"></ul>
                </div>
            </div>

            <button onclick="getHint()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">üí° Get Hint (<span id="hintsLeft">3</span> left)</button>
            <button onclick="location.reload()" style="background: transparent; color: #e74c3c; border: 2px solid #e74c3c;">Quit</button>
        </div>

        <!-- Hint Modal -->
        <div class="hint-modal" id="hintModal">
            <div class="hint-content">
                <h2>üí° Hint</h2>
                <div class="hint-clue" id="hintClueText"></div>
                <div class="hint-reveal" id="hintRevealText"></div>
                <button onclick="closeHintModal()" style="margin-top: 20px;">Got it!</button>
            </div>
        </div>

        <div class="end-screen">
            <h1 style="text-align: center;">üéâ Puzzle Solved!</h1>
            <h2 id="winnerText" style="text-align: center; color: #667eea;"></h2>
            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script src="../js/mode-toggle.js"></script>
    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        const urlParams = new URLSearchParams(window.location.search);
        const playMode = urlParams.get('mode') || 'local';
        initModeToggle(playMode);

        // --- Puzzles Data ---
        const puzzles = {
            mini: {
                rows: 5, cols: 5,
                grid: [
                    ['H','E','A','R','T'],
                    ['A','R','E','A','S'],
                    ['P','R','O','N','E'],
                    ['P','O','N','D','S'],
                    ['Y','E','A','R','S']
                ],
                clues: {
                    across: { 1: "Symbol of love", 6: "Regions", 7: "Lying face down", 8: "Small lakes", 9: "Periods of time" },
                    down: { 1: "Cheerful", 2: "Wrong judgement", 3: "Very long time", 4: "Standard", 5: "These (spanish)" }
                },
                hints: {
                    across: {
                        1: "Often drawn in red or pink",
                        6: "Different zones or territories",
                        7: "Opposite of supine",
                        8: "Good for fishing or ducks",
                        9: "Measured by the calendar"
                    },
                    down: {
                        1: "Full of joy and smiles",
                        2: "A mistake in decision making",
                        3: "Longer than ages",
                        4: "The usual or typical way",
                        5: "Spanish word for 'these'"
                    }
                },
                nums: { '0-0':1, '0-1':2, '0-2':3, '0-3':4, '0-4':5, '1-0':6, '2-0':7, '3-0':8, '4-0':9 }
            },
            midi: {
                rows: 5, cols: 5,
                grid: [
                    ['S','P','A','C','E'],
                    ['T','O','A','S','T'],
                    ['A','P','P','L','E'],
                    ['R','E','L','A','X'],
                    ['T','R','E','N','D']
                ],
                clues: {
                    across: { 1: "The final frontier", 4: "Breakfast bread", 5: "Keeps doctor away", 6: "Chill out", 7: "Viral fashion" },
                    down: { 1: "Begin", 2: "Pop", 3: "Apply", 4: "Clean", 5: "End" }
                },
                hints: {
                    across: {
                        1: "Where astronauts go",
                        4: "Often buttered and crispy",
                        5: "Comes in Red Delicious variety",
                        6: "Take it easy and unwind",
                        7: "What's popular on TikTok"
                    },
                    down: {
                        1: "Initiate or launch",
                        2: "Soda or burst",
                        3: "Put on or submit",
                        4: "Wash or tidy",
                        5: "Finish or terminate"
                    }
                },
                nums: { '0-0':1, '1-0':4, '2-0':5, '3-0':6, '4-0':7 }
            },
            daily: {
                rows: 5, cols: 5,
                grid: [
                    ['L','O','V','E','S'],
                    ['I','D','E','A','L'],
                    ['G','A','M','E','S'],
                    ['H','O','P','E','S'],
                    ['T','R','U','S','T']
                ],
                clues: {
                    across: { 1: "Romantic feelings", 6: "Perfect", 7: "Fun activities", 8: "Wishes", 9: "Faith in partner" },
                    down: { 1: "Bright", 2: "Ode", 3: "Vamp", 4: "Ales", 5: "Last" }
                },
                hints: {
                    across: {
                        1: "What couples feel for each other",
                        6: "Flawless or without faults",
                        7: "Board games, video games, card games",
                        8: "Dreams and aspirations",
                        9: "Foundation of any relationship"
                    },
                    down: {
                        1: "Shining or illuminated",
                        2: "Type of poem",
                        3: "Seductress or femme fatale",
                        4: "Types of beer",
                        5: "Final or most recent"
                    }
                },
                nums: { '0-0':1, '1-0':6, '2-0':7, '3-0':8, '4-0':9 }
            }
        };

        // --- State ---
        let currentPuzzle = null;
        let selectedCell = null;
        let direction = 'across';
        let timerInt;
        let seconds = 0;
        let multiplayer = null;
        let isOnline = false;
        let hintsRemaining = 3;

        // --- UI Logic ---
        window.selectPuzzle = (type) => {
            currentPuzzle = puzzles[type] || puzzles.mini;
            hintsRemaining = 3;
            seconds = 0;
            if (isOnline) {
                multiplayer.updateGameState({ puzzleType: type, status: 'playing' });
            } else {
                startGame();
            }
        };

        function startGame() {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.game-screen').classList.add('active');

            // Update hints counter display
            document.getElementById('hintsLeft').textContent = hintsRemaining;

            renderGrid();
            renderClues();
            startTimer();
        }

        function renderGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.style.gridTemplateColumns = `repeat(${currentPuzzle.cols}, 1fr)`;
            gridEl.innerHTML = '';

            for(let r=0; r<currentPuzzle.rows; r++) {
                for(let c=0; c<currentPuzzle.cols; c++) {
                    const letter = currentPuzzle.grid[r][c];
                    const div = document.createElement('div');
                    div.className = 'cell';
                    if (letter === '#') div.classList.add('black');
                    else {
                        div.dataset.r = r;
                        div.dataset.c = c;
                        div.dataset.letter = letter;
                        div.contentEditable = true;
                        div.onclick = () => focusCell(div);
                        div.onkeydown = (e) => handleInput(e, div);
                        div.oninput = (e) => handleMobileInput(e, div);
                        div.onpaste = (e) => e.preventDefault(); // Prevent paste
                        div.setAttribute('autocomplete', 'off');
                        div.setAttribute('autocorrect', 'off');
                        div.setAttribute('autocapitalize', 'off');
                        div.setAttribute('spellcheck', 'false');
                        div.setAttribute('inputmode', 'text');

                        // Number
                        const key = `${r}-${c}`;
                        if (currentPuzzle.nums && currentPuzzle.nums[key]) {
                            div.innerHTML = `<span class="cell-num">${currentPuzzle.nums[key]}</span>`;
                        }
                    }
                    gridEl.appendChild(div);
                }
            }
        }

        function renderClues() {
            const aList = document.getElementById('accClues');
            const dList = document.getElementById('downClues');
            aList.innerHTML = ''; dList.innerHTML = '';

            Object.keys(currentPuzzle.clues.across).forEach(k => {
                aList.innerHTML += `<li class="clue-item"><strong>${k}:</strong> ${currentPuzzle.clues.across[k]}</li>`;
            });
            Object.keys(currentPuzzle.clues.down).forEach(k => {
                dList.innerHTML += `<li class="clue-item"><strong>${k}:</strong> ${currentPuzzle.clues.down[k]}</li>`;
            });
        }

        function focusCell(div) {
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
            div.focus();
        }

        function handleInput(e, div) {
            e.preventDefault();
            if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                // Remove existing num span if overwriting
                const num = div.querySelector('.cell-num');
                div.innerText = e.key.toUpperCase();
                if(num) div.appendChild(num); // Keep num

                // Check if correct immediately
                checkCell(div);

                // Move focus
                moveFocus(div, 1);

                // Check progress
                updateProgress();
            } else if (e.key === 'Backspace') {
                const num = div.querySelector('.cell-num');
                div.innerText = '';
                if(num) div.appendChild(num);
                div.classList.remove('correct');
                moveFocus(div, -1);
                updateProgress();
            }
        }

        function handleMobileInput(e, div) {
            // Handle mobile keyboard input
            const num = div.querySelector('.cell-num');
            let text = div.innerText.replace(/[^a-zA-Z]/g, '').toUpperCase();

            // Prevent entering more than 1 character
            if (text.length > 1) {
                text = text.charAt(text.length - 1);
            }

            // Clear and rebuild the cell content
            div.innerHTML = '';
            if (num) div.appendChild(num);

            if (text.length === 1) {
                // Add the text node
                div.appendChild(document.createTextNode(text));

                // Check correctness with animation
                const wasCorrect = div.classList.contains('correct');
                checkCell(div);
                const isNowCorrect = div.classList.contains('correct');

                // Only move forward if newly correct or if typing
                if (isNowCorrect && !wasCorrect) {
                    // Trigger animation
                    setTimeout(() => {
                        moveFocus(div, 1);
                    }, 100);
                } else if (!isNowCorrect) {
                    // Just move forward on any input
                    setTimeout(() => {
                        moveFocus(div, 1);
                    }, 50);
                }

                updateProgress();
            } else if (text.length === 0) {
                // Deleted - keep num if exists
                div.classList.remove('correct');
                updateProgress();
            }
        }

        function checkCell(div) {
            const val = div.innerText.replace(/[0-9]/g, '').trim();
            if (val && val === div.dataset.letter) {
                const wasCorrect = div.classList.contains('correct');
                div.classList.remove('correct');
                // Force reflow to restart animation
                void div.offsetWidth;
                div.classList.add('correct');
                div.contentEditable = false; // Lock correct cells

                // Add particle effect on first correct entry
                if (!wasCorrect) {
                    createParticles(div);
                }
            } else {
                div.classList.remove('correct');
            }
        }

        function createParticles(div) {
            const rect = div.getBoundingClientRect();
            const colors = ['#4caf50', '#66bb6a', '#81c784', '#a5d6a7'];

            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = (rect.left + rect.width / 2) + 'px';
                particle.style.top = (rect.top + rect.height / 2) + 'px';

                const angle = (Math.PI * 2 * i) / 6;
                const distance = 40 + Math.random() * 20;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance - 30 + 'px');

                document.body.appendChild(particle);

                particle.addEventListener('animationend', () => {
                    particle.remove();
                });
            }
        }

        function updateProgress() {
            const total = document.querySelectorAll('.cell:not(.black)').length;
            const correct = document.querySelectorAll('.cell.correct').length;
            const percentage = Math.round((correct / total) * 100);

            const progressEl = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');

            if (progressEl) {
                progressEl.textContent = percentage + '%';
            }

            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }

            // Check if puzzle is complete
            if (correct === total) {
                setTimeout(() => {
                    completePuzzle();
                }, 500);
            }
        }

        function completePuzzle() {
            clearInterval(timerInt);
            document.querySelector('.game-screen').classList.remove('active');
            document.querySelector('.end-screen').classList.add('active');

            const mins = Math.floor(seconds/60).toString().padStart(2,'0');
            const secs = (seconds%60).toString().padStart(2,'0');
            document.getElementById('winnerText').textContent = `Completed in ${mins}:${secs}!`;
        }

        function moveFocus(div, step) {
            const r = parseInt(div.dataset.r);
            const c = parseInt(div.dataset.c);
            const cols = currentPuzzle.cols;

            // Try to move across (right/left) first
            let nextR = r;
            let nextC = c + step;

            // If out of bounds or hit black cell, try moving down/up instead
            if (nextC < 0 || nextC >= cols) {
                nextC = c;
                nextR = r + step;
            }

            // Find the next cell
            const cells = Array.from(document.querySelectorAll('.cell:not(.black)'));
            const next = cells.find(cell =>
                parseInt(cell.dataset.r) === nextR &&
                parseInt(cell.dataset.c) === nextC
            );

            if (next) {
                focusCell(next);
            }
        }

        function startTimer() {
            timerInt = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `Time: ${m}:${s}`;
            }, 1000);
        }

        function getHint() {
            if (hintsRemaining <= 0) {
                alert('No hints remaining!');
                return;
            }

            // Find all words that are not completely correct
            const incompleteWords = findIncompleteWords();

            if (incompleteWords.length === 0) {
                alert('Puzzle already complete!');
                return;
            }

            // Pick a random incomplete word to give a hint for
            const randomWord = incompleteWords[Math.floor(Math.random() * incompleteWords.length)];

            // Get the hint for this word
            const hintText = currentPuzzle.hints[randomWord.direction][randomWord.number];
            const clueText = currentPuzzle.clues[randomWord.direction][randomWord.number];

            // Show hint modal
            const hintModal = document.getElementById('hintModal');
            const hintClueText = document.getElementById('hintClueText');
            const hintRevealText = document.getElementById('hintRevealText');

            hintClueText.innerHTML = `<strong>${randomWord.number} ${randomWord.direction.charAt(0).toUpperCase() + randomWord.direction.slice(1)}:</strong><br>${clueText}`;
            hintRevealText.innerHTML = `<strong>üí° Additional Hint:</strong><br>${hintText}`;

            hintModal.classList.add('show');

            // Highlight the word cells
            randomWord.cells.forEach(cell => {
                if (!cell.classList.contains('correct')) {
                    cell.classList.add('hint');
                    setTimeout(() => {
                        cell.classList.remove('hint');
                    }, 2000);
                }
            });

            // Decrement hints
            hintsRemaining--;
            document.getElementById('hintsLeft').textContent = hintsRemaining;
        }

        function findIncompleteWords() {
            const incompleteWords = [];

            // Check all across clues
            Object.keys(currentPuzzle.clues.across).forEach(num => {
                const startPos = Object.entries(currentPuzzle.nums).find(([k, v]) => v == num);
                if (startPos) {
                    const [r, c] = startPos[0].split('-').map(Number);
                    const cells = [];
                    let allCorrect = true;

                    // Find all cells in this word
                    for (let i = c; i < currentPuzzle.cols; i++) {
                        if (currentPuzzle.grid[r][i] === '#') break;
                        const cell = document.querySelector(`.cell[data-r="${r}"][data-c="${i}"]`);
                        if (cell) {
                            cells.push(cell);
                            if (!cell.classList.contains('correct')) {
                                allCorrect = false;
                            }
                        }
                    }

                    if (!allCorrect && cells.length > 0) {
                        incompleteWords.push({
                            number: num,
                            direction: 'across',
                            cells: cells
                        });
                    }
                }
            });

            // Check all down clues
            Object.keys(currentPuzzle.clues.down).forEach(num => {
                const startPos = Object.entries(currentPuzzle.nums).find(([k, v]) => v == num);
                if (startPos) {
                    const [r, c] = startPos[0].split('-').map(Number);
                    const cells = [];
                    let allCorrect = true;

                    // Find all cells in this word
                    for (let i = r; i < currentPuzzle.rows; i++) {
                        if (currentPuzzle.grid[i][c] === '#') break;
                        const cell = document.querySelector(`.cell[data-r="${i}"][data-c="${c}"]`);
                        if (cell) {
                            cells.push(cell);
                            if (!cell.classList.contains('correct')) {
                                allCorrect = false;
                            }
                        }
                    }

                    if (!allCorrect && cells.length > 0) {
                        incompleteWords.push({
                            number: num,
                            direction: 'down',
                            cells: cells
                        });
                    }
                }
            });

            return incompleteWords;
        }

        window.closeHintModal = function() {
            const hintModal = document.getElementById('hintModal');
            hintModal.classList.remove('show');
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            const hintModal = document.getElementById('hintModal');
            if (hintModal) {
                hintModal.addEventListener('click', (e) => {
                    if (e.target === hintModal) {
                        closeHintModal();
                    }
                });
            }
        });

        window.checkPuzzle = async () => {
            let correct = true;
            document.querySelectorAll('.cell:not(.black)').forEach(c => {
                const val = c.innerText.replace(/[0-9]/g, '').trim();
                if (val !== c.dataset.letter) {
                    c.style.color = 'red';
                    correct = false;
                } else {
                    c.style.color = 'green';
                    c.classList.add('correct');
                }
            });

            if (correct) {
                clearInterval(timerInt);
                if (isOnline) {
                    await multiplayer.updateGameState({ status: 'finished', winner: multiplayer.playerName });
                } else {
                    showEnd("You Solved it!");
                }
            }
        };

        function showEnd(msg) {
            document.querySelector('.game-screen').classList.remove('active');
            document.querySelector('.end-screen').classList.add('active');
            document.getElementById('winnerText').innerText = msg;
        }

        // --- Online Logic ---
        window.showOnlineLobby = () => {
            isOnline = true;
            multiplayer = new MultiplayerSession('crossword');
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
        };

        window.createGame = () => {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.create-game-screen').classList.add('active');
        }

        window.doCreate = async () => {
            const name = document.getElementById('p1Name').value;
            if (!name) {
                alert('Please enter your name');
                return;
            }
            const res = await multiplayer.createSession(name);
            document.getElementById('sessCode').innerText = res.sessionId;
            document.querySelector('.create-game-screen').classList.remove('active');
            document.querySelector('.waiting-room-screen').classList.add('active');

            multiplayer.on('onPlayerJoined', () => {
                // P1 selects puzzle now
                document.querySelector('.waiting-room-screen').classList.remove('active');
                document.querySelector('.start-screen').classList.add('active');
                // Hide online button in start screen
                document.querySelector('.start-screen button:last-child').style.display='none';
            });

            multiplayer.on('onGameStateChange', (s) => {
                if(s.status === 'finished') showEnd(`${s.winner} Won!`);
            });
        }

        window.joinGameUI = () => {
             document.querySelector('.online-lobby-screen').classList.remove('active');
             document.querySelector('.join-game-screen').classList.add('active');
        }

        window.doJoin = async () => {
            const name = document.getElementById('p2Name').value;
            const code = document.getElementById('code').value;
            if (!name || !code) {
                alert('Please enter both name and game code');
                return;
            }
            await multiplayer.joinSession(code, name);
            document.querySelector('.join-game-screen').classList.remove('active');
            document.querySelector('.connecting-screen').classList.add('active');

            multiplayer.on('onGameStateChange', (s) => {
                if(s.status === 'playing') {
                    currentPuzzle = puzzles[s.puzzleType];
                    hintsRemaining = 3;
                    seconds = 0;
                    document.querySelector('.connecting-screen').classList.remove('active');
                    startGame();
                }
                if(s.status === 'finished') showEnd(`${s.winner} Won!`);
            });
        }
    </script>
</body>
</html>
