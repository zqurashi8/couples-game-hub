<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crossword Clash - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Shared Game Styles */
        .player-indicator {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            border: 2px solid #e0e4ff;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 100%;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .stat-label { font-size: 0.9em; opacity: 0.95; margin-bottom: 8px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }

        /* Crossword Specific Styles */
        .crossword-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            max-width: 100%;
            flex: 1;
            min-height: 0;
        }

        .crossword-grid {
            display: grid;
            background: #2c3e50;
            gap: 2px;
            border: 4px solid #2c3e50;
            border-radius: 12px;
            user-select: none;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }

        .cw-cell {
            background: #ffffff;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cw-cell.black {
            background: #34495e !important;
            cursor: default !important;
            pointer-events: none !important;
        }

        /* Selection Colors */
        .cw-cell.selected {
            background: #fff59d !important;
            box-shadow: inset 0 0 0 3px #667eea;
        }

        .cw-cell.active-word {
            background: #e3f2fd !important;
        }

        /* Validation Colors */
        .cw-cell.correct {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%) !important;
            color: #2e7d32 !important;
            font-weight: bold;
        }

        .cw-cell.correct.selected {
            background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%) !important;
            box-shadow: inset 0 0 0 3px #2e7d32;
        }

        .cw-number {
            position: absolute;
            top: 2%;
            left: 2%;
            font-size: 0.35em;
            color: #666;
            line-height: 1;
            pointer-events: none;
        }

        .cw-input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            background: transparent;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            padding: 0;
            outline: none;
            caret-color: transparent;
            cursor: pointer;
            border-radius: 0;
            -webkit-user-select: text;
        }

        .cw-input:focus {
            outline: none;
        }

        .clues-container {
            width: 100%;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 20px;
            border: none;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .clue-section h3 {
            color: #667eea;
            margin-bottom: 18px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            font-weight: bold;
        }

        .clue-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .clue-item {
            padding: 14px 16px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 1em;
            line-height: 1.6;
            color: #2c3e50;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: white;
        }

        .clue-item:hover {
            background: #e8ecff;
            border-color: #667eea;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .clue-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            border-color: #764ba2;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.35);
        }

        .clue-item.correct-clue {
            text-decoration: line-through;
            opacity: 0.4;
            background: #f0f0f0;
        }

        .clue-item strong {
            display: inline-block;
            min-width: 35px;
            color: #667eea;
            font-size: 1.15em;
            margin-right: 10px;
            font-weight: 700;
        }

        .clue-item.active strong {
            color: white;
        }

        /* Screens */
        .start-screen, .game-screen, .end-screen, .lobby-screen, .loading-screen {
            display: none;
            max-width: 100vw;
            overflow-x: hidden;
            height: 100%;
        }
        .active { display: block; }

        body { overflow-x: hidden; }

        .game-screen {
            padding: 0 5px;
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        .game-screen.active { display: flex; }
        
        button {
            width: 100%;
            padding: 18px 25px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            min-height: 56px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .hint-btn {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
            color: white;
            margin-top: 12px;
            box-shadow: 0 6px 20px rgba(255, 183, 77, 0.3);
        }

        .hint-btn:hover {
            box-shadow: 0 8px 25px rgba(255, 183, 77, 0.4);
        }

        .hint-btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .secondary-btn {
            background: white;
            color: #667eea;
            border: 3px solid #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .secondary-btn:hover {
            background: #f8f9ff;
            border-color: #764ba2;
            color: #764ba2;
        }

        .leave-game-btn {
            background: transparent;
            border: 3px solid #e74c3c;
            color: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.15);
        }

        .leave-game-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            border-color: #c0392b;
            color: #c0392b;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 6px solid #e8ecff;
            border-top: 6px solid #667eea;
            border-right: 6px solid #764ba2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s ease-in-out infinite;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (min-width: 1200px) {
            .crossword-container {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
            }
            .clues-container {
                width: 450px;
                max-height: 600px;
                overflow-y: auto;
                flex-shrink: 0;
            }
            .crossword-grid {
                flex-shrink: 0;
                width: 600px;
                height: 600px;
            }
            .cw-cell { font-size: 1.1em; }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .crossword-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 0 20px;
            }
            .clues-container {
                width: 100%;
                max-width: 500px;
                max-height: 350px;
                overflow-y: auto;
            }
            .cw-cell { font-size: 1em; }
        }

        @media (max-width: 767px) {
            .game-screen { height: auto; min-height: 100vh; }
            .crossword-container {
                flex-direction: column;
                width: 100%;
                padding: 0;
                align-items: center;
                gap: 10px;
            }
            .crossword-grid {
                width: 100%;
                max-width: 100%;
                aspect-ratio: 1/1;
                overflow: visible;
            }
            .cw-cell { font-size: clamp(10px, 4vw, 18px); }
            .clues-container {
                width: 100%;
                flex: 1;
                max-height: 40vh;
                overflow-y: auto;
                padding: 10px;
                margin-bottom: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <a href="../index.html" class="back-link">‚Üê Back to Games</a>
            <div class="mode-toggle" role="group" aria-label="Play mode">
                <button type="button" class="mode-btn" data-mode="local">üè† Local</button>
                <button type="button" class="mode-btn" data-mode="online">üåê Online</button>
            </div>
        </div>
        <p class="mode-status">Mode: <span id="modeBadge">Local</span></p>
        <h1 class="game-title">üß© Crossword Clash</h1>
        <p class="game-subtitle">Solve together or race to finish!</p>

        <div class="loading-screen active" id="loadingScreen" style="text-align: center; padding: 40px;">
            <h2 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 20px;">Loading Daily Puzzle...</h2>
            <div class="spinner"></div>
        </div>

        <div class="loading-screen" id="errorScreen" style="text-align: center; padding: 40px;">
            <div style="background: linear-gradient(135deg, #fee 0%, #fff 100%); padding: 30px; border-radius: 20px; margin-bottom: 25px; border: 3px solid #e74c3c; box-shadow: 0 8px 25px rgba(231, 76, 60, 0.2);">
                <h2 style="color: #e74c3c; font-size: 2em; margin-bottom: 15px;">‚ö†Ô∏è Oops!</h2>
                <p style="color: #2c3e50; font-size: 1.1em; margin-bottom: 10px;">Could not load the daily puzzle.</p>
                <p style="font-size: 0.95em; color: #666;">Make sure <code style="background: #f0f0f0; padding: 2px 8px; border-radius: 5px;">crossword-data.json</code> exists.</p>
            </div>
            <button onclick="location.reload()" class="secondary-btn" style="width: auto; margin-top: 20px; padding-left: 40px; padding-right: 40px;">üîÑ Try Again</button>
        </div>

        <div id="onlineScreens">
            <div class="online-lobby-screen lobby-screen">
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); padding: 30px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);">
                    <h2 style="text-align: center; color: #764ba2; margin-bottom: 15px; font-size: 2em;">üåê Play Online</h2>
                    <p style="text-align: center; color: #666; font-size: 1em;">Play with friends from anywhere!</p>
                </div>
                <div style="display: grid; gap: 15px;">
                    <button onclick="showCreateGame()">‚ûï Create Game</button>
                    <button class="secondary-btn" onclick="showJoinGame()">üîó Join Game</button>
                </div>
            </div>

            <div class="create-game-screen lobby-screen">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">Create Game</h2>
                <input type="text" id="p1Name" placeholder="Your Name" style="width: 100%; padding: 18px 20px; margin: 15px 0; border: 3px solid #e0e4ff; border-radius: 15px; font-size: 1.1em; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.2)';" onblur="this.style.borderColor='#e0e4ff'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.1)';">
                <button onclick="createGameSession()">Get Code</button>
                <button class="secondary-btn" onclick="backToLobby()">Back</button>
            </div>

            <div class="join-game-screen lobby-screen">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">Join Game</h2>
                <input type="text" id="p2Name" placeholder="Your Name" style="width: 100%; padding: 18px 20px; margin: 10px 0; border: 3px solid #e0e4ff; border-radius: 15px; font-size: 1.1em; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.2)';" onblur="this.style.borderColor='#e0e4ff'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.1)';">
                <input type="text" id="joinCode" placeholder="Game Code" style="width: 100%; padding: 18px 20px; margin-bottom: 15px; border: 3px solid #e0e4ff; border-radius: 15px; text-transform: uppercase; font-size: 1.1em; letter-spacing: 2px; font-weight: bold; text-align: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.2)';" onblur="this.style.borderColor='#e0e4ff'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.1)';">
                <button onclick="joinGameSession()">Join</button>
                <button class="secondary-btn" onclick="backToLobby()">Back</button>
            </div>

            <div class="waiting-screen lobby-screen">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 25px;">Waiting for Player 2...</h2>
                <div style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); padding: 30px; border-radius: 20px; text-align: center; margin: 20px 0; border: 3px solid #667eea; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);">
                    <p style="color: #666; font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">Share this code:</p>
                    <h1 id="codeDisplay" style="color: #667eea; letter-spacing: 8px; font-size: 3em; font-weight: bold; text-shadow: 2px 2px 4px rgba(102, 126, 234, 0.1);">------</h1>
                </div>
                <button class="secondary-btn" onclick="location.reload()">Cancel</button>
            </div>

            <div class="connecting-screen lobby-screen">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 25px;">üéâ Connected!</h2>
                <p style="text-align: center; margin-top: 20px; font-size: 1.2em; color: #2c3e50;">Playing with <strong style="color: #764ba2; font-size: 1.3em;" id="partnerName">...</strong></p>
            </div>
        </div>

        <div class="start-screen">
            <div class="instructions" style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); padding: 35px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);">
                <h3 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 20px;">üß© Today's Crossword</h3>
                <p style="text-align: center; color: #2c3e50; margin: 20px 0; font-size: 1.1em; line-height: 1.6;">
                    Solve the puzzle against the clock!<br>
                    <span style="font-size: 0.95em; color: #666;">Features 2026 pop culture, gaming & entertainment</span>
                </p>
            </div>
            <button onclick="startGame()">üöÄ Start Puzzle</button>
        </div>

        <div class="game-screen">
            <div class="player-indicator" id="gameStatus">Solving...</div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progressDisplay">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value" id="timerDisplay">00:00</div>
                </div>
                <div class="stat-box" id="opponentStatBox" style="display: none; background: #95a5a6;">
                    <div class="stat-label">Opponent</div>
                    <div class="stat-value" id="opponentProgress">0%</div>
                </div>
            </div>

            <div class="crossword-container">
                <div id="gridContainer" class="crossword-grid"></div>

                <div class="clues-container">
                    <div class="clue-section">
                        <h3>‚û°Ô∏è Across</h3>
                        <ul id="acrossClues" class="clue-list"></ul>
                    </div>
                    <div class="clue-section">
                        <h3>‚¨áÔ∏è Down</h3>
                        <ul id="downClues" class="clue-list"></ul>
                    </div>
                </div>
            </div>

            <button class="hint-btn" id="hintBtn" onclick="useHint()">üí° Hint (3 left)</button>
            <button class="secondary-btn" onclick="checkPuzzle()">Check Puzzle</button>
            <button class="leave-game-btn" onclick="leaveGame()">Leave Game</button>
        </div>

        <div class="end-screen">
            <div class="score-display" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); font-size: 2em; font-weight: bold; text-align: center;">
                üéâ Puzzle Complete! üéâ
            </div>
            <h2 id="winnerText" style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 1.8em;"></h2>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Final Time</div>
                    <div class="stat-value" id="finalTime">00:00</div>
                </div>
            </div>
            <button onclick="location.reload()">üéÆ Play Another Puzzle</button>
        </div>
    </div>

    <script src="../js/mode-toggle.js"></script>
    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        // --- GLOBAL STATE ---
        let puzzleData = null; // Filled by fetch
        let selectedMode = 'race';
        let multiplayer = null;
        let isHost = false;
        let playerNames = { p1: 'Player 1', p2: 'Player 2' };
        
        let gridState = {};
        let timer = 0;
        let timerInterval;
        let hintsRemaining = 3;
        
        let selectedCell = null;
        let currentDirection = 'across';
        let currentActiveClueId = null;

        // --- INITIALIZATION ---
        // Fetch the daily puzzle data immediately
        window.onload = async () => {
            try {
                // Fetch from the root directory
                const response = await fetch('../crossword-data.json');
                if (!response.ok) throw new Error("Puzzle file not found");
                puzzleData = await response.json();
                
                // Hide Loading, Show Start
                document.getElementById('loadingScreen').classList.remove('active');
                
                // Check if we came from an online link logic here
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode') || 'local';
                
                if (modeParam === 'online') {
                    document.querySelector('.online-lobby-screen').classList.add('active');
                    document.getElementById('modeDescription').textContent = "Online: Sync up or Race!";
                    multiplayer = new MultiplayerSession('crossword-clash');
                } else {
                    document.querySelector('.start-screen').classList.add('active');
                }
                
                initModeToggle(modeParam);
            } catch (error) {
                console.error(error);
                document.getElementById('loadingScreen').classList.remove('active');
                document.getElementById('errorScreen').classList.add('active');
            }
        };

        // --- UI FUNCTIONS ---
        window.showScreen = (selector) => {
            document.querySelectorAll('.start-screen, .game-screen, .end-screen, .lobby-screen, .loading-screen').forEach(el => el.classList.remove('active'));
            document.querySelector(selector).classList.add('active');
        };

        // --- LOBBY LOGIC ---
        window.showCreateGame = () => window.showScreen('.create-game-screen');
        window.showJoinGame = () => window.showScreen('.join-game-screen');
        window.backToLobby = () => window.showScreen('.online-lobby-screen');

        window.createGameSession = async () => {
            const name = document.getElementById('p1Name').value || 'Host';
            playerNames.p1 = name;
            isHost = true;
            const res = await multiplayerSession.createSession(name);
            if (res.success) {
                document.getElementById('codeDisplay').textContent = res.sessionId;
                window.showScreen('.waiting-screen');
                multiplayerSession.on('onPlayerJoined', (p2) => {
                    playerNames.p2 = p2;
                    document.getElementById('partnerName').textContent = p2;
                    window.showScreen('.connecting-screen');
                    setTimeout(() => window.showScreen('.start-screen'), 1500);
                });
            }
        };

        window.joinGameSession = async () => {
            const name = document.getElementById('p2Name').value || 'Guest';
            const code = document.getElementById('joinCode').value;
            playerNames.p2 = name;
            const res = await multiplayerSession.joinSession(code, name);
            if (res.success) {
                playerNames.p1 = res.opponentName;
                document.getElementById('partnerName').textContent = res.opponentName;
                window.showScreen('.connecting-screen');
                multiplayerSession.on('onGameStateChange', (state) => {
                    if (state.status === 'playing') {
                        selectedMode = state.mode;
                        startGameLogic();
                    }
                });
            }
        };

        // --- GAME START ---
        window.startGame = async () => {
            if (!puzzleData) return; // Guard clause

            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');

            if (modeParam === 'online' && isHost) {
                await multiplayerSession.updateGameState({
                    status: 'playing',
                    mode: selectedMode,
                    startTime: Date.now()
                });
            }
            startGameLogic();
        };

        function startGameLogic() {
            window.showScreen('.game-screen');
            hintsRemaining = 3;
            updateHintButton();
            
            renderGrid();
            renderClues();
            
            // Find first white cell to select
            let found = false;
            for(let r=0; r<puzzleData.height; r++){
                for(let c=0; c<puzzleData.width; c++){
                    if(puzzleData.grid[r][c] !== 0) {
                        selectCell(r, c);
                        found = true;
                        break;
                    }
                }
                if(found) break;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');

            if (modeParam === 'online') {
                if (selectedMode === 'coop') {
                    document.getElementById('gameStatus').textContent = "Co-op Mode: Solving Together";
                    multiplayerSession.on('onGameStateChange', (state) => {
                        if (state.gridUpdates) {
                            Object.keys(state.gridUpdates).forEach(key => {
                                updateCellUI(key, state.gridUpdates[key]);
                                gridState[key] = state.gridUpdates[key];
                                validateAllWords();
                            });
                        }
                    });
                } else {
                    document.getElementById('gameStatus').textContent = "Race Mode: Go!";
                    document.getElementById('opponentStatBox').style.display = 'block';
                    multiplayerSession.on('onGameStateChange', (state) => {
                        const opponentNum = multiplayerSession.playerNumber === 1 ? 2 : 1;
                        const prog = state[`p${opponentNum}Progress`];
                        if (prog) document.getElementById('opponentProgress').textContent = prog + '%';
                        if (state[`p${opponentNum}Finished`]) alert(`${playerNames[`p${opponentNum}`]} finished!`);
                    });
                }
            }

            const startT = Date.now();
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startT) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').textContent = `${m}:${s}`;
            }, 1000);
        }

        // --- RENDERERS ---
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.style.gridTemplateColumns = `repeat(${puzzleData.width}, 1fr)`;
            container.innerHTML = '';

            for(let r=0; r<puzzleData.height; r++) {
                for(let c=0; c<puzzleData.width; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cw-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    if (puzzleData.grid[r][c] === 0) {
                        cell.classList.add('black');
                    } else {
                        const key = `${r},${c}`;
                        if (puzzleData.numbers[key]) {
                            const numSpan = document.createElement('span');
                            numSpan.className = 'cw-number';
                            numSpan.textContent = puzzleData.numbers[key];
                            cell.appendChild(numSpan);
                        }
                        
                        const input = document.createElement('input');
                        input.className = 'cw-input';
                        input.dataset.row = r;
                        input.dataset.col = c;
                        
                        input.setAttribute('autocomplete', 'off');
                        input.setAttribute('autocorrect', 'off');
                        input.setAttribute('autocapitalize', 'characters');
                        input.setAttribute('spellcheck', 'false');

                        input.addEventListener('focus', () => selectCell(r, c));
                        
                        // Smart toggle on click
                        input.addEventListener('click', () => {
                            if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                                const hasAcross = getWordAt(r, c, 'across') !== null;
                                const hasDown = getWordAt(r, c, 'down') !== null;
                                if (hasAcross && hasDown) {
                                    currentDirection = currentDirection === 'across' ? 'down' : 'across';
                                    highlightActiveWord();
                                }
                            } else {
                                selectCell(r, c);
                            }
                        });

                        input.addEventListener('keydown', (e) => handleKey(e, r, c));
                        input.addEventListener('input', (e) => {
                           e.preventDefault(); 
                           const val = e.target.value.slice(-1).toUpperCase();
                           if(val.match(/[A-Z]/)) {
                               updateGridValue(r, c, val);
                               moveFocus(r, c, 1);
                           }
                        });

                        cell.appendChild(input);
                    }
                    container.appendChild(cell);
                }
            }
        }

        function renderClues() {
            const aList = document.getElementById('acrossClues');
            const dList = document.getElementById('downClues');
            aList.innerHTML = '';
            dList.innerHTML = '';

            Object.entries(puzzleData.words.across).forEach(([num, data]) => {
                const li = document.createElement('li');
                li.className = 'clue-item';
                li.id = `clue-across-${num}`;
                li.innerHTML = `<strong>${num}</strong> ${data.clue}`;
                li.onclick = () => jumpToWord('across', data);
                aList.appendChild(li);
            });

            Object.entries(puzzleData.words.down).forEach(([num, data]) => {
                const li = document.createElement('li');
                li.className = 'clue-item';
                li.id = `clue-down-${num}`;
                li.innerHTML = `<strong>${num}</strong> ${data.clue}`;
                li.onclick = () => jumpToWord('down', data);
                dList.appendChild(li);
            });
        }

        // --- CORE INPUT LOGIC ---
        function handleKey(e, r, c) {
            const key = e.key;
            if (key.length === 1 && key.match(/[a-z]/i)) {
                e.preventDefault(); 
                updateGridValue(r, c, key.toUpperCase());
                moveFocus(r, c, 1);
                return;
            }
            if (key === 'Backspace') {
                e.preventDefault();
                if (e.target.value) {
                    updateGridValue(r, c, '');
                } else {
                    moveFocus(r, c, -1);
                    const prev = getNextCell(r, c, -1);
                    if (prev) updateGridValue(prev.r, prev.c, '');
                }
                return;
            }
            if (key === 'ArrowRight') { moveFocusManual(r, c+1); e.preventDefault(); }
            if (key === 'ArrowLeft')  { moveFocusManual(r, c-1); e.preventDefault(); }
            if (key === 'ArrowUp')    { moveFocusManual(r-1, c); e.preventDefault(); }
            if (key === 'ArrowDown')  { moveFocusManual(r+1, c); e.preventDefault(); }
        }
        
        function updateGridValue(r, c, val) {
            const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
            if (input) {
                input.value = val;
                gridState[`${r},${c}`] = val;
                
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');

                if (modeParam === 'online' && selectedMode === 'coop') {
                    multiplayerSession.updateGameState({ gridUpdates: { [`${r},${c}`]: val } });
                }
                validateAllWords();
                checkProgress();
            }
        }
        
        function moveFocusManual(r, c) {
            const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
            if (cell && !cell.classList.contains('black')) {
                cell.querySelector('input').focus();
            }
        }

        function getNextCell(r, c, delta) {
             let nr = r, nc = c;
             for(let i=0; i<puzzleData.height; i++) { // search limit to size
                 if (currentDirection === 'across') nc += delta; else nr += delta;
                 if(nr < 0 || nc < 0 || nr >= puzzleData.height || nc >= puzzleData.width) return null;
                 
                 const cell = document.querySelector(`.cw-cell[data-row="${nr}"][data-col="${nc}"]`);
                 if (cell && !cell.classList.contains('black')) {
                     return {r: nr, c: nc};
                 }
             }
             return null;
        }

        function moveFocus(r, c, delta) {
            const next = getNextCell(r, c, delta);
            if (next) {
                const input = document.querySelector(`.cw-input[data-row="${next.r}"][data-col="${next.c}"]`);
                if(input) input.focus();
            }
        }

        // --- SELECT CELL LOGIC ---
        function selectCell(r, c) {
            const hasAcross = getWordAt(r, c, 'across') !== null;
            const hasDown = getWordAt(r, c, 'down') !== null;

            if (hasAcross && !hasDown) {
                currentDirection = 'across';
            } else if (!hasAcross && hasDown) {
                currentDirection = 'down';
            }

            selectedCell = { r, c };
            document.querySelectorAll('.cw-cell').forEach(el => el.classList.remove('selected'));
            const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
            if (cell) cell.classList.add('selected');
            
            highlightActiveWord();
        }

        function highlightActiveWord() {
            document.querySelectorAll('.cw-cell').forEach(el => el.classList.remove('active-word'));
            document.querySelectorAll('.clue-item').forEach(el => el.classList.remove('active'));

            if (!selectedCell) return;
            const wordObj = getWordAt(selectedCell.r, selectedCell.c, currentDirection);
            
            if (wordObj) {
                const clueKey = Object.keys(puzzleData.words[currentDirection]).find(k => puzzleData.words[currentDirection][k] === wordObj);
                const clueId = `clue-${currentDirection}-${clueKey}`;
                
                if (clueKey) {
                    const el = document.getElementById(clueId);
                    if (el) {
                        el.classList.add('active');
                        if (currentActiveClueId !== clueId) {
                            currentActiveClueId = clueId;
                            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                }

                let r = wordObj.row, c = wordObj.col;
                for(let i=0; i<wordObj.answer.length; i++) {
                    const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
                    if(cell) cell.classList.add('active-word');
                    if(currentDirection === 'across') c++; else r++;
                }
            }
        }

        function getWordAt(r, c, dir) {
            const words = puzzleData.words[dir];
            for (const key in words) {
                const w = words[key];
                if (dir === 'across') {
                    if (r === w.row && c >= w.col && c < w.col + w.answer.length) return w;
                } else {
                    if (c === w.col && r >= w.row && r < w.row + w.answer.length) return w;
                }
            }
            return null;
        }

        function jumpToWord(dir, data) {
            currentDirection = dir;
            const input = document.querySelector(`.cw-input[data-row="${data.row}"][data-col="${data.col}"]`);
            if (input) {
                input.focus();
                selectCell(data.row, data.col);
            }
        }

        function updateCellUI(key, val) {
            const [r, c] = key.split(',');
            const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
            if (input && input.value !== val) input.value = val;
        }

        // --- VALIDATION & HINTS ---
        function validateAllWords() {
            Object.values(puzzleData.words.across).forEach(w => checkWord(w, 'across'));
            Object.values(puzzleData.words.down).forEach(w => checkWord(w, 'down'));
        }

        function checkWord(word, dir) {
            let r = word.row, c = word.col;
            let currentStr = "";
            let cells = [];

            for(let i=0; i<word.answer.length; i++) {
                const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
                if (input) {
                    currentStr += input.value || " ";
                    cells.push(cell);
                }
                if (dir === 'across') c++; else r++;
            }

            if (currentStr === word.answer) {
                cells.forEach(cell => cell.classList.add('correct'));
                const k = Object.keys(puzzleData.words[dir]).find(key => puzzleData.words[dir][key] === word);
                const clueEl = document.getElementById(`clue-${dir}-${k}`);
                if(clueEl) clueEl.classList.add('correct-clue');
            }
        }

        window.useHint = () => {
            if (hintsRemaining <= 0 || !selectedCell) return;
            
            let correctChar = null;
            let w = getWordAt(selectedCell.r, selectedCell.c, 'across');
            if (w) correctChar = w.answer[selectedCell.c - w.col];
            else {
                w = getWordAt(selectedCell.r, selectedCell.c, 'down');
                if (w) correctChar = w.answer[selectedCell.r - w.row];
            }

            if (correctChar) {
                updateGridValue(selectedCell.r, selectedCell.c, correctChar);
                hintsRemaining--;
                updateHintButton();
            }
        };

        function updateHintButton() {
            const btn = document.getElementById('hintBtn');
            btn.textContent = `üí° Hint (${hintsRemaining} left)`;
            if (hintsRemaining <= 0) btn.disabled = true;
        }

        function checkProgress() {
            let total = 0, filled = 0;
            for(let r=0; r<puzzleData.height; r++) {
                for(let c=0; c<puzzleData.width; c++) {
                    if (puzzleData.grid[r][c] !== 0) {
                        total++;
                        const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                        if (input && input.value) filled++;
                    }
                }
            }
            const pct = Math.floor((filled / total) * 100);
            document.getElementById('progressDisplay').textContent = pct + '%';
            
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');

            if (modeParam === 'online' && selectedMode === 'race') {
                multiplayerSession.updateGameState({ [`p${multiplayerSession.playerNumber}Progress`]: pct });
            }
        }

        window.checkPuzzle = async () => {
            let allWordsCorrect = true;
            Object.values(puzzleData.words.across).forEach(w => {
                 if(!isWordCompleteAndCorrect(w, 'across')) allWordsCorrect = false;
            });
            Object.values(puzzleData.words.down).forEach(w => {
                 if(!isWordCompleteAndCorrect(w, 'down')) allWordsCorrect = false;
            });

            if (allWordsCorrect) {
                clearInterval(timerInterval);
                document.getElementById('finalTime').textContent = document.getElementById('timerDisplay').textContent;
                
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');

                if (modeParam === 'online' && selectedMode === 'race') {
                    await multiplayerSession.updateGameState({ [`p${multiplayerSession.playerNumber}Finished`]: true });
                    document.getElementById('winnerText').textContent = "You Finished First!";
                } else {
                    document.getElementById('winnerText').textContent = "Puzzle Solved!";
                }
                window.showScreen('.end-screen');
            } else {
                alert("Not quite done! Look for non-green boxes.");
            }
        };
        
        function isWordCompleteAndCorrect(word, dir) {
            let r = word.row, c = word.col;
            for(let i=0; i<word.answer.length; i++) {
                const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                if(!input || input.value !== word.answer[i]) return false;
                if(dir==='across') c++; else r++;
            }
            return true;
        }

        window.leaveGame = () => location.reload();
    </script>
</body>
</html>
