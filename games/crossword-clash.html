<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crossword Clash - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Shared Game Styles */
        .player-indicator {
            text-align: center; font-size: 1.5em; font-weight: bold; color: #764ba2;
            margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
            max-width: 100%;
        }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; flex: 1; }
        .stat-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 5px; }
        .stat-value { font-size: 1.5em; font-weight: bold; }

        /* Crossword Specific Styles */
        .crossword-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            max-width: 100%;
            flex: 1;
            min-height: 0; 
        }

        .crossword-grid {
            display: grid;
            background: #333;
            gap: 1px;
            border: 3px solid #333;
            user-select: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1 / 1;
        }

        .cw-cell {
            background: white;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cw-cell.black {
            background: #222 !important;
            border-color: #222 !important;
            cursor: default !important;
            pointer-events: none !important;
        }

        /* Selection Colors */
        .cw-cell.selected {
            background: #fff9c4; /* Yellow for focused cell */
        }

        .cw-cell.active-word {
            background: #e3f2fd; /* Light Blue for current word */
        }

        /* Validation Colors */
        .cw-cell.correct {
            background: #c8e6c9 !important;
            color: #2e7d32 !important;
        }

        .cw-cell.correct.selected {
            background: #a5d6a7 !important;
            border: 2px solid #2e7d32;
        }

        .cw-number {
            position: absolute;
            top: 2%;
            left: 2%;
            font-size: 0.35em;
            color: #666;
            line-height: 1;
            pointer-events: none;
        }

        .cw-input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            background: transparent;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            padding: 0;
            outline: none;
            caret-color: transparent; /* Hide default blinking cursor for cleaner look */
            cursor: pointer;
            border-radius: 0;
            /* Disable mobile auto-features that mess up typing */
            -webkit-user-select: text;
        }
        
        /* Highlight cursor position visually since we hid the caret */
        .cw-input:focus {
            box-shadow: inset 0 0 0 2px #667eea;
        }

        .clues-container {
            width: 100%;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e4ff;
            display: flex;
            flex-direction: column;
        }

        .clue-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #e0e4ff;
            padding-bottom: 8px;
            font-weight: bold;
        }

        .clue-list {
            list-style: none;
            margin-bottom: 25px;
        }

        .clue-item {
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 1em;
            line-height: 1.5;
            color: #333;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .clue-item:hover {
            background: #e0e4ff;
            border-color: #667eea;
        }

        .clue-item.active {
            background: #667eea;
            color: white;
            font-weight: bold;
            border-color: #764ba2;
        }

        .clue-item.correct-clue {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .clue-item strong {
            display: inline-block;
            min-width: 30px;
            color: #667eea;
            font-size: 1.1em;
            margin-right: 8px;
        }

        .clue-item.active strong {
            color: white;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Screens */
        .start-screen, .game-screen, .end-screen, .lobby-screen {
            display: none;
            max-width: 100vw;
            overflow-x: hidden;
            height: 100%;
        }
        .active { display: block; }

        body { overflow-x: hidden; }

        .game-screen {
            padding: 0 5px;
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        .game-screen.active { display: flex; }
        
        button {
            width: 100%; padding: 15px; font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; 
            cursor: pointer; margin-top: 10px; font-weight: bold;
        }
        
        .hint-btn { background: #ffb74d; color: white; margin-top: 10px; }
        .hint-btn:disabled { background: #e0e0e0; cursor: not-allowed; }
        .secondary-btn { background: white; color: #667eea; border: 2px solid #667eea; }
        .leave-game-btn { background: transparent; border: 2px solid #e74c3c; color: #e74c3c; }

        @media (min-width: 1200px) {
            .crossword-container {
                flex-direction: row;
                align-items: flex-start;
                justify-content: center;
                gap: 30px;
                max-width: 1400px;
                margin: 0 auto;
            }
            .clues-container {
                width: 450px;
                max-height: 600px;
                overflow-y: auto;
                flex-shrink: 0;
            }
            .crossword-grid {
                flex-shrink: 0;
                width: 600px;
                height: 600px;
            }
            .cw-cell { font-size: 1.1em; }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .crossword-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 0 20px;
            }
            .clues-container {
                width: 100%;
                max-width: 500px;
                max-height: 350px;
                overflow-y: auto;
            }
            .cw-cell { font-size: 1em; }
        }

        @media (max-width: 767px) {
            .game-screen { height: auto; min-height: 100vh; }
            .crossword-container {
                flex-direction: column;
                width: 100%;
                padding: 0;
                align-items: center;
                gap: 10px;
            }
            .crossword-grid {
                width: 100%;
                max-width: 100%;
                aspect-ratio: 1/1;
                overflow: visible;
            }
            .cw-cell { font-size: clamp(10px, 4vw, 18px); }
            .clues-container {
                width: 100%;
                flex: 1;
                max-height: 40vh;
                overflow-y: auto;
                padding: 10px;
                margin-bottom: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <a href="../index.html" class="back-link">‚Üê Back to Games</a>
            <div class="mode-toggle" role="group" aria-label="Play mode">
                <button type="button" class="mode-btn" data-mode="local">üè† Local</button>
                <button type="button" class="mode-btn" data-mode="online">üåê Online</button>
            </div>
        </div>
        <p class="mode-status">Mode: <span id="modeBadge">Local</span></p>
        <h1 class="game-title">üß© Crossword Clash</h1>
        <p class="game-subtitle">Solve together or race to finish!</p>

        <div id="onlineScreens">
            <div class="online-lobby-screen lobby-screen">
                <h2 style="text-align: center; color: #764ba2; margin-bottom: 20px;">Play Online</h2>
                <div style="display: grid; gap: 15px;">
                    <button onclick="showCreateGame()">‚ûï Create Game</button>
                    <button class="secondary-btn" onclick="showJoinGame()">üîó Join Game</button>
                </div>
            </div>

            <div class="create-game-screen lobby-screen">
                <h2>Create Game</h2>
                <input type="text" id="p1Name" placeholder="Your Name" style="width: 100%; padding: 15px; margin: 15px 0; border: 2px solid #ddd; border-radius: 8px;">
                <button onclick="createGameSession()">Get Code</button>
                <button class="secondary-btn" onclick="backToLobby()">Back</button>
            </div>

            <div class="join-game-screen lobby-screen">
                <h2>Join Game</h2>
                <input type="text" id="p2Name" placeholder="Your Name" style="width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px;">
                <input type="text" id="joinCode" placeholder="Game Code" style="width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; text-transform: uppercase;">
                <button onclick="joinGameSession()">Join</button>
                <button class="secondary-btn" onclick="backToLobby()">Back</button>
            </div>

            <div class="waiting-screen lobby-screen">
                <h2 style="text-align: center;">Waiting for Player 2...</h2>
                <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; border: 2px solid #667eea;">
                    <p style="color: #666;">Code:</p>
                    <h1 id="codeDisplay" style="color: #667eea; letter-spacing: 5px; font-size: 2.5em;">------</h1>
                </div>
                <button class="secondary-btn" onclick="location.reload()">Cancel</button>
            </div>

            <div class="connecting-screen lobby-screen">
                <h2 style="text-align: center;">Connected!</h2>
                <p style="text-align: center; margin-top: 20px;">Playing with <strong id="partnerName">...</strong></p>
            </div>
        </div>

        <div class="start-screen active">
            <div class="instructions">
                <h3>üß© Today's Crossword</h3>
                <p style="text-align: center; color: #666; margin: 20px 0;">
                    Solve the puzzle against the clock!<br>
                    <span style="font-size: 0.9em;">Features 2026 pop culture, gaming & entertainment</span>
                </p>
            </div>
            <button onclick="startGame()">Start Puzzle</button>
        </div>

        <div class="game-screen">
            <div class="player-indicator" id="gameStatus">Solving...</div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Progress</div>
                    <div class="stat-value" id="progressDisplay">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Time</div>
                    <div class="stat-value" id="timerDisplay">00:00</div>
                </div>
                <div class="stat-box" id="opponentStatBox" style="display: none; background: #95a5a6;">
                    <div class="stat-label">Opponent</div>
                    <div class="stat-value" id="opponentProgress">0%</div>
                </div>
            </div>

            <div class="crossword-container">
                <div id="gridContainer" class="crossword-grid"></div>

                <div class="clues-container">
                    <div class="clue-section">
                        <h3>‚û°Ô∏è Across</h3>
                        <ul id="acrossClues" class="clue-list"></ul>
                    </div>
                    <div class="clue-section">
                        <h3>‚¨áÔ∏è Down</h3>
                        <ul id="downClues" class="clue-list"></ul>
                    </div>
                </div>
            </div>

            <button class="hint-btn" id="hintBtn" onclick="useHint()">üí° Hint (3 left)</button>
            <button class="secondary-btn" onclick="checkPuzzle()">Check Puzzle</button>
            <button class="leave-game-btn" onclick="leaveGame()">Leave Game</button>
        </div>

        <div class="end-screen">
            <div class="score-display">Puzzle Complete! üéâ</div>
            <h2 id="winnerText" style="text-align: center; color: #667eea; margin-bottom: 20px;"></h2>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Final Time</div>
                    <div class="stat-value" id="finalTime">00:00</div>
                </div>
            </div>
            <button onclick="location.reload()">Play Another</button>
        </div>
    </div>

    <script src="../js/mode-toggle.js"></script>
    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        // --- PUZZLE DATA ---
        const puzzleData = {
            "width": 15, "height": 15,
            "grid": [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,1,0,1,0,0,0,0,0,0,0,0,0,0],
                [0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
                [0,0,1,0,1,0,0,0,0,0,0,0,0,0,0],
                [0,1,0,0,1,0,0,0,0,0,1,0,0,0,0],
                [0,1,0,0,1,0,0,1,0,0,1,0,0,0,0],
                [0,1,0,0,1,0,0,1,0,0,1,0,1,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
                [0,1,0,1,0,0,0,0,1,0,1,0,1,0,0],
                [0,1,0,1,0,0,1,0,1,0,1,0,1,1,1],
                [0,0,0,1,0,0,1,0,1,0,1,0,1,0,0],
                [0,0,0,1,0,1,1,1,1,0,0,0,1,0,0],
                [0,0,0,1,0,0,1,0,0,0,0,1,1,1,0],
                [0,1,1,1,0,0,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0]
            ],
            "numbers": {
                "1,2": 1, "1,4": 2, "2,1": 3, "4,1": 4, "4,10": 5, "5,7": 6, "6,12": 7,
                "7,1": 8, "7,3": 9, "7,8": 10, "9,6": 11, "9,12": 12, "11,5": 13, "12,11": 14, "13,1": 15
            },
            "words": {
                "across": {
                    "8": {"clue": "TikTok term for an 'ugly' lookalike", "answer": "CHOPPLEGANGER", "row": 7, "col": 1},
                    "14": {"clue": "'Survivor' winner ___ Yam Arocho", "answer": "YAM", "row": 12, "col": 11},
                    "13": {"clue": "Singer Langley ('Choosin' Texas')", "answer": "ELLA", "row": 11, "col": 5},
                    "15": {"clue": "Actress Brooke of 'Dune 3'", "answer": "IDA", "row": 13, "col": 1},
                    "3": {"clue": "Singer Alex of 'Ordinary'", "answer": "WARREN", "row": 2, "col": 1},
                    "12": {"clue": "Agency sparking Jan '26 protests", "answer": "ICE", "row": 9, "col": 12}
                },
                "down": {
                    "4": {"clue": "Fortnite currency", "answer": "VBUCKS", "row": 4, "col": 1},
                    "6": {"clue": "Significant other", "answer": "BAE", "row": 5, "col": 7},
                    "7": {"clue": "Spa manager in 'White Lotus' S3", "answer": "BELINDA", "row": 6, "col": 12},
                    "10": {"clue": "Resurrected Duncan Idaho", "answer": "GHOLA", "row": 7, "col": 8},
                    "5": {"clue": "Daughter of Paul Atreides", "answer": "GHANIMA", "row": 4, "col": 10},
                    "9": {"clue": "Swift's 13-week #1 hit", "answer": "OPHELIA", "row": 7, "col": 3},
                    "2": {"clue": "Robbie Williams' 2026 album", "answer": "BRITPOP", "row": 1, "col": 4},
                    "11": {"clue": "Country star Morgan", "answer": "WALLEN", "row": 9, "col": 6},
                    "1": {"clue": "Handshake gesture (slang)", "answer": "DAP", "row": 1, "col": 2}
                }
            }
        };

        // --- STATE ---
        let selectedMode = 'race';
        let multiplayer = null;
        let isHost = false;
        let playerNames = { p1: 'Player 1', p2: 'Player 2' };
        
        let gridState = {};
        let timer = 0;
        let timerInterval;
        let hintsRemaining = 3;
        
        let selectedCell = null;
        let currentDirection = 'across';

        // --- SETUP ---
        const urlParams = new URLSearchParams(window.location.search);
        const modeParam = urlParams.get('mode') || 'local';
        initModeToggle(modeParam);

        if (modeParam === 'online') {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            document.getElementById('modeDescription').textContent = "Online: Sync up or Race!";
            multiplayer = new MultiplayerSession('crossword-clash');
        }

        // --- UI FUNCTIONS ---
        window.showScreen = (selector) => {
            document.querySelectorAll('.start-screen, .game-screen, .end-screen, .lobby-screen').forEach(el => el.classList.remove('active'));
            document.querySelector(selector).classList.add('active');
        };

        // --- LOBBY LOGIC ---
        window.showCreateGame = () => window.showScreen('.create-game-screen');
        window.showJoinGame = () => window.showScreen('.join-game-screen');
        window.backToLobby = () => window.showScreen('.online-lobby-screen');

        window.createGameSession = async () => {
            const name = document.getElementById('p1Name').value || 'Host';
            playerNames.p1 = name;
            isHost = true;
            const res = await multiplayerSession.createSession(name);
            if (res.success) {
                document.getElementById('codeDisplay').textContent = res.sessionId;
                window.showScreen('.waiting-screen');
                multiplayerSession.on('onPlayerJoined', (p2) => {
                    playerNames.p2 = p2;
                    document.getElementById('partnerName').textContent = p2;
                    window.showScreen('.connecting-screen');
                    setTimeout(() => window.showScreen('.start-screen'), 1500);
                });
            }
        };

        window.joinGameSession = async () => {
            const name = document.getElementById('p2Name').value || 'Guest';
            const code = document.getElementById('joinCode').value;
            playerNames.p2 = name;
            const res = await multiplayerSession.joinSession(code, name);
            if (res.success) {
                playerNames.p1 = res.opponentName;
                document.getElementById('partnerName').textContent = res.opponentName;
                window.showScreen('.connecting-screen');
                multiplayerSession.on('onGameStateChange', (state) => {
                    if (state.status === 'playing') {
                        selectedMode = state.mode;
                        startGameLogic();
                    }
                });
            }
        };

        // --- GAME START ---
        window.startGame = async () => {
            if (modeParam === 'online' && isHost) {
                await multiplayerSession.updateGameState({
                    status: 'playing',
                    mode: selectedMode,
                    startTime: Date.now()
                });
            }
            startGameLogic();
        };

        function startGameLogic() {
            window.showScreen('.game-screen');
            hintsRemaining = 3;
            updateHintButton();
            
            renderGrid();
            renderClues();
            selectCell(0, 0);

            if (modeParam === 'online') {
                if (selectedMode === 'coop') {
                    document.getElementById('gameStatus').textContent = "Co-op Mode: Solving Together";
                    multiplayerSession.on('onGameStateChange', (state) => {
                        if (state.gridUpdates) {
                            Object.keys(state.gridUpdates).forEach(key => {
                                updateCellUI(key, state.gridUpdates[key]);
                                gridState[key] = state.gridUpdates[key];
                                validateAllWords();
                            });
                        }
                    });
                } else {
                    document.getElementById('gameStatus').textContent = "Race Mode: Go!";
                    document.getElementById('opponentStatBox').style.display = 'block';
                    multiplayerSession.on('onGameStateChange', (state) => {
                        const opponentNum = multiplayerSession.playerNumber === 1 ? 2 : 1;
                        const prog = state[`p${opponentNum}Progress`];
                        if (prog) document.getElementById('opponentProgress').textContent = prog + '%';
                        if (state[`p${opponentNum}Finished`]) alert(`${playerNames[`p${opponentNum}`]} finished!`);
                    });
                }
            }

            const startT = Date.now();
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startT) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').textContent = `${m}:${s}`;
            }, 1000);
        }

        // --- RENDERERS ---
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.style.gridTemplateColumns = `repeat(${puzzleData.width}, 1fr)`;
            container.innerHTML = '';

            for(let r=0; r<puzzleData.height; r++) {
                for(let c=0; c<puzzleData.width; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cw-cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    if (puzzleData.grid[r][c] === 0) {
                        cell.classList.add('black');
                    } else {
                        // Number
                        const key = `${r},${c}`;
                        if (puzzleData.numbers[key]) {
                            const numSpan = document.createElement('span');
                            numSpan.className = 'cw-number';
                            numSpan.textContent = puzzleData.numbers[key];
                            cell.appendChild(numSpan);
                        }
                        
                        // Input
                        const input = document.createElement('input');
                        input.className = 'cw-input';
                        // IMPORTANT: No maxlength, we handle this manually for control
                        input.dataset.row = r;
                        input.dataset.col = c;
                        
                        // Disable auto-correction/capitalization for mobile
                        input.setAttribute('autocomplete', 'off');
                        input.setAttribute('autocorrect', 'off');
                        input.setAttribute('autocapitalize', 'characters');
                        input.setAttribute('spellcheck', 'false');

                        // Event Listeners
                        input.addEventListener('focus', () => selectCell(r, c));
                        // We use click to toggle direction logic
                        input.addEventListener('click', (e) => {
                            // If clicking already selected cell, toggle direction
                            if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
                                currentDirection = currentDirection === 'across' ? 'down' : 'across';
                                highlightActiveWord();
                            } else {
                                selectCell(r, c);
                            }
                        });

                        // Main Typing Logic
                        input.addEventListener('keydown', (e) => handleKey(e, r, c));
                        
                        // Prevent default input events to stop "double typing" since we handle keydown
                        input.addEventListener('input', (e) => {
                           e.preventDefault(); 
                           // If something slips through (like mobile paste), just validate
                           const val = e.target.value.slice(-1).toUpperCase();
                           if(val.match(/[A-Z]/)) {
                               updateGridValue(r, c, val);
                               moveFocus(r, c, 1);
                           }
                        });

                        cell.appendChild(input);
                    }
                    container.appendChild(cell);
                }
            }
        }

        function renderClues() {
            const aList = document.getElementById('acrossClues');
            const dList = document.getElementById('downClues');
            aList.innerHTML = '';
            dList.innerHTML = '';

            Object.entries(puzzleData.words.across).forEach(([num, data]) => {
                const li = document.createElement('li');
                li.className = 'clue-item';
                li.id = `clue-across-${num}`;
                li.innerHTML = `<strong>${num}</strong> ${data.clue}`;
                li.onclick = () => jumpToWord('across', data);
                aList.appendChild(li);
            });

            Object.entries(puzzleData.words.down).forEach(([num, data]) => {
                const li = document.createElement('li');
                li.className = 'clue-item';
                li.id = `clue-down-${num}`;
                li.innerHTML = `<strong>${num}</strong> ${data.clue}`;
                li.onclick = () => jumpToWord('down', data);
                dList.appendChild(li);
            });
        }

        // --- CORE INPUT LOGIC ---
        function handleKey(e, r, c) {
            const key = e.key;

            // 1. Letters A-Z
            if (key.length === 1 && key.match(/[a-z]/i)) {
                e.preventDefault(); // Stop default "append" behavior
                const letter = key.toUpperCase();
                
                // Force update value
                updateGridValue(r, c, letter);
                
                // Move focus forward
                moveFocus(r, c, 1);
                return;
            }

            // 2. Backspace
            if (key === 'Backspace') {
                e.preventDefault();
                const currentVal = e.target.value;
                
                if (currentVal) {
                    // If box has letter, delete it
                    updateGridValue(r, c, '');
                } else {
                    // If box empty, move back, THEN delete
                    moveFocus(r, c, -1);
                    // We need to calculate where we moved to to delete it
                    // Simple hack: let the focus event trigger, then delete in a timeout or 
                    // just find the cell manually here:
                    const prev = getNextCell(r, c, -1);
                    if (prev) updateGridValue(prev.r, prev.c, '');
                }
                return;
            }

            // 3. Arrow Navigation
            if (key === 'ArrowRight') { moveFocusManual(r, c+1); e.preventDefault(); }
            if (key === 'ArrowLeft')  { moveFocusManual(r, c-1); e.preventDefault(); }
            if (key === 'ArrowUp')    { moveFocusManual(r-1, c); e.preventDefault(); }
            if (key === 'ArrowDown')  { moveFocusManual(r+1, c); e.preventDefault(); }
        }
        
        function updateGridValue(r, c, val) {
            const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
            if (input) {
                input.value = val;
                gridState[`${r},${c}`] = val;
                
                // Sync Online
                if (modeParam === 'online' && selectedMode === 'coop') {
                    multiplayerSession.updateGameState({ gridUpdates: { [`${r},${c}`]: val } });
                }
                
                validateAllWords();
                checkProgress();
            }
        }
        
        function moveFocusManual(r, c) {
            const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
            if (cell && !cell.classList.contains('black')) {
                cell.querySelector('input').focus();
            }
        }

        function getNextCell(r, c, delta) {
             let nr = r, nc = c;
             for(let i=0; i<15; i++) {
                 if (currentDirection === 'across') nc += delta; else nr += delta;
                 // Boundary checks
                 if(nr < 0 || nc < 0 || nr >= puzzleData.height || nc >= puzzleData.width) return null;
                 
                 // If not black, return coords
                 const cell = document.querySelector(`.cw-cell[data-row="${nr}"][data-col="${nc}"]`);
                 if (cell && !cell.classList.contains('black')) return {r: nr, c: nc};
             }
             return null;
        }

        function moveFocus(r, c, delta) {
            const next = getNextCell(r, c, delta);
            if (next) {
                const input = document.querySelector(`.cw-input[data-row="${next.r}"][data-col="${next.c}"]`);
                if(input) input.focus();
            }
        }

        // --- NAVIGATION UI ---
        function selectCell(r, c) {
            selectedCell = { r, c };
            document.querySelectorAll('.cw-cell').forEach(el => el.classList.remove('selected'));
            const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
            if (cell) cell.classList.add('selected');
            highlightActiveWord();
        }

        function highlightActiveWord() {
            document.querySelectorAll('.cw-cell').forEach(el => el.classList.remove('active-word'));
            document.querySelectorAll('.clue-item').forEach(el => el.classList.remove('active'));

            if (!selectedCell) return;
            const wordObj = getWordAt(selectedCell.r, selectedCell.c, currentDirection);
            
            if (wordObj) {
                // Highlight clue
                const clueKey = Object.keys(puzzleData.words[currentDirection]).find(k => puzzleData.words[currentDirection][k] === wordObj);
                if (clueKey) {
                    const el = document.getElementById(`clue-${currentDirection}-${clueKey}`);
                    if (el) {
                        el.classList.add('active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }

                // Highlight grid
                let r = wordObj.row, c = wordObj.col;
                for(let i=0; i<wordObj.answer.length; i++) {
                    const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
                    if(cell) cell.classList.add('active-word');
                    if(currentDirection === 'across') c++; else r++;
                }
            }
        }

        function getWordAt(r, c, dir) {
            const words = puzzleData.words[dir];
            for (const key in words) {
                const w = words[key];
                if (dir === 'across') {
                    if (r === w.row && c >= w.col && c < w.col + w.answer.length) return w;
                } else {
                    if (c === w.col && r >= w.row && r < w.row + w.answer.length) return w;
                }
            }
            return null;
        }

        function jumpToWord(dir, data) {
            currentDirection = dir;
            const input = document.querySelector(`.cw-input[data-row="${data.row}"][data-col="${data.col}"]`);
            if (input) {
                input.focus();
                selectCell(data.row, data.col);
            }
        }

        function updateCellUI(key, val) {
            const [r, c] = key.split(',');
            const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
            if (input && input.value !== val) input.value = val;
        }

        // --- VALIDATION & HINTS ---
        function validateAllWords() {
            Object.values(puzzleData.words.across).forEach(w => checkWord(w, 'across'));
            Object.values(puzzleData.words.down).forEach(w => checkWord(w, 'down'));
        }

        function checkWord(word, dir) {
            let r = word.row, c = word.col;
            let currentStr = "";
            let cells = [];

            for(let i=0; i<word.answer.length; i++) {
                const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                const cell = document.querySelector(`.cw-cell[data-row="${r}"][data-col="${c}"]`);
                if (input) {
                    currentStr += input.value || " ";
                    cells.push(cell);
                }
                if (dir === 'across') c++; else r++;
            }

            if (currentStr === word.answer) {
                cells.forEach(cell => cell.classList.add('correct'));
                const k = Object.keys(puzzleData.words[dir]).find(key => puzzleData.words[dir][key] === word);
                const clueEl = document.getElementById(`clue-${dir}-${k}`);
                if(clueEl) clueEl.classList.add('correct-clue');
            }
        }

        window.useHint = () => {
            if (hintsRemaining <= 0 || !selectedCell) return;
            
            let correctChar = null;
            let w = getWordAt(selectedCell.r, selectedCell.c, 'across');
            if (w) correctChar = w.answer[selectedCell.c - w.col];
            else {
                w = getWordAt(selectedCell.r, selectedCell.c, 'down');
                if (w) correctChar = w.answer[selectedCell.r - w.row];
            }

            if (correctChar) {
                updateGridValue(selectedCell.r, selectedCell.c, correctChar);
                hintsRemaining--;
                updateHintButton();
            }
        };

        function updateHintButton() {
            const btn = document.getElementById('hintBtn');
            btn.textContent = `üí° Hint (${hintsRemaining} left)`;
            if (hintsRemaining <= 0) btn.disabled = true;
        }

        function checkProgress() {
            let total = 0, filled = 0;
            for(let r=0; r<puzzleData.height; r++) {
                for(let c=0; c<puzzleData.width; c++) {
                    if (puzzleData.grid[r][c] === 1) {
                        total++;
                        const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                        if (input && input.value) filled++;
                    }
                }
            }
            const pct = Math.floor((filled / total) * 100);
            document.getElementById('progressDisplay').textContent = pct + '%';
            
            if (modeParam === 'online' && selectedMode === 'race') {
                multiplayerSession.updateGameState({ [`p${multiplayerSession.playerNumber}Progress`]: pct });
            }
        }

        window.checkPuzzle = async () => {
            let allWordsCorrect = true;
            Object.values(puzzleData.words.across).forEach(w => {
                 if(!isWordCompleteAndCorrect(w, 'across')) allWordsCorrect = false;
            });
            Object.values(puzzleData.words.down).forEach(w => {
                 if(!isWordCompleteAndCorrect(w, 'down')) allWordsCorrect = false;
            });

            if (allWordsCorrect) {
                clearInterval(timerInterval);
                document.getElementById('finalTime').textContent = document.getElementById('timerDisplay').textContent;
                
                if (modeParam === 'online' && selectedMode === 'race') {
                    await multiplayerSession.updateGameState({ [`p${multiplayerSession.playerNumber}Finished`]: true });
                    document.getElementById('winnerText').textContent = "You Finished First!";
                } else {
                    document.getElementById('winnerText').textContent = "Puzzle Solved!";
                }
                window.showScreen('.end-screen');
            } else {
                alert("Not quite done! Look for non-green boxes.");
            }
        };
        
        function isWordCompleteAndCorrect(word, dir) {
            let r = word.row, c = word.col;
            for(let i=0; i<word.answer.length; i++) {
                const input = document.querySelector(`.cw-input[data-row="${r}"][data-col="${c}"]`);
                if(!input || input.value !== word.answer[i]) return false;
                if(dir==='across') c++; else r++;
            }
            return true;
        }

        window.leaveGame = () => location.reload();
    </script>
</body>
</html>
