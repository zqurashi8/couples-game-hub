<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossword Clash - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Shared Styles */
        .player-indicator {
            text-align: center; font-size: 1.2em; font-weight: bold; color: #764ba2;
            padding: 10px; background: #f8f9ff; border-radius: 25px; margin-bottom: 15px;
        }
        .cw-container {
            display: flex; flex-direction: column; align-items: center; width: 100%;
        }
        .grid-wrapper {
            background: #333; padding: 5px; border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .cw-grid {
            display: grid; gap: 1px; background: #333; border: 2px solid #333;
        }
        .cell {
            background: white; position: relative; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2em; text-transform: uppercase;
            cursor: pointer;
        }
        .cell.black { background: #333; cursor: default; }
        .cell.selected { background: #fff9c4; }
        .cell.correct {
            background: #c8e6c9;
            color: #2e7d32;
            animation: correctPulse 0.6s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); background: white; }
            50% { transform: scale(1.2); background: #81c784; }
            100% { transform: scale(1); background: #c8e6c9; }
        }

        .cell.hint {
            background: #fff9c4;
            animation: hintGlow 0.8s ease;
        }

        @keyframes hintGlow {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 235, 59, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 235, 59, 0.8); }
        }
        .cell-num {
            position: absolute; top: 1px; left: 2px; font-size: 0.5em; color: #666; font-weight: normal;
        }
        .clues-container {
            width: 100%; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        .clue-box h3 { color: #667eea; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .clue-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .clue-item { padding: 5px 0; font-size: 0.9em; cursor: pointer; }
        .clue-item:hover { color: #764ba2; font-weight: bold; }
        .clue-item.active { color: #764ba2; font-weight: bold; background: #f0f4ff; }

        /* Mobile */
        @media(max-width: 600px) {
            .cell { width: 30px; height: 30px; font-size: 1em; }
            .clues-container { grid-template-columns: 1fr; }
        }

        /* Screens */
        .start-screen, .game-screen, .end-screen, .online-lobby-screen, .create-game-screen, .join-game-screen, .waiting-room-screen, .connecting-screen { display: none; }
        .active { display: block; }

        button {
            width: 100%; padding: 12px; font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 25px; margin-top: 10px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="game-container" style="max-width: 800px; margin: 0 auto; padding: 15px;">
        <div class="game-header">
            <a href="../index.html" class="back-link">‚Üê Back to Games</a>
            <div class="mode-toggle" role="group" aria-label="Play mode">
                <button type="button" class="mode-btn" data-mode="local">üè† Local</button>
                <button type="button" class="mode-btn" data-mode="online">üåê Online</button>
            </div>
        </div>
        <p class="mode-status">Mode: <span id="modeBadge">Local</span></p>
        <h1 class="game-title">üß© Crossword Clash</h1>
        <p class="game-subtitle">Race to complete the puzzle!</p>

        <div class="start-screen active">
            <div style="background: #f8f9ff; padding: 20px; border-radius: 25px; margin-bottom: 20px;">
                <h3>How to Play:</h3>
                <p>Race to finish the puzzle! First to complete all words correctly wins.</p>
            </div>
            <h3>Select Puzzle:</h3>
            <div style="display: grid; gap: 10px;">
                <button onclick="selectPuzzle('mini')">‚ö° Mini (5x5)</button>
                <button onclick="selectPuzzle('midi')">üß† Midi (7x7)</button>
                <button onclick="selectPuzzle('daily')">üìÖ Daily (10x10)</button>
            </div>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button onclick="showOnlineLobby()" style="background: white; color: #667eea; border: 2px solid #667eea;">üåê Play Online</button>
            </div>
        </div>

        <div class="online-lobby-screen">
            <h2>Online Lobby</h2>
            <button onclick="createGame()">Create Game</button>
            <button onclick="joinGameUI()">Join Game</button>
            <button onclick="location.reload()" style="background: #eee; color: #333;">Back</button>
        </div>
        <div class="create-game-screen">
            <input id="p1Name" placeholder="Your Name" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <button onclick="doCreate()">Get Code</button>
        </div>
        <div class="join-game-screen">
            <input id="p2Name" placeholder="Your Name" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <input id="code" placeholder="Game Code" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #ddd; border-radius: 25px;">
            <button onclick="doJoin()">Join</button>
        </div>
        <div class="waiting-room-screen">
            <h2>Game Code: <span id="sessCode">---</span></h2>
            <p>Waiting for opponent...</p>
        </div>

        <div class="game-screen">
            <div class="player-indicator" id="timer">Time: 00:00</div>

            <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f8f9ff; border-radius: 25px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="progress">0%</div>
                <div style="font-size: 0.9em; color: #666;">Completed</div>
            </div>

            <div class="cw-container">
                <div class="grid-wrapper">
                    <div id="grid" class="cw-grid"></div>
                </div>
            </div>

            <div class="clues-container">
                <div class="clue-box">
                    <h3>Across</h3>
                    <ul id="accClues" class="clue-list"></ul>
                </div>
                <div class="clue-box">
                    <h3>Down</h3>
                    <ul id="downClues" class="clue-list"></ul>
                </div>
            </div>

            <button onclick="getHint()" style="background: #ff9800;">üí° Get Hint (<span id="hintsLeft">3</span> left)</button>
            <button onclick="location.reload()" style="background: transparent; color: #e74c3c; border: 2px solid #e74c3c;">Quit</button>
        </div>

        <div class="end-screen">
            <h1 style="text-align: center;">üéâ Puzzle Solved!</h1>
            <h2 id="winnerText" style="text-align: center; color: #667eea;"></h2>
            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script src="../js/mode-toggle.js"></script>
    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        const urlParams = new URLSearchParams(window.location.search);
        const playMode = urlParams.get('mode') || 'local';
        initModeToggle(playMode);

        // --- Puzzles Data ---
        const puzzles = {
            mini: {
                rows: 5, cols: 5,
                grid: [
                    ['H','E','A','R','T'],
                    ['A','R','E','A','S'],
                    ['P','R','O','N','E'],
                    ['P','O','N','D','S'],
                    ['Y','E','A','R','S']
                ],
                clues: {
                    across: { 1: "Symbol of love", 6: "Regions", 7: "Lying face down", 8: "Small lakes", 9: "Periods of time" },
                    down: { 1: "Cheerful", 2: "Wrong judgement", 3: "Very long time", 4: "Standard", 5: "These (spanish)" }
                },
                nums: { '0-0':1, '0-1':2, '0-2':3, '0-3':4, '0-4':5, '1-0':6, '2-0':7, '3-0':8, '4-0':9 }
            },
            midi: {
                rows: 5, cols: 5,
                grid: [
                    ['S','P','A','C','E'],
                    ['T','O','A','S','T'],
                    ['A','P','P','L','E'],
                    ['R','E','L','A','X'],
                    ['T','R','E','N','D']
                ],
                clues: {
                    across: { 1: "The final frontier", 4: "Breakfast bread", 5: "Keeps doctor away", 6: "Chill out", 7: "Viral fashion" },
                    down: { 1: "Begin", 2: "Pop", 3: "Apply", 4: "Clean", 5: "End" }
                },
                 nums: { '0-0':1, '1-0':4, '2-0':5, '3-0':6, '4-0':7 }
            },
            daily: {
                rows: 5, cols: 5,
                grid: [
                    ['L','O','V','E','S'],
                    ['I','D','E','A','L'],
                    ['G','A','M','E','S'],
                    ['H','O','P','E','S'],
                    ['T','R','U','S','T']
                ],
                clues: {
                    across: { 1: "Romantic feelings", 6: "Perfect", 7: "Fun activities", 8: "Wishes", 9: "Faith in partner" },
                    down: { 1: "Bright", 2: "Ode", 3: "Vamp", 4: "Ales", 5: "Last" }
                },
                nums: { '0-0':1, '1-0':6, '2-0':7, '3-0':8, '4-0':9 }
            }
        };

        // --- State ---
        let currentPuzzle = null;
        let selectedCell = null;
        let direction = 'across';
        let timerInt;
        let seconds = 0;
        let multiplayer = null;
        let isOnline = false;
        let hintsRemaining = 3;

        // --- UI Logic ---
        window.selectPuzzle = (type) => {
            currentPuzzle = puzzles[type] || puzzles.mini;
            hintsRemaining = 3;
            seconds = 0;
            if (isOnline) {
                multiplayer.updateGameState({ puzzleType: type, status: 'playing' });
            } else {
                startGame();
            }
        };

        function startGame() {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.game-screen').classList.add('active');
            renderGrid();
            renderClues();
            startTimer();
        }

        function renderGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.style.gridTemplateColumns = `repeat(${currentPuzzle.cols}, 1fr)`;
            gridEl.innerHTML = '';

            for(let r=0; r<currentPuzzle.rows; r++) {
                for(let c=0; c<currentPuzzle.cols; c++) {
                    const letter = currentPuzzle.grid[r][c];
                    const div = document.createElement('div');
                    div.className = 'cell';
                    if (letter === '#') div.classList.add('black');
                    else {
                        div.dataset.r = r;
                        div.dataset.c = c;
                        div.dataset.letter = letter;
                        div.contentEditable = true;
                        div.onclick = () => focusCell(div);
                        div.onkeydown = (e) => handleInput(e, div);
                        div.oninput = (e) => handleMobileInput(e, div);
                        div.setAttribute('autocomplete', 'off');
                        div.setAttribute('autocorrect', 'off');
                        div.setAttribute('autocapitalize', 'off');
                        div.setAttribute('spellcheck', 'false');

                        // Number
                        const key = `${r}-${c}`;
                        if (currentPuzzle.nums && currentPuzzle.nums[key]) {
                            div.innerHTML = `<span class="cell-num">${currentPuzzle.nums[key]}</span>`;
                        }
                    }
                    gridEl.appendChild(div);
                }
            }
        }

        function renderClues() {
            const aList = document.getElementById('accClues');
            const dList = document.getElementById('downClues');
            aList.innerHTML = ''; dList.innerHTML = '';

            Object.keys(currentPuzzle.clues.across).forEach(k => {
                aList.innerHTML += `<li class="clue-item"><strong>${k}:</strong> ${currentPuzzle.clues.across[k]}</li>`;
            });
            Object.keys(currentPuzzle.clues.down).forEach(k => {
                dList.innerHTML += `<li class="clue-item"><strong>${k}:</strong> ${currentPuzzle.clues.down[k]}</li>`;
            });
        }

        function focusCell(div) {
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
            div.classList.add('selected');
            div.focus();
        }

        function handleInput(e, div) {
            e.preventDefault();
            if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
                // Remove existing num span if overwriting
                const num = div.querySelector('.cell-num');
                div.innerText = e.key.toUpperCase();
                if(num) div.appendChild(num); // Keep num

                // Check if correct immediately
                checkCell(div);

                // Move focus
                moveFocus(div, 1);

                // Check progress
                updateProgress();
            } else if (e.key === 'Backspace') {
                const num = div.querySelector('.cell-num');
                div.innerText = '';
                if(num) div.appendChild(num);
                div.classList.remove('correct');
                moveFocus(div, -1);
                updateProgress();
            }
        }

        function handleMobileInput(e, div) {
            // Handle mobile keyboard input
            const num = div.querySelector('.cell-num');
            let text = div.innerText.replace(/[^a-zA-Z]/g, '').toUpperCase();

            if (text.length > 1) {
                // Multiple characters typed - take only the last one and move forward
                const lastChar = text.charAt(text.length - 1);
                div.innerText = lastChar;
                if(num) div.appendChild(num);
                checkCell(div);
                moveFocus(div, 1);
                updateProgress();
            } else if (text.length === 1) {
                // Single character - format and move forward
                div.innerText = text;
                if(num) div.appendChild(num);
                checkCell(div);
                setTimeout(() => {
                    moveFocus(div, 1);
                    updateProgress();
                }, 10);
            } else if (text.length === 0) {
                // Deleted - keep num if exists
                div.innerText = '';
                if(num) div.appendChild(num);
                div.classList.remove('correct');
                updateProgress();
            }
        }

        function checkCell(div) {
            const val = div.innerText.replace(/[0-9]/g, '').trim();
            if (val && val === div.dataset.letter) {
                div.classList.add('correct');
                div.contentEditable = false; // Lock correct cells
            } else {
                div.classList.remove('correct');
            }
        }

        function updateProgress() {
            const total = document.querySelectorAll('.cell:not(.black)').length;
            const correct = document.querySelectorAll('.cell.correct').length;
            const percentage = Math.round((correct / total) * 100);

            const progressEl = document.getElementById('progress');
            if (progressEl) {
                progressEl.textContent = percentage + '%';
            }

            // Check if puzzle is complete
            if (correct === total) {
                setTimeout(() => {
                    completePuzzle();
                }, 500);
            }
        }

        function completePuzzle() {
            clearInterval(timerInt);
            document.querySelector('.game-screen').classList.remove('active');
            document.querySelector('.end-screen').classList.add('active');

            const mins = Math.floor(seconds/60).toString().padStart(2,'0');
            const secs = (seconds%60).toString().padStart(2,'0');
            document.getElementById('winnerText').textContent = `Completed in ${mins}:${secs}!`;
        }

        function moveFocus(div, step) {
            const r = parseInt(div.dataset.r);
            const c = parseInt(div.dataset.c);
            const cols = currentPuzzle.cols;

            // Try to move across (right/left) first
            let nextR = r;
            let nextC = c + step;

            // If out of bounds or hit black cell, try moving down/up instead
            if (nextC < 0 || nextC >= cols) {
                nextC = c;
                nextR = r + step;
            }

            // Find the next cell
            const cells = Array.from(document.querySelectorAll('.cell:not(.black)'));
            const next = cells.find(cell =>
                parseInt(cell.dataset.r) === nextR &&
                parseInt(cell.dataset.c) === nextC
            );

            if (next) {
                focusCell(next);
            }
        }

        function startTimer() {
            timerInt = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `Time: ${m}:${s}`;
            }, 1000);
        }

        function getHint() {
            if (hintsRemaining <= 0) {
                alert('No hints remaining!');
                return;
            }

            // Find all incorrect or empty cells
            const incorrectCells = Array.from(document.querySelectorAll('.cell:not(.black):not(.correct)'));

            if (incorrectCells.length === 0) {
                alert('Puzzle already complete!');
                return;
            }

            // Pick a random empty/incorrect cell and reveal it
            const randomCell = incorrectCells[Math.floor(Math.random() * incorrectCells.length)];
            const num = randomCell.querySelector('.cell-num');

            randomCell.innerText = randomCell.dataset.letter;
            if (num) randomCell.appendChild(num);

            randomCell.classList.add('hint');
            randomCell.classList.add('correct');
            randomCell.contentEditable = false;

            hintsRemaining--;
            document.getElementById('hintsLeft').textContent = hintsRemaining;

            updateProgress();

            // Remove hint glow after animation
            setTimeout(() => {
                randomCell.classList.remove('hint');
            }, 800);
        }

        window.checkPuzzle = async () => {
            let correct = true;
            document.querySelectorAll('.cell:not(.black)').forEach(c => {
                const val = c.innerText.replace(/[0-9]/g, '').trim();
                if (val !== c.dataset.letter) {
                    c.style.color = 'red';
                    correct = false;
                } else {
                    c.style.color = 'green';
                    c.classList.add('correct');
                }
            });

            if (correct) {
                clearInterval(timerInt);
                if (isOnline) {
                    await multiplayer.updateGameState({ status: 'finished', winner: multiplayer.playerName });
                } else {
                    showEnd("You Solved it!");
                }
            }
        };

        function showEnd(msg) {
            document.querySelector('.game-screen').classList.remove('active');
            document.querySelector('.end-screen').classList.add('active');
            document.getElementById('winnerText').innerText = msg;
        }

        // --- Online Logic ---
        window.showOnlineLobby = () => {
            isOnline = true;
            multiplayer = new MultiplayerSession('crossword');
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
        };

        window.createGame = () => {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.create-game-screen').classList.add('active');
        }

        window.doCreate = async () => {
            const name = document.getElementById('p1Name').value;
            if (!name) {
                alert('Please enter your name');
                return;
            }
            const res = await multiplayer.createSession(name);
            document.getElementById('sessCode').innerText = res.sessionId;
            document.querySelector('.create-game-screen').classList.remove('active');
            document.querySelector('.waiting-room-screen').classList.add('active');

            multiplayer.on('onPlayerJoined', () => {
                // P1 selects puzzle now
                document.querySelector('.waiting-room-screen').classList.remove('active');
                document.querySelector('.start-screen').classList.add('active');
                // Hide online button in start screen
                document.querySelector('.start-screen button:last-child').style.display='none';
            });

            multiplayer.on('onGameStateChange', (s) => {
                if(s.status === 'finished') showEnd(`${s.winner} Won!`);
            });
        }

        window.joinGameUI = () => {
             document.querySelector('.online-lobby-screen').classList.remove('active');
             document.querySelector('.join-game-screen').classList.add('active');
        }

        window.doJoin = async () => {
            const name = document.getElementById('p2Name').value;
            const code = document.getElementById('code').value;
            if (!name || !code) {
                alert('Please enter both name and game code');
                return;
            }
            await multiplayer.joinSession(code, name);
            document.querySelector('.join-game-screen').classList.remove('active');
            document.querySelector('.connecting-screen').classList.add('active');

            multiplayer.on('onGameStateChange', (s) => {
                if(s.status === 'playing') {
                    currentPuzzle = puzzles[s.puzzleType];
                    document.querySelector('.connecting-screen').classList.remove('active');
                    startGame();
                }
                if(s.status === 'finished') showEnd(`${s.winner} Won!`);
            });
        }
    </script>
</body>
</html>
