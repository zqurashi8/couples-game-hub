<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Lane Adventure - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .player-indicator {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .mode-card {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
        }

        .mode-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .mode-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .mode-card.selected h3 {
            color: white;
        }

        .mode-card p {
            color: #666;
            line-height: 1.5;
        }

        .mode-card.selected p {
            color: rgba(255,255,255,0.95);
        }

        .upload-section {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8eaff;
            border-color: #764ba2;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid #667eea;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }

        .memory-setup {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .memory-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .memory-photo {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }

        .question-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .answer-input, .clue-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .answer-input:focus, .clue-input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.answer-input, textarea.clue-input {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .instructions {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .start-screen, .upload-screen, .setup-screen, .game-screen, .end-screen,
        .online-lobby-screen, .create-game-screen, .join-game-screen,
        .waiting-room-screen, .waiting-for-opponent-screen {
            display: none;
        }

        .start-screen.active, .upload-screen.active, .setup-screen.active, .game-screen.active, .end-screen.active,
        .online-lobby-screen.active, .create-game-screen.active, .join-game-screen.active,
        .waiting-room-screen.active, .waiting-for-opponent-screen.active {
            display: block;
        }

        .progress-indicator {
            text-align: center;
            color: #764ba2;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .score-display {
            text-align: center;
            font-size: 3em;
            color: #667eea;
            margin: 30px 0;
            font-weight: bold;
        }

        .results-summary {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .result-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .result-item.correct {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .result-item.incorrect {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .guess-options {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .guess-btn {
            padding: 15px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 1.1em;
            width: 100%;
            margin: 0;
            color: #333;
            font-weight: 500;
        }

        .guess-btn:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .guess-btn.correct {
            background: #c8e6c9;
            border-color: #4caf50;
            color: #1b5e20;
        }

        .guess-btn.incorrect {
            background: #ffcdd2;
            border-color: #f44336;
            color: #b71c1c;
        }

        .guess-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Lobby & Waiting Styles */
        .online-lobby-screen, .create-game-screen, .join-game-screen, .waiting-room-screen, .waiting-for-opponent-screen {
            display: none;
        }
        
        .lobby-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .lobby-card {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .lobby-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .lobby-icon { font-size: 3em; margin-bottom: 15px; }
        .lobby-card h3 { color: #667eea; margin-bottom: 10px; }
        .lobby-card p { color: #666; font-size: 0.9em; }

        .name-input-container { margin-bottom: 25px; }
        .name-input-container label { display: block; color: #667eea; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .name-input-container input { width: 100%; padding: 15px; font-size: 1.1em; border: 3px solid #ddd; border-radius: 10px; }

        .session-code-display { background: #f8f9ff; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; border: 3px solid #667eea; }
        .session-code { font-size: 3em; font-weight: bold; color: #667eea; letter-spacing: 8px; margin: 20px 0; font-family: 'Courier New', monospace; }

        .waiting-animation { text-align: center; padding: 40px 20px; }
        .dot-pulse { width: 60px; height: 60px; border: 4px solid #667eea; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .back-btn, .cancel-btn { background: white; color: #667eea; border: 3px solid #667eea; }
        .cancel-btn { background: #f44336; color: white; border: none; }
        
        @media (max-width: 768px) {
            .mode-selection, .lobby-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="../index.html" class="back-link">‚Üê Back to Games</a>
        <h1 class="game-title">üíï Memory Lane Adventure</h1>
        <p class="game-subtitle">Relive your favorite moments together</p>

        <div class="start-screen active">
            <div class="instructions">
                <h3>Welcome to Memory Lane!</h3>
                <p>A special game to celebrate your relationship through photos and memories.</p>
            </div>

            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('story')">
                    <h3>üìñ Story Mode</h3>
                    <p>Walk through memories together and answer sweet questions about each moment. Collaborative and heartwarming!</p>
                </div>
                <div class="mode-card" onclick="selectMode('quiz')">
                    <h3>üéØ Quiz Mode</h3>
                    <p>One person creates memory clues, the other guesses! Test how well you remember your special moments.</p>
                </div>
            </div>

            <button id="startBtn" disabled onclick="handleStart()">Select a Mode to Continue</button>
        </div>

        <div class="online-lobby-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">üåê Play Online</h2>
            <div class="lobby-options">
                <div class="lobby-card" onclick="showCreateGame()">
                    <div class="lobby-icon">‚ûï</div>
                    <h3>Create Game</h3>
                    <p>Start a new game and get a code</p>
                </div>
                <div class="lobby-card" onclick="showJoinGame()">
                    <div class="lobby-icon">üîó</div>
                    <h3>Join Game</h3>
                    <p>Enter a code to join</p>
                </div>
            </div>
        </div>

        <div class="create-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Create New Game</h2>
            <div class="name-input-container">
                <label for="player1Name">Your Name:</label>
                <input type="text" id="player1Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <button onclick="createGameSession()">Create Game & Get Code</button>
        </div>

        <div class="waiting-room-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">Waiting for Player 2...</h2>
            <div class="session-code-display">
                <div class="code-label">Share this code:</div>
                <div class="session-code" id="sessionCodeDisplay">------</div>
                <button class="copy-code-btn" onclick="copySessionCode()">üìã Copy Code</button>
            </div>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <p>Waiting for your partner to join...</p>
            </div>
            <button class="cancel-btn" onclick="cancelSession()">Cancel</button>
        </div>

        <div class="join-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Join Game</h2>
            <div class="name-input-container">
                <label for="player2Name">Your Name:</label>
                <input type="text" id="player2Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <div class="name-input-container">
                <label for="sessionCodeInput">Game Code:</label>
                <input type="text" id="sessionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="text-transform: uppercase;" />
            </div>
            <div id="joinErrorMessage" class="error-message" style="display: none;"></div>
            <button onclick="joinGameSession()">Join Game</button>
        </div>

        <div class="waiting-for-opponent-screen">
            <div class="player-indicator" id="waitingIndicator">Waiting...</div>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <h3 id="waitingText">Player 1 is preparing the memories...</h3>
                <p>Sit tight! This will only take a moment.</p>
            </div>
        </div>

        <div class="upload-screen">
            <div class="player-indicator" id="uploadIndicator">Upload Your Memories</div>

            <div class="upload-section">
                <h3 style="color: #667eea; margin-bottom: 15px;">Add 3-5 Photos</h3>
                <div class="upload-area" id="uploadArea">
                    <p style="font-size: 3em; margin-bottom: 10px;">üì∏</p>
                    <p style="font-size: 1.2em; color: #667eea; font-weight: bold;">Click to upload photos</p>
                    <p style="color: #666; margin-top: 10px;">or drag and drop here</p>
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                </div>
                <div class="photo-preview-grid" id="photoPreviewGrid"></div>
            </div>

            <button id="continueSetupBtn" disabled onclick="goToSetup()">Continue to Setup</button>
        </div>

        <div class="setup-screen">
            <div class="player-indicator" id="setupIndicator">Add Details to Your Memories</div>
            <div id="memorySetupContainer"></div>
            <button onclick="startGame()">Start the Adventure!</button>
        </div>

        <div class="game-screen">
            <div class="player-indicator" id="gameIndicator">Memory 1 of 3</div>

            <div class="stats" id="statsDisplay" style="display: none;">
                <div class="stat-box">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Memory</div>
                    <div class="stat-value" id="memoryNum">1</div>
                </div>
            </div>

            <div id="gameContent"></div>

            <button id="nextMemoryBtn" onclick="nextMemory()" style="display: none;">Next Memory</button>
            <button id="finishBtn" onclick="showResults()" style="display: none;">See Results</button>
        </div>

        <div class="end-screen">
            <div class="score-display" id="finalScore">Beautiful Memories! üíï</div>
            <div class="results-summary" id="resultsContainer"></div>
            <button onclick="location.reload()">Create New Memories</button>
        </div>
    </div>

    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        // Detect game mode
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode') || 'local';
        
        let multiplayerSession = null;
        let playerNames = { player1: 'Player 1', player2: 'Player 2' };
        
        let gameMode = null; // 'story' or 'quiz'
        let uploadedPhotos = [];
        let memories = [];
        let currentMemoryIndex = 0;
        let score = 0;

        const storyQuestions = [
            "What was the funniest moment from this memory?",
            "What did you love most about this moment?",
            "If you could relive this moment, what would you do differently?",
            "What song reminds you of this memory?",
            "What was the best part of this day?",
            "What made this moment special?",
            "What did we eat or drink here?",
            "What was the weather like?",
            "Who else was there with you?",
            "What were you celebrating?"
        ];

        // --- GLOBAL FUNCTIONS EXPORT FOR HTML ONCLICK ---
        window.selectMode = function(mode) {
            gameMode = mode;
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.mode-card').classList.add('selected');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = `Start ${mode === 'story' ? 'Story' : 'Quiz'} Mode`;
        };

        window.handleStart = function() {
            if (urlMode === 'online') {
                showLobby();
            } else {
                goToUpload();
            }
        };

        // --- LOBBY LOGIC ---
        window.showLobby = function() {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            multiplayerSession = new MultiplayerSession('memory-lane');
        };

        window.showCreateGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.create-game-screen').classList.add('active');
        };

        window.showJoinGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.add('active');
        };

        window.backToLobby = function() {
            document.querySelector('.create-game-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            document.getElementById('joinErrorMessage').style.display = 'none';
        };

        window.copySessionCode = function() {
            const code = document.getElementById('sessionCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => alert('Code copied!'));
        };

        window.cancelSession = async function() {
            if (multiplayerSession) await multiplayerSession.disconnect();
            location.reload();
        };

        window.createGameSession = async function() {
            const name = document.getElementById('player1Name').value.trim();
            if (!name) return alert('Enter name');
            
            playerNames.player1 = name;
            const result = await multiplayerSession.createSession(name);
            
            if (result.success) {
                document.querySelector('.create-game-screen').classList.remove('active');
                document.querySelector('.waiting-room-screen').classList.add('active');
                document.getElementById('sessionCodeDisplay').textContent = result.sessionId;

                multiplayerSession.on('onPlayerJoined', async (p2Name) => {
                    playerNames.player2 = p2Name;
                    
                    // P1 is host, so P1 needs to setup
                    // Tell P2 to wait
                    await multiplayerSession.updateGameState({
                        status: 'setup_phase',
                        gameTypeMode: gameMode, // story or quiz
                        playerNames: playerNames
                    });
                    
                    // Move P1 to Upload
                    document.querySelector('.waiting-room-screen').classList.remove('active');
                    goToUpload();
                });
                
                multiplayerSession.on('onGameStateChange', handleGameStateChange);
            }
        };

        window.joinGameSession = async function() {
            const name = document.getElementById('player2Name').value.trim();
            const code = document.getElementById('sessionCodeInput').value.trim();
            if (!name || !code) return alert('Enter name and code');

            playerNames.player2 = name;
            const result = await multiplayerSession.joinSession(code, name);

            if (result.success) {
                playerNames.player1 = result.opponentName;
                document.querySelector('.join-game-screen').classList.remove('active');
                
                // P2 immediately waits for P1 to upload
                showWaitingScreen(`${playerNames.player1} is preparing the memories...`);

                multiplayerSession.on('onGameStateChange', handleGameStateChange);
            } else {
                document.getElementById('joinErrorMessage').textContent = result.error;
                document.getElementById('joinErrorMessage').style.display = 'block';
            }
        };

        // --- ONLINE STATE HANDLER ---
        function handleGameStateChange(state) {
            console.log("State Update:", state);
            const myPlayerNum = multiplayerSession ? multiplayerSession.playerNumber : 1;

            if (state.gameTypeMode) gameMode = state.gameTypeMode;
            if (state.playerNames) playerNames = state.playerNames;

            // 1. Setup Phase
            if (state.status === 'setup_phase') {
                if (myPlayerNum === 2) {
                    showWaitingScreen(`${playerNames.player1} is preparing the memories...`);
                }
            }
            
            // 2. Game Ready (Data uploaded)
            else if (state.status === 'game_ready') {
                if (myPlayerNum === 2) {
                    // Load data from state
                    memories = state.memories || [];
                    currentMemoryIndex = 0;
                    startActualGame();
                }
            }

            // 3. In Progress (Syncing current memory index or score)
            else if (state.status === 'in_progress') {
                // If P1 changed the memory index
                if (state.currentIndex !== undefined && state.currentIndex !== currentMemoryIndex) {
                    currentMemoryIndex = state.currentIndex;
                    loadMemory(); // Refresh view
                }
                
                // If scores updated
                if (state.score !== undefined) {
                    score = state.score;
                    if(document.getElementById('score')) document.getElementById('score').textContent = score;
                }
            }

            // 4. Finished
            else if (state.status === 'finished') {
                // Sync answers for final display if Story mode
                if (state.finalMemories) memories = state.finalMemories;
                displayFinalResults();
            }
        }

        // --- CORE GAME LOGIC (Modified for Online) ---

        window.goToUpload = function() {
            hideAllScreens();
            document.querySelector('.upload-screen').classList.add('active');

            if (gameMode === 'story') {
                document.getElementById('uploadIndicator').textContent = 'Upload Your Shared Memories';
            } else {
                document.getElementById('uploadIndicator').textContent = 'Player 1: Upload Memory Photos';
            }
            setupUploadHandlers();
        };

        window.goToSetup = function() {
            document.querySelector('.upload-screen').classList.remove('active');
            document.querySelector('.setup-screen').classList.add('active');

            if (gameMode === 'story') {
                document.getElementById('setupIndicator').textContent = 'Add context to your memories';
                renderStorySetup();
            } else {
                document.getElementById('setupIndicator').textContent = 'Player 1: Create Memory Clues';
                renderQuizSetup();
            }
        };

        window.startGame = async function() {
            // Collect data (P1 only does this)
            memories = []; // Reset locally
            
            uploadedPhotos.forEach((photo, index) => {
                if (gameMode === 'story') {
                    const title = document.getElementById(`title${index}`).value || `Memory ${index + 1}`;
                    const question = storyQuestions[Math.floor(Math.random() * storyQuestions.length)];
                    memories.push({ photo, title, question, answer: '' });
                } else {
                    const clue = document.getElementById(`clue${index}`).value || 'Guess this memory!';
                    const correctAnswer = document.getElementById(`answer${index}`).value || 'Mystery Memory';
                    const wrong1 = document.getElementById(`wrong1_${index}`).value || 'Option A';
                    const wrong2 = document.getElementById(`wrong2_${index}`).value || 'Option B';
                    const options = [correctAnswer, wrong1, wrong2].sort(() => Math.random() - 0.5);

                    memories.push({ photo, clue, correctAnswer, options, userAnswer: null });
                }
            });

            if (urlMode === 'online') {
                // Send data to P2 via Firebase
                await multiplayerSession.updateGameState({
                    status: 'game_ready',
                    memories: memories,
                    currentIndex: 0
                });
                startActualGame();
            } else {
                startActualGame();
            }
        };

        function startActualGame() {
            hideAllScreens();
            document.querySelector('.game-screen').classList.add('active');

            if (gameMode === 'quiz') {
                document.getElementById('statsDisplay').style.display = 'flex';
                document.getElementById('gameIndicator').textContent = 'Player 2: Guess the Memories!';
            } else {
                document.getElementById('gameIndicator').textContent = 'Share Your Stories!';
            }

            // Sync visual state based on player role
            if (urlMode === 'online' && multiplayerSession && multiplayerSession.playerNumber === 1 && gameMode === 'quiz') {
                document.getElementById('gameIndicator').textContent = `Watching ${playerNames.player2} guess...`;
            }

            currentMemoryIndex = 0;
            loadMemory();
        }

        function loadMemory() {
            const memory = memories[currentMemoryIndex];
            const content = document.getElementById('gameContent');
            const myPlayerNum = multiplayerSession ? multiplayerSession.playerNumber : 1;

            document.getElementById('memoryNum').textContent = currentMemoryIndex + 1;

            // STORY MODE
            if (gameMode === 'story') {
                // If online, P1 is typist, P2 is viewer (or both view)
                // We'll let P1 control inputs
                const isHost = (urlMode === 'local' || myPlayerNum === 1);
                
                content.innerHTML = `
                    <div class="memory-card">
                        <img src="${memory.photo}" class="memory-photo">
                        <h2 style="color: #667eea; margin-bottom: 20px;">${memory.title}</h2>
                        <div class="question-label">${memory.question}</div>
                        ${isHost ? 
                            `<textarea class="answer-input" id="storyAnswer" placeholder="Share your thoughts...">${memory.answer || ''}</textarea>` : 
                            `<div style="padding:15px; background:#f0f0f0; border-radius:8px; font-style:italic;">${playerNames.player1} is typing the story...</div>`
                        }
                    </div>
                `;
            } 
            // QUIZ MODE
            else {
                // If online P1 (creator), show read-only view
                // If online P2 (guesser), show buttons
                const isGuesser = (urlMode === 'local' || myPlayerNum === 2);

                content.innerHTML = `
                    <div class="memory-card">
                        <img src="${memory.photo}" class="memory-photo">
                        <div class="question-label">Memory Clue:</div>
                        <p style="font-size: 1.2em; color: #333; margin-bottom: 20px; font-style: italic;">"${memory.clue}"</p>
                        <div class="question-label">${isGuesser ? 'Where is this memory from?' : `Correct Answer: ${memory.correctAnswer}`}</div>
                        ${isGuesser ? `<div class="guess-options" id="guessOptions"></div>` : ''}
                    </div>
                `;

                if (isGuesser) {
                    const optionsContainer = document.getElementById('guessOptions');
                    memory.options.forEach(option => {
                        const btn = document.createElement('button');
                        btn.className = 'guess-btn';
                        btn.textContent = option;
                        btn.onclick = () => selectAnswer(option);
                        optionsContainer.appendChild(btn);
                    });
                }
            }

            // Button visibility
            const isController = (urlMode === 'local' || (gameMode === 'story' && myPlayerNum === 1) || (gameMode === 'quiz' && myPlayerNum === 2));
            
            document.getElementById('nextMemoryBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
            
            if (isController && gameMode === 'story') {
                 if (currentMemoryIndex < memories.length - 1) document.getElementById('nextMemoryBtn').style.display = 'block';
                 else document.getElementById('finishBtn').style.display = 'block';
            }
        }

        window.selectAnswer = async function(answer) {
            const memory = memories[currentMemoryIndex];
            memory.userAnswer = answer;

            const buttons = document.querySelectorAll('.guess-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === memory.correctAnswer) btn.classList.add('correct');
                else if (btn.textContent === answer && answer !== memory.correctAnswer) btn.classList.add('incorrect');
            });

            if (answer === memory.correctAnswer) {
                score += 10;
                document.getElementById('score').textContent = score;
            }

            // Sync score online
            if (urlMode === 'online') {
                await multiplayerSession.updateGameState({ score: score });
            }

            // Show next/finish buttons
            if (currentMemoryIndex < memories.length - 1) {
                document.getElementById('nextMemoryBtn').style.display = 'block';
            } else {
                document.getElementById('finishBtn').style.display = 'block';
            }
        };

        window.nextMemory = async function() {
            if (gameMode === 'story') {
                // Save text
                const el = document.getElementById('storyAnswer');
                if (el) memories[currentMemoryIndex].answer = el.value;
            }

            currentMemoryIndex++;

            if (urlMode === 'online') {
                await multiplayerSession.updateGameState({
                    currentIndex: currentMemoryIndex,
                    memories: memories // Sync updated stories
                });
            }

            if (currentMemoryIndex < memories.length) {
                loadMemory();
            }
        };

        window.showResults = async function() {
            if (gameMode === 'story') {
                const el = document.getElementById('storyAnswer');
                if (el) memories[currentMemoryIndex].answer = el.value;
            }

            if (urlMode === 'online') {
                await multiplayerSession.updateGameState({
                    status: 'finished',
                    finalMemories: memories // Final sync
                });
            }

            displayFinalResults();
        };

        function displayFinalResults() {
            hideAllScreens();
            document.querySelector('.end-screen').classList.add('active');

            const resultsContainer = document.getElementById('resultsContainer');

            if (gameMode === 'story') {
                document.getElementById('finalScore').textContent = 'Your Beautiful Story üíï';
                let html = '<h3 style="color: #667eea; margin-bottom: 20px;">Your Memory Lane Journey:</h3>';
                memories.forEach(memory => {
                    html += `
                        <div class="result-item">
                            <h4 style="color: #667eea; margin-bottom: 10px;">${memory.title}</h4>
                            <p style="margin-bottom: 8px;"><strong>Q:</strong> ${memory.question}</p>
                            <p><strong>A:</strong> ${memory.answer || '(No answer provided)'}</p>
                        </div>`;
                });
                resultsContainer.innerHTML = html;
            } else {
                const correctCount = memories.filter(m => m.userAnswer === m.correctAnswer).length;
                let resultText = '‚ù§Ô∏è Keep Making Memories!';
                if (correctCount === memories.length) resultText = 'üèÜ Perfect Memory! üíØ';
                
                document.getElementById('finalScore').textContent = resultText;
                
                let html = `<h3 style="color: #667eea;">Quiz Results</h3><p style="text-align:center; font-weight:bold; color:#764ba2; margin-bottom:20px;">Score: ${score}</p>`;
                memories.forEach(memory => {
                    const isCorrect = memory.userAnswer === memory.correctAnswer;
                    html += `
                        <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                            <p><strong>Clue:</strong> "${memory.clue}"</p>
                            <p><strong>Your answer:</strong> ${memory.userAnswer}</p>
                            ${!isCorrect ? `<p><strong>Correct:</strong> ${memory.correctAnswer}</p>` : ''}
                        </div>`;
                });
                resultsContainer.innerHTML = html;
            }
            
            if(multiplayerSession) multiplayerSession.endSession();
        }

        // --- UTILS ---
        function hideAllScreens() {
            document.querySelectorAll('.game-container > div').forEach(div => {
                if (!div.classList.contains('game-title') && !div.classList.contains('back-link')) {
                    div.classList.remove('active');
                }
            });
        }

        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFiles);
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles({ target: { files: e.dataTransfer.files } }); });
        }

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (uploadedPhotos.length >= 5) return alert('Maximum 5 photos allowed!');
                if (!file.type.startsWith('image/')) return alert('Please upload images only!');

                const reader = new FileReader();
                reader.onload = (event) => {
                    // Resize image before storing
                    resizeImage(event.target.result, 800, 800, (resizedDataUrl) => {
                        uploadedPhotos.push(resizedDataUrl);
                        renderPhotoPreview();
                        updateContinueButton();
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        // Helper to compress images for Firebase
        function resizeImage(base64Str, maxWidth, maxHeight, callback) {
            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); // Compress to 70% quality JPEG
            };
        }

        function renderPhotoPreview() {
            const grid = document.getElementById('photoPreviewGrid');
            grid.innerHTML = '';
            uploadedPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview';
                div.innerHTML = `<img src="${photo}"><button class="remove-btn" onclick="removePhoto(${index})">√ó</button>`;
                grid.appendChild(div);
            });
        }

        window.removePhoto = function(index) {
            uploadedPhotos.splice(index, 1);
            renderPhotoPreview();
            updateContinueButton();
        }

        function updateContinueButton() {
            const btn = document.getElementById('continueSetupBtn');
            btn.disabled = uploadedPhotos.length < 3;
            btn.textContent = uploadedPhotos.length < 3 ? `Add ${3 - uploadedPhotos.length} more` : 'Continue to Setup';
        }

        function renderStorySetup() {
            const container = document.getElementById('memorySetupContainer');
            container.innerHTML = '<div class="instructions"><p>Give each photo a title. You\'ll answer questions about them later!</p></div>';
            uploadedPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'memory-card';
                div.innerHTML = `<img src="${photo}" class="memory-photo"><div class="question-label">Title:</div><input type="text" class="answer-input" id="title${index}" placeholder="e.g., First Date...">`;
                container.appendChild(div);
            });
        }

        function renderQuizSetup() {
            const container = document.getElementById('memorySetupContainer');
            container.innerHTML = '<div class="instructions"><p>Write a clue and the correct answer for each photo.</p></div>';
            uploadedPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'memory-card';
                div.innerHTML = `
                    <img src="${photo}" class="memory-photo">
                    <div class="question-label">Clue:</div><textarea class="clue-input" id="clue${index}" placeholder="Hint for partner..."></textarea>
                    <div class="question-label">Correct Answer:</div><input type="text" class="answer-input" id="answer${index}" placeholder="Correct Answer">
                    <div class="question-label">Wrong Options:</div>
                    <input type="text" class="answer-input" id="wrong1_${index}" placeholder="Wrong 1">
                    <input type="text" class="answer-input" id="wrong2_${index}" placeholder="Wrong 2">
                `;
                container.appendChild(div);
            });
        }

        function showWaitingScreen(text) {
            hideAllScreens();
            document.querySelector('.waiting-for-opponent-screen').classList.add('active');
            document.getElementById('waitingText').textContent = text;
        }
    </script>
</body>
</html>
