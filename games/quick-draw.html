<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Draw - Couples Game Hub</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* --- GAME STYLES --- */
        .player-indicator {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .prompt-box {
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 3px solid #ff9800;
        }

        .prompt-text {
            font-size: 1.8em;
            font-weight: bold;
            color: #ff6f00;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
        }

        .drawing-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: white;
            touch-action: none;
            max-width: 100%;
        }

        .tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .tool-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background: #667eea;
            color: white;
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
        }

        .color-picker {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.15);
        }

        .instructions {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .guess-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 3px solid #667eea;
            border-radius: 10px;
            margin: 15px 0;
        }

        .score-display {
            text-align: center;
            font-size: 3em;
            color: #667eea;
            margin: 30px 0;
            font-weight: bold;
        }

        .results-list {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .result-item {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .drawing-display {
            max-width: 100%;
            border: 3px solid #667eea;
            border-radius: 10px;
            margin: 20px 0;
        }

        /* --- LOBBY & SHARED STYLES --- */
        .start-screen, .draw-screen, .guess-screen, .end-screen, 
        .online-lobby-screen, .create-game-screen, .join-game-screen,
        .waiting-room-screen, .waiting-for-opponent-screen {
            display: none;
        }

        .start-screen.active, .draw-screen.active, .guess-screen.active, .end-screen.active,
        .online-lobby-screen.active, .create-game-screen.active, .join-game-screen.active,
        .waiting-room-screen.active, .waiting-for-opponent-screen.active {
            display: block;
        }

        /* Online Lobby Styles */
        .lobby-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .lobby-card {
            background: #f8f9ff;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            text-align: center;
        }

        .lobby-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .lobby-icon { font-size: 3em; margin-bottom: 15px; }
        .lobby-card h3 { color: #667eea; margin-bottom: 10px; }
        .lobby-card p { color: #666; font-size: 0.9em; }

        .name-input-container { margin-bottom: 25px; }
        .name-input-container label {
            display: block; color: #667eea; font-weight: bold; margin-bottom: 10px; font-size: 1.1em;
        }
        .name-input-container input {
            width: 100%; padding: 15px; font-size: 1.1em; border: 3px solid #ddd;
            border-radius: 10px; transition: border-color 0.3s;
        }
        .name-input-container input:focus { outline: none; border-color: #667eea; }

        .session-code-display {
            background: #f8f9ff; padding: 30px; border-radius: 15px;
            text-align: center; margin-bottom: 30px; border: 3px solid #667eea;
        }
        .session-code {
            font-size: 3em; font-weight: bold; color: #667eea;
            letter-spacing: 8px; margin: 20px 0; font-family: 'Courier New', monospace;
        }

        .waiting-animation { text-align: center; padding: 40px 20px; }
        .dot-pulse {
            width: 60px; height: 60px; border: 4px solid #667eea;
            border-radius: 50%; border-top-color: transparent;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .back-btn, .cancel-btn {
            background: white; color: #667eea; border: 3px solid #667eea;
        }
        .cancel-btn { background: #f44336; color: white; border: none; }
        .error-message {
            background: #ffebee; color: #c62828; padding: 15px;
            border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .lobby-options { grid-template-columns: 1fr; }
            .session-code { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="../index.html" class="back-link">‚Üê Back to Games</a>
        <h1 class="game-title">üé® Quick Draw</h1>
        <p class="game-subtitle">Draw and guess!</p>

        <div class="start-screen active">
            <div class="instructions">
                <h3>How to Play:</h3>
                <ul>
                    <li><strong>Player 1</strong> draws 3 prompts in 30 seconds each</li>
                    <li><strong>Player 2</strong> then guesses what each drawing is</li>
                    <li>Then switch! Player 2 draws, Player 1 guesses</li>
                    <li>Most points wins! üèÜ</li>
                </ul>
            </div>
            <button onclick="showLobby()">Play Online</button>
        </div>

        <div class="online-lobby-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">üåê Play Online</h2>
            <div class="lobby-options">
                <div class="lobby-card" onclick="showCreateGame()">
                    <div class="lobby-icon">‚ûï</div>
                    <h3>Create Game</h3>
                    <p>Start a new game and get a code</p>
                </div>
                <div class="lobby-card" onclick="showJoinGame()">
                    <div class="lobby-icon">üîó</div>
                    <h3>Join Game</h3>
                    <p>Enter a code to join a game</p>
                </div>
            </div>
        </div>

        <div class="create-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Create New Game</h2>
            <div class="name-input-container">
                <label for="player1Name">Your Name:</label>
                <input type="text" id="player1Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <button onclick="createGameSession()">Create Game & Get Code</button>
        </div>

        <div class="waiting-room-screen">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">Waiting for Player 2...</h2>
            <div class="session-code-display">
                <div class="code-label">Share this code:</div>
                <div class="session-code" id="sessionCodeDisplay">------</div>
                <button class="copy-code-btn" onclick="copySessionCode()">üìã Copy Code</button>
            </div>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <p>Waiting for your partner to join...</p>
            </div>
            <button class="cancel-btn" onclick="cancelSession()">Cancel</button>
        </div>

        <div class="join-game-screen">
            <button class="back-btn" onclick="backToLobby()">‚Üê Back</button>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px;">Join Game</h2>
            <div class="name-input-container">
                <label for="player2Name">Your Name:</label>
                <input type="text" id="player2Name" placeholder="Enter your name" maxlength="20" />
            </div>
            <div class="name-input-container">
                <label for="sessionCodeInput">Game Code:</label>
                <input type="text" id="sessionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="text-transform: uppercase;" />
            </div>
            <div id="joinErrorMessage" class="error-message" style="display: none;"></div>
            <button onclick="joinGameSession()">Join Game</button>
        </div>

        <div class="waiting-for-opponent-screen">
            <div class="player-indicator" id="waitingIndicator">Waiting...</div>
            <div class="waiting-animation">
                <div class="dot-pulse"></div>
                <h3 id="waitingText">Opponent is drawing...</h3>
                <p>Get ready!</p>
            </div>
        </div>

        <div class="draw-screen">
            <div class="player-indicator" id="drawIndicator">Your Turn to Draw!</div>
            <div class="timer" id="timer">30</div>
            
            <div class="prompt-box">
                <div>Draw this:</div>
                <div class="prompt-text" id="prompt"></div>
            </div>

            <div class="drawing-container">
                <canvas id="canvas" width="500" height="400"></canvas>
            </div>

            <div class="color-picker">
                <div class="color-btn active" style="background: black;" onclick="setColor('black')"></div>
                <div class="color-btn" style="background: red;" onclick="setColor('red')"></div>
                <div class="color-btn" style="background: blue;" onclick="setColor('blue')"></div>
                <div class="color-btn" style="background: green;" onclick="setColor('green')"></div>
                <div class="color-btn" style="background: orange;" onclick="setColor('orange')"></div>
                <div class="color-btn" style="background: purple;" onclick="setColor('purple')"></div>
            </div>

            <div class="tools">
                <button class="tool-btn" onclick="clearCanvas()">Clear Canvas</button>
            </div>
        </div>

        <div class="guess-screen">
            <div class="player-indicator" id="guessIndicator">Guess the drawings!</div>
            
            <div id="guessContainer"></div>

            <button onclick="submitGuesses()">Submit Guesses</button>
        </div>

        <div class="end-screen">
            <div class="score-display" id="finalScore">Results</div>
            <div class="results-list" id="finalResults"></div>
            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script type="module">
        import MultiplayerSession from '../js/multiplayer.js';

        const prompts = [
            "Cat", "Dog", "House", "Tree", "Car", "Sun", "Moon", "Star",
            "Flower", "Fish", "Bird", "Pizza", "Ice Cream", "Bicycle",
            "Guitar", "Book", "Heart", "Rainbow", "Butterfly", "Apple"
        ];

        // Multiplayer vars
        let multiplayerSession = null;
        let playerNames = { player1: 'Player 1', player2: 'Player 2' };
        
        // Game vars
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = 'black';
        let currentPrompt = '';
        let timeLeft = 30;
        let timer;
        let currentRound = 0; // 0, 1, 2
        
        // Game State Data
        let myDrawings = []; // Images I drew
        let opponentDrawings = []; // Images opponent drew to display
        let player1Score = 0;
        let player2Score = 0;

        // --- LOBBY FUNCTIONS ---

        window.showLobby = function() {
            document.querySelector('.start-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            multiplayerSession = new MultiplayerSession('quick-draw');
        };

        window.showCreateGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.create-game-screen').classList.add('active');
        };

        window.showJoinGame = function() {
            document.querySelector('.online-lobby-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.add('active');
        };

        window.backToLobby = function() {
            document.querySelector('.create-game-screen').classList.remove('active');
            document.querySelector('.join-game-screen').classList.remove('active');
            document.querySelector('.online-lobby-screen').classList.add('active');
            document.getElementById('joinErrorMessage').style.display = 'none';
        };

        window.copySessionCode = function() {
            const code = document.getElementById('sessionCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => alert('Code copied!'));
        };

        window.cancelSession = async function() {
            if (multiplayerSession) await multiplayerSession.disconnect();
            location.reload();
        };

        window.createGameSession = async function() {
            const name = document.getElementById('player1Name').value.trim();
            if (!name) return alert('Enter name');
            
            playerNames.player1 = name;
            const result = await multiplayerSession.createSession(name);
            
            if (result.success) {
                document.querySelector('.create-game-screen').classList.remove('active');
                document.querySelector('.waiting-room-screen').classList.add('active');
                document.getElementById('sessionCodeDisplay').textContent = result.sessionId;

                multiplayerSession.on('onPlayerJoined', async (p2Name) => {
                    playerNames.player2 = p2Name;
                    // Start Game: P1 draws first
                    await multiplayerSession.updateGameState({
                        status: 'p1_drawing',
                        drawingsBatch: [], // Clear any old data
                        p1Score: 0,
                        p2Score: 0
                    });
                });
                
                multiplayerSession.on('onGameStateChange', handleGameStateChange);
            }
        };

        window.joinGameSession = async function() {
            const name = document.getElementById('player2Name').value.trim();
            const code = document.getElementById('sessionCodeInput').value.trim();
            if (!name || !code) return alert('Enter name and code');

            playerNames.player2 = name;
            const result = await multiplayerSession.joinSession(code, name);

            if (result.success) {
                playerNames.player1 = result.opponentName;
                document.querySelector('.join-game-screen').classList.remove('active');
                document.querySelector('.waiting-room-screen').classList.remove('active'); // Just in case
                
                // Show waiting screen initially
                showWaitingScreen(`${playerNames.player1} is starting the game...`);

                multiplayerSession.on('onGameStateChange', handleGameStateChange);
            } else {
                document.getElementById('joinErrorMessage').textContent = result.error;
                document.getElementById('joinErrorMessage').style.display = 'block';
            }
        };

        // --- GAME STATE HANDLING ---

        function handleGameStateChange(state) {
            console.log("State update:", state);

            // Sync Scores
            if (state.p1Score !== undefined) player1Score = state.p1Score;
            if (state.p2Score !== undefined) player2Score = state.p2Score;

            const myPlayerNum = multiplayerSession.playerNumber;

            // 1. Player 1 Drawing Phase
            if (state.status === 'p1_drawing') {
                if (myPlayerNum === 1) {
                    // I am P1, I need to draw
                    if (!document.querySelector('.draw-screen').classList.contains('active')) {
                        startDrawingPhase();
                    }
                } else {
                    // I am P2, I wait
                    showWaitingScreen(`${playerNames.player1} is drawing...`);
                }
            }
            
            // 2. Player 2 Guessing Phase (P1 finished drawing)
            else if (state.status === 'p2_guessing') {
                if (myPlayerNum === 2) {
                    // I am P2, I need to guess
                    if (!document.querySelector('.guess-screen').classList.contains('active')) {
                        opponentDrawings = state.drawingsBatch || [];
                        startGuessingPhase();
                    }
                } else {
                    // I am P1, I wait for guesses
                    showWaitingScreen(`${playerNames.player2} is guessing your drawings...`);
                }
            }

            // 3. Player 2 Drawing Phase
            else if (state.status === 'p2_drawing') {
                if (myPlayerNum === 2) {
                    if (!document.querySelector('.draw-screen').classList.contains('active')) {
                        startDrawingPhase();
                    }
                } else {
                    showWaitingScreen(`${playerNames.player2} is drawing...`);
                }
            }

            // 4. Player 1 Guessing Phase
            else if (state.status === 'p1_guessing') {
                if (myPlayerNum === 1) {
                    if (!document.querySelector('.guess-screen').classList.contains('active')) {
                        opponentDrawings = state.drawingsBatch || [];
                        startGuessingPhase();
                    }
                } else {
                    showWaitingScreen(`${playerNames.player1} is guessing your drawings...`);
                }
            }

            // 5. Game Over
            else if (state.status === 'finished') {
                displayFinalResults();
            }
        }

        // --- GAME LOGIC ---

        function showWaitingScreen(text) {
            hideAllScreens();
            document.querySelector('.waiting-for-opponent-screen').classList.add('active');
            document.getElementById('waitingText').textContent = text;
        }

        function hideAllScreens() {
            document.querySelectorAll('.game-container > div').forEach(div => {
                if (!div.classList.contains('game-title') && !div.classList.contains('back-link')) {
                    div.classList.remove('active');
                }
            });
        }

        function startDrawingPhase() {
            hideAllScreens();
            document.querySelector('.draw-screen').classList.add('active');
            
            // Reset vars
            currentRound = 0;
            myDrawings = [];
            
            // Init Canvas
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            setupCanvas();
            
            // Start round 1
            startRound();
        }

        function startRound() {
            clearCanvas();
            currentPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('prompt').textContent = currentPrompt;
            document.getElementById('drawIndicator').textContent = `Drawing ${currentRound + 1}/3`;
            
            timeLeft = 30;
            updateTimer();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    endRound();
                }
            }, 1000);
        }

        function endRound() {
            clearInterval(timer);
            
            // Save Drawing
            myDrawings.push({
                prompt: currentPrompt,
                image: canvas.toDataURL()
            });

            currentRound++;

            if (currentRound < 3) {
                // Next drawing
                setTimeout(startRound, 1000);
            } else {
                // Finished all 3 drawings
                const myPlayerNum = multiplayerSession.playerNumber;
                
                // Determine next status
                let nextStatus = '';
                if (myPlayerNum === 1) nextStatus = 'p2_guessing';
                else nextStatus = 'p1_guessing';

                // Send data to opponent
                multiplayerSession.updateGameState({
                    status: nextStatus,
                    drawingsBatch: myDrawings
                });
            }
        }

        function startGuessingPhase() {
            hideAllScreens();
            document.querySelector('.guess-screen').classList.add('active');
            
            const container = document.getElementById('guessContainer');
            container.innerHTML = '';
            
            opponentDrawings.forEach((drawing, index) => {
                const div = document.createElement('div');
                div.style.marginBottom = '30px';
                div.innerHTML = `
                    <h3>Drawing ${index + 1}</h3>
                    <img src="${drawing.image}" class="drawing-display" />
                    <input type="text" class="guess-input" id="guess${index}" placeholder="What is this?" />
                `;
                container.appendChild(div);
            });
        }

        window.submitGuesses = async function() {
            // Calculate Score locally
            let roundPointsForGuesser = 0;
            let roundPointsForDrawer = 0;

            opponentDrawings.forEach((drawing, index) => {
                const guess = document.getElementById(`guess${index}`).value.toLowerCase().trim();
                if (guess === drawing.prompt.toLowerCase()) {
                    roundPointsForGuesser += 10;
                    roundPointsForDrawer += 5;
                }
            });

            // Update scores
            const myPlayerNum = multiplayerSession.playerNumber;
            let newP1Score = player1Score;
            let newP2Score = player2Score;
            
            let nextStatus = '';

            if (myPlayerNum === 2) {
                // P2 just guessed P1's drawings
                newP2Score += roundPointsForGuesser;
                newP1Score += roundPointsForDrawer;
                nextStatus = 'p2_drawing'; // Now P2 draws
            } else {
                // P1 just guessed P2's drawings
                newP1Score += roundPointsForGuesser;
                newP2Score += roundPointsForDrawer;
                nextStatus = 'finished'; // Game Over
            }

            await multiplayerSession.updateGameState({
                status: nextStatus,
                p1Score: newP1Score,
                p2Score: newP2Score
            });
        };

        function displayFinalResults() {
            hideAllScreens();
            document.querySelector('.end-screen').classList.add('active');

            let winnerText = '';
            if (player1Score > player2Score) winnerText = `üèÜ ${playerNames.player1} Wins!`;
            else if (player2Score > player1Score) winnerText = `üèÜ ${playerNames.player2} Wins!`;
            else winnerText = 'ü§ù It\'s a Tie!';

            document.getElementById('finalScore').textContent = winnerText;
            document.getElementById('finalResults').innerHTML = `
                <div class="result-item"><strong>${playerNames.player1}:</strong> ${player1Score} pts</div>
                <div class="result-item"><strong>${playerNames.player2}:</strong> ${player2Score} pts</div>
            `;
            
            // Cleanup
            multiplayerSession.endSession();
        }

        // --- CANVAS HELPERS ---
        function updateTimer() { document.getElementById('timer').textContent = timeLeft; }
        
        window.setColor = function(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.clearCanvas = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        function setupCanvas() {
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDraw);
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            if (e.type === 'touchstart') {
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else if (e.type === 'touchmove' && isDrawing) {
                ctx.lineTo(x, y);
                ctx.strokeStyle = currentColor;
                ctx.stroke();
            }
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.strokeStyle = currentColor;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
        }

    </script>
</body>
</html>
